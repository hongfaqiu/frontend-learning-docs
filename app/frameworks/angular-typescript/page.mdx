import { Callout } from 'nextra/components'

# 09. Angular框架和TypeScript

## 📋 目录

- [Angular架构深入](#angular架构深入)
- [TypeScript在Angular中的应用](#typescript在angular中的应用)
- [依赖注入系统](#依赖注入系统)
- [RxJS响应式编程](#rxjs响应式编程)
- [Angular企业级开发](#angular企业级开发)
- [性能优化和最佳实践](#性能优化和最佳实践)

## Angular架构深入

<Callout type="info">
[Angular](https://angular.io/)是一个完整的企业级前端框架，提供了从开发到部署的完整解决方案，特别适合大型复杂应用的开发。
</Callout>

### Angular核心概念

```typescript
// 1. 组件（Component）
import { Component, Input, Output, EventEmitter, OnInit, OnDestroy } from '@angular/core';
import { Subject, takeUntil } from 'rxjs';

@Component({
  selector: 'app-user-card',
  template: `
    <div class="user-card" [class.active]="isActive">
      <img [src]="user.avatar" [alt]="user.name">
      <h3>{{ user.name }}</h3>
      <p>{{ user.email }}</p>
      <button (click)="onEdit()" [disabled]="!canEdit">
        编辑
      </button>
      <button (click)="onDelete()" class="danger">
        删除
      </button>
    </div>
  `,
  styleUrls: ['./user-card.component.scss']
})
export class UserCardComponent implements OnInit, OnDestroy {
  @Input() user!: User;
  @Input() canEdit: boolean = true;
  @Input() isActive: boolean = false;
  
  @Output() edit = new EventEmitter<User>();
  @Output() delete = new EventEmitter<string>();
  
  private destroy$ = new Subject<void>();
  
  ngOnInit(): void {
    console.log('UserCard component initialized');
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
  
  onEdit(): void {
    this.edit.emit(this.user);
  }
  
  onDelete(): void {
    this.delete.emit(this.user.id);
  }
}

// 2. 服务（Service）
import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError, BehaviorSubject } from 'rxjs';
import { catchError, map, tap } from 'rxjs/operators';

export interface User {
  id: string;
  name: string;
  email: string;
  avatar: string;
  role: 'admin' | 'user';
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private readonly apiUrl = '/api/users';
  private usersSubject = new BehaviorSubject<User[]>([]);
  
  public users$ = this.usersSubject.asObservable();
  
  constructor(private http: HttpClient) {}
  
  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl).pipe(
      tap(users => this.usersSubject.next(users)),
      catchError(this.handleError)
    );
  }
  
  getUserById(id: string): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`).pipe(
      catchError(this.handleError)
    );
  }
  
  createUser(user: Omit<User, 'id'>): Observable<User> {
    return this.http.post<User>(this.apiUrl, user).pipe(
      tap(newUser => {
        const currentUsers = this.usersSubject.value;
        this.usersSubject.next([...currentUsers, newUser]);
      }),
      catchError(this.handleError)
    );
  }
  
  updateUser(id: string, user: Partial<User>): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user).pipe(
      tap(updatedUser => {
        const currentUsers = this.usersSubject.value;
        const index = currentUsers.findIndex(u => u.id === id);
        if (index !== -1) {
          currentUsers[index] = updatedUser;
          this.usersSubject.next([...currentUsers]);
        }
      }),
      catchError(this.handleError)
    );
  }
  
  deleteUser(id: string): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`).pipe(
      tap(() => {
        const currentUsers = this.usersSubject.value;
        const filteredUsers = currentUsers.filter(u => u.id !== id);
        this.usersSubject.next(filteredUsers);
      }),
      catchError(this.handleError)
    );
  }
  
  private handleError(error: HttpErrorResponse): Observable<never> {
    let errorMessage = '发生未知错误';
    
    if (error.error instanceof ErrorEvent) {
      // 客户端错误
      errorMessage = `客户端错误: ${error.error.message}`;
    } else {
      // 服务端错误
      errorMessage = `服务端错误: ${error.status} - ${error.message}`;
    }
    
    console.error(errorMessage);
    return throwError(() => new Error(errorMessage));
  }
}

// 3. 指令（Directive）
import { Directive, ElementRef, HostListener, Input } from '@angular/core';

@Directive({
  selector: '[appHighlight]'
})
export class HighlightDirective {
  @Input() appHighlight = '';
  @Input() defaultColor = 'yellow';
  
  constructor(private el: ElementRef) {}
  
  @HostListener('mouseenter') onMouseEnter() {
    this.highlight(this.appHighlight || this.defaultColor);
  }
  
  @HostListener('mouseleave') onMouseLeave() {
    this.highlight('');
  }
  
  private highlight(color: string) {
    this.el.nativeElement.style.backgroundColor = color;
  }
}

// 4. 管道（Pipe）
import { Pipe, PipeTransform } from '@angular/core';

@Pipe({
  name: 'truncate',
  pure: true
})
export class TruncatePipe implements PipeTransform {
  transform(value: string, limit: number = 50, trail: string = '...'): string {
    if (!value) return '';
    
    return value.length > limit 
      ? value.substring(0, limit) + trail 
      : value;
  }
}

// 使用示例
// <p>{{ longText | truncate:100:'...' }}</p>
```

### 模块系统

```typescript
// 1. 特性模块
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule } from '@angular/forms';
import { RouterModule } from '@angular/router';

import { UserListComponent } from './components/user-list/user-list.component';
import { UserCardComponent } from './components/user-card/user-card.component';
import { UserFormComponent } from './components/user-form/user-form.component';
import { UserService } from './services/user.service';
import { TruncatePipe } from './pipes/truncate.pipe';
import { HighlightDirective } from './directives/highlight.directive';

@NgModule({
  declarations: [
    UserListComponent,
    UserCardComponent,
    UserFormComponent,
    TruncatePipe,
    HighlightDirective
  ],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterModule.forChild([
      { path: '', component: UserListComponent },
      { path: 'create', component: UserFormComponent },
      { path: ':id/edit', component: UserFormComponent }
    ])
  ],
  providers: [
    UserService
  ],
  exports: [
    UserCardComponent,
    TruncatePipe
  ]
})
export class UserModule {}

// 2. 共享模块
@NgModule({
  declarations: [
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ],
  imports: [
    CommonModule,
    MaterialModule
  ],
  exports: [
    CommonModule,
    MaterialModule,
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ]
})
export class SharedModule {}

// 3. 核心模块
@NgModule({
  providers: [
    AuthService,
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true },
    { provide: HTTP_INTERCEPTORS, useClass: ErrorInterceptor, multi: true }
  ]
})
export class CoreModule {
  constructor(@Optional() @SkipSelf() parentModule: CoreModule) {
    if (parentModule) {
      throw new Error('CoreModule已经加载，只能在AppModule中导入一次');
    }
  }
}
```

## TypeScript在Angular中的应用

### 高级类型系统

<Callout type="warning">
TypeScript的强类型系统是Angular的核心优势之一，能够在编译时发现错误，提高代码质量。
</Callout>

```typescript
// 1. 接口和类型定义
export interface ApiResponse<T> {
  data: T;
  message: string;
  success: boolean;
  timestamp: number;
}

export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

export type UserRole = 'admin' | 'moderator' | 'user';
export type UserStatus = 'active' | 'inactive' | 'pending';

export interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
  status: UserStatus;
  createdAt: Date;
  updatedAt: Date;
  profile?: UserProfile;
}

export interface UserProfile {
  avatar?: string;
  bio?: string;
  location?: string;
  website?: string;
}

// 2. 泛型服务
@Injectable({
  providedIn: 'root'
})
export class ApiService {
  constructor(private http: HttpClient) {}
  
  get<T>(url: string): Observable<ApiResponse<T>> {
    return this.http.get<ApiResponse<T>>(url);
  }
  
  post<T, U = any>(url: string, data: U): Observable<ApiResponse<T>> {
    return this.http.post<ApiResponse<T>>(url, data);
  }
  
  put<T, U = any>(url: string, data: U): Observable<ApiResponse<T>> {
    return this.http.put<ApiResponse<T>>(url, data);
  }
  
  delete<T = any>(url: string): Observable<ApiResponse<T>> {
    return this.http.delete<ApiResponse<T>>(url);
  }
  
  getPaginated<T>(
    url: string, 
    params: { page: number; limit: number }
  ): Observable<PaginatedResponse<T>> {
    const httpParams = new HttpParams()
      .set('page', params.page.toString())
      .set('limit', params.limit.toString());
      
    return this.http.get<PaginatedResponse<T>>(url, { params: httpParams });
  }
}

// 3. 装饰器和元数据
function LogMethod(target: any, propertyName: string, descriptor: PropertyDescriptor) {
  const method = descriptor.value;
  
  descriptor.value = function (...args: any[]) {
    console.log(`调用方法 ${propertyName}，参数:`, args);
    const result = method.apply(this, args);
    console.log(`方法 ${propertyName} 返回:`, result);
    return result;
  };
}

function Cacheable(ttl: number = 5000) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const cache = new Map<string, { value: any; timestamp: number }>();
    const method = descriptor.value;
    
    descriptor.value = function (...args: any[]) {
      const key = JSON.stringify(args);
      const cached = cache.get(key);
      
      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.value;
      }
      
      const result = method.apply(this, args);
      cache.set(key, { value: result, timestamp: Date.now() });
      
      return result;
    };
  };
}

// 使用装饰器
@Injectable({
  providedIn: 'root'
})
export class DataService {
  @LogMethod
  @Cacheable(10000)
  fetchData(id: string): Observable<any> {
    return this.http.get(`/api/data/${id}`);
  }
}

// 4. 条件类型和映射类型
type NonNullable<T> = T extends null | undefined ? never : T;
type Partial<T> = { [P in keyof T]?: T[P] };
type Required<T> = { [P in keyof T]-?: T[P] };
type Pick<T, K extends keyof T> = { [P in K]: T[P] };
type Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;

// 实用类型示例
export type CreateUserDto = Omit<User, 'id' | 'createdAt' | 'updatedAt'>;
export type UpdateUserDto = Partial<Pick<User, 'name' | 'email' | 'role' | 'status'>>;
export type UserSummary = Pick<User, 'id' | 'name' | 'email' | 'role'>;

// 5. 类型守卫
export function isUser(obj: any): obj is User {
  return obj && 
         typeof obj.id === 'string' &&
         typeof obj.name === 'string' &&
         typeof obj.email === 'string' &&
         ['admin', 'moderator', 'user'].includes(obj.role);
}

export function isApiResponse<T>(obj: any): obj is ApiResponse<T> {
  return obj &&
         typeof obj.success === 'boolean' &&
         typeof obj.message === 'string' &&
         typeof obj.timestamp === 'number' &&
         obj.data !== undefined;
}

// 使用类型守卫
@Component({
  selector: 'app-user-detail',
  template: `
    <div *ngIf="user">
      <h2>{{ user.name }}</h2>
      <p>{{ user.email }}</p>
    </div>
  `
})
export class UserDetailComponent {
  user: User | null = null;
  
  loadUser(data: unknown): void {
    if (isUser(data)) {
      this.user = data;
    } else {
      console.error('Invalid user data:', data);
    }
  }
}
```

## 依赖注入系统

### 高级依赖注入

```typescript
// 1. 注入令牌
import { InjectionToken } from '@angular/core';

export const API_CONFIG = new InjectionToken<ApiConfig>('api.config');
export const FEATURE_FLAGS = new InjectionToken<FeatureFlags>('feature.flags');

export interface ApiConfig {
  baseUrl: string;
  timeout: number;
  retryAttempts: number;
}

export interface FeatureFlags {
  enableNewUI: boolean;
  enableAnalytics: boolean;
  enableBetaFeatures: boolean;
}

// 2. 工厂提供者
export function createApiService(
  http: HttpClient,
  config: ApiConfig
): ApiService {
  return new ApiService(http, config);
}

export function createLogger(isDevelopment: boolean): Logger {
  return isDevelopment ? new ConsoleLogger() : new RemoteLogger();
}

// 3. 模块配置
@NgModule({
  providers: [
    {
      provide: API_CONFIG,
      useValue: {
        baseUrl: 'https://api.example.com',
        timeout: 5000,
        retryAttempts: 3
      }
    },
    {
      provide: FEATURE_FLAGS,
      useFactory: () => ({
        enableNewUI: environment.production,
        enableAnalytics: true,
        enableBetaFeatures: !environment.production
      })
    },
    {
      provide: ApiService,
      useFactory: createApiService,
      deps: [HttpClient, API_CONFIG]
    },
    {
      provide: Logger,
      useFactory: createLogger,
      deps: [ENVIRONMENT]
    }
  ]
})
export class AppModule {}

// 4. 多提供者
export const VALIDATORS = new InjectionToken<Validator[]>('validators');

@Injectable()
export class EmailValidator implements Validator {
  validate(value: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }
}

@Injectable()
export class PhoneValidator implements Validator {
  validate(value: string): boolean {
    return /^\d{10,11}$/.test(value);
  }
}

@NgModule({
  providers: [
    { provide: VALIDATORS, useClass: EmailValidator, multi: true },
    { provide: VALIDATORS, useClass: PhoneValidator, multi: true }
  ]
})
export class ValidationModule {}

// 5. 层级注入器
@Component({
  selector: 'app-user-list',
  providers: [
    // 组件级提供者
    { provide: UserService, useClass: CachedUserService }
  ],
  template: `
    <app-user-card 
      *ngFor="let user of users" 
      [user]="user">
    </app-user-card>
  `
})
export class UserListComponent {
  constructor(
    private userService: UserService, // 使用CachedUserService
    @Inject(FEATURE_FLAGS) private featureFlags: FeatureFlags,
    @Optional() private analytics: AnalyticsService,
    @Self() private localService: LocalService
  ) {}
}
```

## RxJS响应式编程

### Observable模式深入

<Callout type="info">
RxJS是Angular的核心依赖，掌握响应式编程对于构建高质量的Angular应用至关重要。
</Callout>

```typescript
// 1. 复杂的数据流处理
@Injectable({
  providedIn: 'root'
})
export class SearchService {
  private searchTerms = new Subject<string>();
  
  // 搜索结果流
  public searchResults$ = this.searchTerms.pipe(
    debounceTime(300),           // 防抖
    distinctUntilChanged(),      // 去重
    filter(term => term.length >= 2), // 过滤短查询
    switchMap(term => 
      this.apiService.search(term).pipe(
        catchError(error => {
          console.error('搜索错误:', error);
          return of([]); // 返回空数组作为默认值
        })
      )
    ),
    shareReplay(1)               // 缓存最新结果
  );
  
  search(term: string): void {
    this.searchTerms.next(term);
  }
}

// 2. 状态管理
@Injectable({
  providedIn: 'root'
})
export class UserStateService {
  private usersSubject = new BehaviorSubject<User[]>([]);
  private loadingSubject = new BehaviorSubject<boolean>(false);
  private errorSubject = new BehaviorSubject<string | null>(null);
  
  public users$ = this.usersSubject.asObservable();
  public loading$ = this.loadingSubject.asObservable();
  public error$ = this.errorSubject.asObservable();
  
  // 组合状态
  public state$ = combineLatest([
    this.users$,
    this.loading$,
    this.error$
  ]).pipe(
    map(([users, loading, error]) => ({
      users,
      loading,
      error,
      hasUsers: users.length > 0,
      isEmpty: users.length === 0 && !loading && !error
    }))
  );
  
  loadUsers(): void {
    this.loadingSubject.next(true);
    this.errorSubject.next(null);
    
    this.userService.getUsers().pipe(
      finalize(() => this.loadingSubject.next(false))
    ).subscribe({
      next: users => this.usersSubject.next(users),
      error: error => this.errorSubject.next(error.message)
    });
  }
  
  addUser(user: CreateUserDto): Observable<User> {
    return this.userService.createUser(user).pipe(
      tap(newUser => {
        const currentUsers = this.usersSubject.value;
        this.usersSubject.next([...currentUsers, newUser]);
      })
    );
  }
  
  updateUser(id: string, updates: UpdateUserDto): Observable<User> {
    return this.userService.updateUser(id, updates).pipe(
      tap(updatedUser => {
        const currentUsers = this.usersSubject.value;
        const index = currentUsers.findIndex(u => u.id === id);
        if (index !== -1) {
          currentUsers[index] = updatedUser;
          this.usersSubject.next([...currentUsers]);
        }
      })
    );
  }
  
  deleteUser(id: string): Observable<void> {
    return this.userService.deleteUser(id).pipe(
      tap(() => {
        const currentUsers = this.usersSubject.value;
        const filteredUsers = currentUsers.filter(u => u.id !== id);
        this.usersSubject.next(filteredUsers);
      })
    );
  }
}

// 3. 自定义操作符
export function retryWithBackoff(maxRetries: number = 3, baseDelay: number = 1000) {
  return <T>(source: Observable<T>) => source.pipe(
    retryWhen(errors => 
      errors.pipe(
        scan((retryCount, error) => {
          if (retryCount >= maxRetries) {
            throw error;
          }
          return retryCount + 1;
        }, 0),
        delay(baseDelay),
        tap(retryCount => console.log(`重试第 ${retryCount} 次`))
      )
    )
  );
}

export function cacheWithExpiry<T>(ttl: number = 5000) {
  return (source: Observable<T>) => {
    let cache: { value: T; timestamp: number } | null = null;
    
    return new Observable<T>(observer => {
      if (cache && Date.now() - cache.timestamp < ttl) {
        observer.next(cache.value);
        observer.complete();
        return;
      }
      
      return source.subscribe({
        next: value => {
          cache = { value, timestamp: Date.now() };
          observer.next(value);
        },
        error: error => observer.error(error),
        complete: () => observer.complete()
      });
    });
  };
}

// 使用自定义操作符
@Injectable({
  providedIn: 'root'
})
export class DataService {
  getData(): Observable<any> {
    return this.http.get('/api/data').pipe(
      retryWithBackoff(3, 1000),
      cacheWithExpiry(10000),
      catchError(error => {
        console.error('获取数据失败:', error);
        return throwError(() => error);
      })
    );
  }
}

// 4. 响应式表单
@Component({
  selector: 'app-user-form',
  template: `
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="name">姓名</label>
        <input 
          id="name" 
          type="text" 
          formControlName="name"
          [class.invalid]="nameControl.invalid && nameControl.touched">
        <div *ngIf="nameControl.invalid && nameControl.touched" class="error">
          <span *ngIf="nameControl.errors?.['required']">姓名是必填项</span>
          <span *ngIf="nameControl.errors?.['minlength']">姓名至少2个字符</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="email">邮箱</label>
        <input 
          id="email" 
          type="email" 
          formControlName="email"
          [class.invalid]="emailControl.invalid && emailControl.touched">
        <div *ngIf="emailControl.invalid && emailControl.touched" class="error">
          <span *ngIf="emailControl.errors?.['required']">邮箱是必填项</span>
          <span *ngIf="emailControl.errors?.['email']">邮箱格式不正确</span>
          <span *ngIf="emailControl.errors?.['emailTaken']">邮箱已被使用</span>
        </div>
      </div>
      
      <button type="submit" [disabled]="userForm.invalid || submitting">
        {{ submitting ? '提交中...' : '提交' }}
      </button>
    </form>
  `
})
export class UserFormComponent implements OnInit, OnDestroy {
  userForm!: FormGroup;
  submitting = false;
  private destroy$ = new Subject<void>();
  
  constructor(
    private fb: FormBuilder,
    private userService: UserService
  ) {}
  
  ngOnInit(): void {
    this.createForm();
    this.setupFormValidation();
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
  
  get nameControl() { return this.userForm.get('name')!; }
  get emailControl() { return this.userForm.get('email')!; }
  
  private createForm(): void {
    this.userForm = this.fb.group({
      name: ['', [Validators.required, Validators.minLength(2)]],
      email: ['', [Validators.required, Validators.email], [this.emailValidator.bind(this)]]
    });
  }
  
  private setupFormValidation(): void {
    // 实时验证
    this.userForm.valueChanges.pipe(
      debounceTime(300),
      takeUntil(this.destroy$)
    ).subscribe(value => {
      console.log('表单值变化:', value);
    });
    
    // 邮箱字段变化时的特殊处理
    this.emailControl.valueChanges.pipe(
      debounceTime(500),
      distinctUntilChanged(),
      takeUntil(this.destroy$)
    ).subscribe(email => {
      if (email && this.emailControl.valid) {
        console.log('邮箱验证通过:', email);
      }
    });
  }
  
  private emailValidator(control: AbstractControl): Observable<ValidationErrors | null> {
    if (!control.value) {
      return of(null);
    }
    
    return this.userService.checkEmailExists(control.value).pipe(
      map(exists => exists ? { emailTaken: true } : null),
      catchError(() => of(null))
    );
  }
  
  onSubmit(): void {
    if (this.userForm.valid) {
      this.submitting = true;
      
      this.userService.createUser(this.userForm.value).pipe(
        finalize(() => this.submitting = false),
        takeUntil(this.destroy$)
      ).subscribe({
        next: user => {
          console.log('用户创建成功:', user);
          this.userForm.reset();
        },
        error: error => {
          console.error('用户创建失败:', error);
        }
      });
    }
  }
}
```

---

<Callout type="success">
Angular提供了完整的企业级开发解决方案，通过TypeScript、依赖注入和RxJS的强大组合，能够构建大型、可维护的前端应用。
</Callout>
