import { Callout } from 'nextra/components'

# 08. Vue3æ·±å…¥å’Œç»„åˆå¼API

## ğŸ“‹ ç›®å½•

- [Vue3æ¶æ„é©æ–°](#vue3æ¶æ„é©æ–°)
- [å“åº”å¼ç³»ç»ŸåŸç†](#å“åº”å¼ç³»ç»ŸåŸç†)
- [Composition APIæ·±å…¥](#composition-apiæ·±å…¥)
- [ç»„ä»¶é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†](#ç»„ä»¶é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†)
- [Vue3æ€§èƒ½ä¼˜åŒ–](#vue3æ€§èƒ½ä¼˜åŒ–)
- [Vue3ç”Ÿæ€ç³»ç»Ÿ](#vue3ç”Ÿæ€ç³»ç»Ÿ)

## Vue3æ¶æ„é©æ–°

<Callout type="info">
[Vue3](https://vuejs.org/)å¸¦æ¥äº†å…¨æ–°çš„æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬[Composition API](https://vuejs.org/guide/extras/composition-api-faq.html)ã€æ›´å¥½çš„[TypeScript](https://www.typescriptlang.org/)æ”¯æŒã€Tree-shakingå‹å¥½çš„è®¾è®¡ç­‰é‡å¤§æ”¹è¿›ã€‚
</Callout>

### Vue3 vs Vue2 æ ¸å¿ƒå·®å¼‚

#### APIé£æ ¼å¯¹æ¯”

| ç‰¹æ€§ | Vue2 Options API | Vue3 Composition API | ä¼˜åŠ¿ |
|------|------------------|---------------------|------|
| **ä»£ç ç»„ç»‡** | æŒ‰é€‰é¡¹ç±»å‹åˆ†ç»„ | æŒ‰é€»è¾‘åŠŸèƒ½åˆ†ç»„ | æ›´å¥½çš„ä»£ç å¤ç”¨å’Œç»´æŠ¤ |
| **TypeScriptæ”¯æŒ** | æœ‰é™ | åŸç”Ÿæ”¯æŒ | æ›´å¥½çš„ç±»å‹æ¨æ–­ |
| **Tree-shaking** | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ | æ›´å°çš„æ‰“åŒ…ä½“ç§¯ |
| **é€»è¾‘å¤ç”¨** | Mixins | Composables | é¿å…å‘½åå†²çª |

#### ä»£ç é£æ ¼å¯¹æ¯”

```javascript
// Vue2 Options API
export default {
  data() {
    return { count: 0, user: null }
  },
  computed: {
    doubleCount() { return this.count * 2 }
  },
  methods: {
    increment() { this.count++ },
    async fetchUser() { this.user = await api.getUser() }
  },
  mounted() { this.fetchUser() }
}

// Vue3 Composition API
import { ref, computed, onMounted } from 'vue'

export default {
  setup() {
    const count = ref(0)
    const user = ref(null)

    const doubleCount = computed(() => count.value * 2)
    const increment = () => count.value++
    const fetchUser = async () => user.value = await api.getUser()

    onMounted(fetchUser)

    return { count, user, doubleCount, increment, fetchUser }
  }
}

// Vue3 <script setup> è¯­æ³•ç³–ï¼ˆæ¨èï¼‰
import { ref, computed, onMounted } from 'vue'

const count = ref(0)
const user = ref(null)
const doubleCount = computed(() => count.value * 2)
const increment = () => count.value++
const fetchUser = async () => user.value = await api.getUser()

onMounted(fetchUser)
```

### Vue3æ–°ç‰¹æ€§æ¦‚è§ˆ

#### æ ¸å¿ƒæ–°ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Fragment** | æ”¯æŒå¤šä¸ªæ ¹èŠ‚ç‚¹ | æ›´çµæ´»çš„æ¨¡æ¿ç»“æ„ | å¸ƒå±€ç»„ä»¶ |
| **Teleport** | å°†å†…å®¹ä¼ é€åˆ°DOMå…¶ä»–ä½ç½® | è§£å†³æ ·å¼å±‚çº§é—®é¢˜ | æ¨¡æ€æ¡†ã€æç¤ºæ¡† |
| **Suspense** | å¼‚æ­¥ç»„ä»¶åŠ è½½çŠ¶æ€ç®¡ç† | æ›´å¥½çš„åŠ è½½ä½“éªŒ | ä»£ç åˆ†å‰²ã€å¼‚æ­¥æ•°æ® |
| **`<script setup>`** | æ›´ç®€æ´çš„ç»„åˆå¼APIè¯­æ³• | å‡å°‘æ ·æ¿ä»£ç  | æ‰€æœ‰ç»„ä»¶ |

#### æ–°ç‰¹æ€§ç¤ºä¾‹

```vue
<!-- Fragmentï¼šå¤šä¸ªæ ¹èŠ‚ç‚¹ -->
<template>
  <header>å¤´éƒ¨</header>
  <main>å†…å®¹</main>
  <footer>åº•éƒ¨</footer>
</template>

<!-- Teleportï¼šä¼ é€é—¨ -->
<template>
  <div>
    <button @click="showModal = true">æ‰“å¼€æ¨¡æ€æ¡†</button>
    <Teleport to="body">
      <div v-if="showModal" class="modal">
        <p>æ¨¡æ€æ¡†å†…å®¹</p>
        <button @click="showModal = false">å…³é—­</button>
      </div>
    </Teleport>
  </div>
</template>

<!-- Suspenseï¼šå¼‚æ­¥ç»„ä»¶ -->
<template>
  <Suspense>
    <template #default>
      <AsyncUserProfile :user-id="userId" />
    </template>
    <template #fallback>
      <div class="loading">åŠ è½½ç”¨æˆ·ä¿¡æ¯ä¸­...</div>
    </template>
  </Suspense>
</template>

<!-- <script setup>ï¼šè¯­æ³•ç³– -->
<script setup>
import { ref, computed, watch, onMounted } from 'vue'

// å“åº”å¼æ•°æ®
const count = ref(0)
const showModal = ref(false)

// è®¡ç®—å±æ€§
const doubleCount = computed(() => count.value * 2)

// ä¾¦å¬å™¨
watch(count, (newVal) => {
  console.log(`count: ${newVal}`)
})

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  console.log('ç»„ä»¶å·²æŒ‚è½½')
})

// æ–¹æ³•ï¼ˆè‡ªåŠ¨æš´éœ²ç»™æ¨¡æ¿ï¼‰
const increment = () => count.value++
</script>
```

## å“åº”å¼ç³»ç»ŸåŸç†

### Proxy vs Object.defineProperty

<Callout type="warning">
Vue3ä½¿ç”¨Proxyæ›¿ä»£äº†Vue2çš„Object.definePropertyï¼Œè§£å†³äº†æ•°ç»„å’Œå¯¹è±¡å±æ€§åŠ¨æ€æ·»åŠ çš„å“åº”å¼é—®é¢˜ã€‚
</Callout>

#### æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | Vue2 Object.defineProperty | Vue3 Proxy | ä¼˜åŠ¿ |
|------|---------------------------|-------------|------|
| **æ•°ç»„ç›‘å¬** | éœ€è¦ç‰¹æ®Šå¤„ç† | åŸç”Ÿæ”¯æŒ | æ›´å®Œæ•´çš„æ•°ç»„å“åº”å¼ |
| **å±æ€§æ·»åŠ ** | éœ€è¦Vue.set | è‡ªåŠ¨ç›‘å¬ | åŠ¨æ€å±æ€§å“åº”å¼ |
| **å±æ€§åˆ é™¤** | éœ€è¦Vue.delete | è‡ªåŠ¨ç›‘å¬ | å®Œæ•´çš„åˆ é™¤ç›‘å¬ |
| **æ€§èƒ½** | åˆå§‹åŒ–æ—¶éå†æ‰€æœ‰å±æ€§ | æ‡’ä»£ç† | æ›´å¥½çš„åˆå§‹åŒ–æ€§èƒ½ |
| **æµè§ˆå™¨æ”¯æŒ** | IE8+ | IE11+ | ç°ä»£æµè§ˆå™¨ç‰¹æ€§ |

#### æ ¸å¿ƒå®ç°åŸç†

```javascript
// Vue2 å“åº”å¼ï¼ˆç®€åŒ–ï¼‰
function defineReactive(obj, key, val) {
  Object.defineProperty(obj, key, {
    get() {
      if (Dep.target) dep.depend() // ä¾èµ–æ”¶é›†
      return val
    },
    set(newVal) {
      if (newVal === val) return
      val = newVal
      dep.notify() // é€šçŸ¥æ›´æ–°
    }
  })
}

// Vue3 å“åº”å¼ï¼ˆç®€åŒ–ï¼‰
function reactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      const result = Reflect.get(target, key, receiver)
      track(target, key) // ä¾èµ–æ”¶é›†

      // æ·±åº¦å“åº”å¼
      if (typeof result === 'object' && result !== null) {
        return reactive(result)
      }
      return result
    },

    set(target, key, value, receiver) {
      const oldValue = target[key]
      const result = Reflect.set(target, key, value, receiver)

      if (oldValue !== value) {
        trigger(target, key) // è§¦å‘æ›´æ–°
      }
      return result
    }
  })
}
```

#### å“åº”å¼ç³»ç»Ÿä¼˜åŠ¿

- **æ›´å®Œæ•´çš„æ‹¦æˆª**ï¼šProxyå¯ä»¥æ‹¦æˆª13ç§æ“ä½œ
- **æ›´å¥½çš„æ€§èƒ½**ï¼šæ‡’ä»£ç†ï¼ŒæŒ‰éœ€åˆ›å»ºå“åº”å¼å¯¹è±¡
- **æ›´ç®€æ´çš„API**ï¼šä¸éœ€è¦ç‰¹æ®Šçš„set/deleteæ–¹æ³•
- **æ›´å¥½çš„æ•°ç»„æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒæ•°ç»„ç´¢å¼•å’Œlengthå˜åŒ–

### å“åº”å¼APIè¯¦è§£

#### å“åº”å¼APIå¯¹æ¯”

| API | ç”¨é€” | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|-----|------|----------|------|
| **ref** | åŸºæœ¬ç±»å‹å“åº”å¼ | æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ | éœ€è¦.valueè®¿é—® |
| **reactive** | å¯¹è±¡å“åº”å¼ | å¯¹è±¡ã€æ•°ç»„ | æ·±åº¦å“åº”å¼ï¼Œç›´æ¥è®¿é—®å±æ€§ |
| **computed** | è®¡ç®—å±æ€§ | åŸºäºå…¶ä»–å“åº”å¼æ•°æ®çš„æ´¾ç”Ÿå€¼ | ç¼“å­˜ç»“æœï¼Œä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®— |
| **watch** | ä¾¦å¬å™¨ | ç›‘å¬ç‰¹å®šæ•°æ®å˜åŒ– | å¯è®¿é—®æ–°æ—§å€¼ |
| **watchEffect** | å‰¯ä½œç”¨ä¾¦å¬å™¨ | è‡ªåŠ¨è¿½è¸ªä¾èµ–çš„å‰¯ä½œç”¨ | ç«‹å³æ‰§è¡Œï¼Œè‡ªåŠ¨æ”¶é›†ä¾èµ– |

#### åŸºç¡€ç”¨æ³•ç¤ºä¾‹

```javascript
// 1. ref - åŸºæœ¬ç±»å‹å“åº”å¼
import { ref, isRef, unref } from 'vue'

const count = ref(0)
const message = ref('hello')

console.log(count.value) // 0
count.value++ // è§¦å‘å“åº”å¼æ›´æ–°

// å·¥å…·å‡½æ•°
console.log(isRef(count)) // true
console.log(unref(count)) // 1ï¼Œç­‰åŒäº count.value

// 2. reactive - å¯¹è±¡å“åº”å¼
import { reactive, isReactive, toRaw } from 'vue'

const state = reactive({
  count: 0,
  nested: { message: 'hello' }
})

// æ·±åº¦å“åº”å¼
state.nested.message = 'world' // è§¦å‘æ›´æ–°
console.log(isReactive(state.nested)) // true

// 3. computed - è®¡ç®—å±æ€§
import { computed } from 'vue'

const count = ref(1)
const plusOne = computed(() => count.value + 1)

// å¯å†™è®¡ç®—å±æ€§
const writableComputed = computed({
  get: () => count.value + 1,
  set: (val) => count.value = val - 1
})

// 4. watch å’Œ watchEffect
import { watch, watchEffect } from 'vue'

// ä¾¦å¬å•ä¸ªæº
watch(() => state.count, (newVal, oldVal) => {
  console.log(`count: ${oldVal} -> ${newVal}`)
})

// ä¾¦å¬å¤šä¸ªæº
watch([() => state.count, () => state.name], ([newCount, newName]) => {
  console.log('å¤šä¸ªå€¼å‘ç”Ÿå˜åŒ–')
})

// ç«‹å³æ‰§è¡Œçš„ä¾¦å¬å™¨
const stop = watchEffect(() => {
  console.log(`count is ${state.count}`)
})

// åœæ­¢ä¾¦å¬
stop()
```

#### æœ€ä½³å®è·µ

| åœºæ™¯ | æ¨èAPI | ç†ç”± |
|------|---------|------|
| **åŸºæœ¬ç±»å‹** | ref | ç®€å•ç›´æ¥ï¼Œç±»å‹å®‰å…¨ |
| **å¯¹è±¡/æ•°ç»„** | reactive | ä½¿ç”¨æ›´è‡ªç„¶ï¼Œæ— éœ€.value |
| **æ´¾ç”Ÿæ•°æ®** | computed | è‡ªåŠ¨ç¼“å­˜ï¼Œæ€§èƒ½æ›´å¥½ |
| **å‰¯ä½œç”¨** | watchEffect | è‡ªåŠ¨ä¾èµ–æ”¶é›† |
| **ç²¾ç¡®æ§åˆ¶** | watch | å¯è®¿é—®æ–°æ—§å€¼ï¼Œæ›´çµæ´» |

## Composition APIæ·±å…¥

### ç»„åˆå¼å‡½æ•°ï¼ˆComposablesï¼‰

<Callout type="info">
ç»„åˆå¼å‡½æ•°æ˜¯Vue3çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†ç›¸å…³çš„é€»è¾‘ç»„åˆåœ¨ä¸€èµ·ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
</Callout>

#### å¸¸ç”¨ç»„åˆå¼å‡½æ•°

| å‡½æ•°å | åŠŸèƒ½ | è¿”å›å€¼ | ä½¿ç”¨åœºæ™¯ |
|--------|------|--------|----------|
| **useCounter** | è®¡æ•°å™¨é€»è¾‘ | count, increment, decrement | æ•°é‡æ§åˆ¶ã€åˆ†é¡µ |
| **useFetch** | æ•°æ®è·å– | data, loading, error | APIè°ƒç”¨ |
| **useLocalStorage** | æœ¬åœ°å­˜å‚¨ | å“åº”å¼å­˜å‚¨å€¼ | ç”¨æˆ·åå¥½è®¾ç½® |
| **useEventListener** | äº‹ä»¶ç›‘å¬ | æ—  | DOMäº‹ä»¶å¤„ç† |
| **useIntersectionObserver** | äº¤å‰è§‚å¯Ÿ | isIntersecting, entries | æ‡’åŠ è½½ã€æ— é™æ»šåŠ¨ |

#### ç»„åˆå¼å‡½æ•°ç¤ºä¾‹

```javascript
// 1. useCounter - è®¡æ•°å™¨
import { ref, computed, readonly } from 'vue'

export function useCounter(initialValue = 0) {
  const count = ref(initialValue)

  const increment = () => count.value++
  const decrement = () => count.value--
  const reset = () => count.value = initialValue

  const isEven = computed(() => count.value % 2 === 0)

  return {
    count: readonly(count),
    increment,
    decrement,
    reset,
    isEven
  }
}

// 2. useFetch - æ•°æ®è·å–
import { ref, watchEffect, readonly } from 'vue'

export function useFetch(url) {
  const data = ref(null)
  const error = ref(null)
  const loading = ref(false)

  const fetchData = async () => {
    loading.value = true
    error.value = null

    try {
      const response = await fetch(url.value || url)
      data.value = await response.json()
    } catch (err) {
      error.value = err
    } finally {
      loading.value = false
    }
  }

  // å“åº”å¼URLè‡ªåŠ¨é‡æ–°è·å–
  if (isRef(url)) {
    watchEffect(fetchData)
  } else {
    fetchData()
  }

  return {
    data: readonly(data),
    error: readonly(error),
    loading: readonly(loading),
    refetch: fetchData
  }
}

// 3. useLocalStorage - æœ¬åœ°å­˜å‚¨
import { ref, watch } from 'vue'

export function useLocalStorage(key, defaultValue) {
  const storedValue = localStorage.getItem(key)
  const initialValue = storedValue ? JSON.parse(storedValue) : defaultValue
  const value = ref(initialValue)

  // åŒæ­¥åˆ°localStorage
  watch(value, (newValue) => {
    localStorage.setItem(key, JSON.stringify(newValue))
  }, { deep: true })

  return value
}
```

#### ç»„åˆå¼å‡½æ•°ä½¿ç”¨

```javascript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export default {
  setup() {
    // è®¡æ•°å™¨åŠŸèƒ½
    const { count, increment, isEven } = useCounter(10)

    // æ•°æ®è·å–
    const { data: users, loading, error } = useFetch('/api/users')

    // æœ¬åœ°å­˜å‚¨
    const theme = useLocalStorage('theme', 'light')

    return {
      count,
      increment,
      isEven,
      users,
      loading,
      error,
      theme
    }
  }
}
```

### é«˜çº§ç»„åˆæ¨¡å¼

#### é«˜çº§ç»„åˆå¼å‡½æ•°

| å‡½æ•°å | åŠŸèƒ½ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|--------|------|----------|--------|
| **useStateMachine** | çŠ¶æ€æœºç®¡ç† | å¤æ‚çŠ¶æ€æµè½¬ | é«˜ |
| **useFormValidation** | è¡¨å•éªŒè¯ | è¡¨å•å¤„ç† | ä¸­ |
| **useInfiniteScroll** | æ— é™æ»šåŠ¨ | åˆ—è¡¨åŠ è½½ | ä¸­ |
| **useDebounce** | é˜²æŠ–å¤„ç† | æœç´¢è¾“å…¥ | ä½ |

#### å®ç°ç¤ºä¾‹

```javascript
// 1. çŠ¶æ€æœºç»„åˆå¼å‡½æ•°
export function useStateMachine(initialState, transitions) {
  const state = ref(initialState)

  const transition = (action) => {
    const currentTransitions = transitions[state.value]
    if (currentTransitions?.[action]) {
      state.value = currentTransitions[action]
    }
  }

  const can = (action) => {
    const currentTransitions = transitions[state.value]
    return currentTransitions?.[action] !== undefined
  }

  return { state: readonly(state), transition, can }
}

// ä½¿ç”¨çŠ¶æ€æœº
const { state, transition, can } = useStateMachine('idle', {
  idle: { start: 'loading' },
  loading: { success: 'success', error: 'error' },
  success: { reset: 'idle' },
  error: { retry: 'loading', reset: 'idle' }
})

// 2. è¡¨å•éªŒè¯ç»„åˆå¼å‡½æ•°
export function useFormValidation(rules) {
  const errors = ref({})
  const isValid = computed(() => Object.keys(errors.value).length === 0)

  const validate = (field, value) => {
    const fieldRules = rules[field]
    if (!fieldRules) return true

    for (const rule of fieldRules) {
      if (!rule.validator(value)) {
        errors.value[field] = rule.message
        return false
      }
    }

    delete errors.value[field]
    return true
  }

  return {
    errors: readonly(errors),
    isValid,
    validate,
    validateAll: (values) => {
      return Object.entries(values).every(([field, value]) => validate(field, value))
    }
  }
}

// 3. é˜²æŠ–ç»„åˆå¼å‡½æ•°
export function useDebounce(fn, delay = 300) {
  let timeoutId = null

  const debouncedFn = (...args) => {
    clearTimeout(timeoutId)
    timeoutId = setTimeout(() => fn(...args), delay)
  }

  const cancel = () => clearTimeout(timeoutId)

  return { debouncedFn, cancel }
}
```

#### ç»„åˆå¼å‡½æ•°æœ€ä½³å®è·µ

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½åŸŸ
- **è¿”å›åªè¯»çŠ¶æ€**ï¼šä½¿ç”¨readonly()é˜²æ­¢å¤–éƒ¨ä¿®æ”¹
- **æä¾›æ¸…ç†æœºåˆ¶**ï¼šåœ¨onUnmountedä¸­æ¸…ç†å‰¯ä½œç”¨
- **æ”¯æŒå“åº”å¼å‚æ•°**ï¼šå‚æ•°å¯ä»¥æ˜¯refæˆ–reactive
- **é”™è¯¯å¤„ç†**ï¼šæä¾›å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ç»„ä»¶é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†

### ç»„ä»¶é€šä¿¡æ–¹å¼

#### é€šä¿¡æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æ•°æ®æµå‘ | å¤æ‚åº¦ |
|------|----------|----------|--------|
| **Props/Emits** | çˆ¶å­ç»„ä»¶ | åŒå‘ | ä½ |
| **Provide/Inject** | è·¨å±‚çº§ç»„ä»¶ | å•å‘ | ä¸­ |
| **æ¨¡æ¿å¼•ç”¨** | ç›´æ¥è®¿é—®å­ç»„ä»¶ | åŒå‘ | ä½ |
| **Pinia** | å…¨å±€çŠ¶æ€ | åŒå‘ | ä¸­ |
| **Event Bus** | ä»»æ„ç»„ä»¶ | åŒå‘ | é«˜ |

#### åŸºç¡€é€šä¿¡ç¤ºä¾‹

```vue
<!-- 1. Props/Emits çˆ¶å­é€šä¿¡ -->
<!-- çˆ¶ç»„ä»¶ -->
<template>
  <ChildComponent
    :message="parentMessage"
    :count="count"
    @update:count="count = $event"
    @custom-event="handleCustomEvent"
  />
</template>

<script setup>
import { ref } from 'vue'

const parentMessage = ref('æ¥è‡ªçˆ¶ç»„ä»¶çš„æ¶ˆæ¯')
const count = ref(0)

const handleCustomEvent = (data) => {
  console.log('æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶:', data)
}
</script>

<!-- å­ç»„ä»¶ -->
<script setup>
const props = defineProps({
  message: String,
  count: { type: Number, default: 0 }
})

const emit = defineEmits(['update:count', 'custom-event'])

const updateCount = () => emit('update:count', props.count + 1)
const emitCustomEvent = () => emit('custom-event', { timestamp: Date.now() })
</script>

<!-- 2. Provide/Inject è·¨å±‚çº§é€šä¿¡ -->
<!-- ç¥–å…ˆç»„ä»¶ -->
<script setup>
import { provide, ref, readonly } from 'vue'

const theme = ref('dark')
const user = ref({ name: 'John', role: 'admin' })

provide('theme', theme)
provide('user', readonly(user))
provide('updateTheme', (newTheme) => theme.value = newTheme)
</script>

<!-- åä»£ç»„ä»¶ -->
<script setup>
import { inject } from 'vue'

const theme = inject('theme')
const user = inject('user')
const updateTheme = inject('updateTheme')
const config = inject('config', { api: '/api' }) // é»˜è®¤å€¼
</script>

<!-- 3. æ¨¡æ¿å¼•ç”¨ -->
<template>
  <ChildComponent ref="childRef" />
  <button @click="childRef?.someMethod()">è°ƒç”¨å­ç»„ä»¶æ–¹æ³•</button>
</template>

<script setup>
import { ref } from 'vue'

const childRef = ref()
</script>
```

### PiniaçŠ¶æ€ç®¡ç†

#### Pinia vs Vuex

| ç‰¹æ€§ | Pinia | Vuex | ä¼˜åŠ¿ |
|------|-------|------|------|
| **TypeScriptæ”¯æŒ** | åŸç”Ÿæ”¯æŒ | éœ€è¦é¢å¤–é…ç½® | æ›´å¥½çš„ç±»å‹æ¨æ–­ |
| **ä»£ç åˆ†å‰²** | è‡ªåŠ¨æ”¯æŒ | éœ€è¦æ‰‹åŠ¨é…ç½® | æ›´å¥½çš„Tree-shaking |
| **DevTools** | å®Œæ•´æ”¯æŒ | å®Œæ•´æ”¯æŒ | è°ƒè¯•ä½“éªŒç›¸å½“ |
| **å­¦ä¹ æ›²çº¿** | æ›´ç®€å• | ç›¸å¯¹å¤æ‚ | æ›´å®¹æ˜“ä¸Šæ‰‹ |
| **åŒ…å¤§å°** | æ›´å° | è¾ƒå¤§ | æ›´è½»é‡ |

#### Storeå®šä¹‰æ–¹å¼

```javascript
// 1. Option Storeï¼ˆç±»ä¼¼Vuexï¼‰
export const useCounterStore = defineStore('counter', {
  state: () => ({
    count: 0,
    name: 'Eduardo'
  }),

  getters: {
    doubleCount: (state) => state.count * 2
  },

  actions: {
    increment() {
      this.count++
    },

    async fetchUserData() {
      const userData = await api.getUser()
      this.name = userData.name
    }
  }
})

// 2. Composition Storeï¼ˆæ¨èï¼‰
export const useCounterStore = defineStore('counter', () => {
  // state
  const count = ref(0)
  const name = ref('Eduardo')

  // getters
  const doubleCount = computed(() => count.value * 2)

  // actions
  const increment = () => count.value++

  const fetchUserData = async () => {
    const userData = await api.getUser()
    name.value = userData.name
  }

  return { count, name, doubleCount, increment, fetchUserData }
})
```

#### ç»„ä»¶ä¸­ä½¿ç”¨

```javascript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨Pinia
import { useCounterStore } from '@/stores/counter'
import { storeToRefs } from 'pinia'

const store = useCounterStore()

// è§£æ„å“åº”å¼æ•°æ®ï¼ˆéœ€è¦storeToRefsï¼‰
const { count, name, doubleCount } = storeToRefs(store)

// è§£æ„actionsï¼ˆä¸éœ€è¦storeToRefsï¼‰
const { increment, fetchUserData } = store

// æ‰¹é‡æ›´æ–°
store.$patch({ count: 10, name: 'New Name' })
```

## Vue3æ€§èƒ½ä¼˜åŒ–

<Callout type="info">
Vue3åœ¨æ€§èƒ½æ–¹é¢æœ‰æ˜¾è‘—æå‡ï¼ŒåŒ…æ‹¬æ›´å°çš„åŒ…ä½“ç§¯ã€æ›´å¿«çš„æ¸²æŸ“é€Ÿåº¦å’Œæ›´å¥½çš„Tree-shakingæ”¯æŒã€‚
</Callout>

### Vue3æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### æ€§èƒ½ä¼˜åŒ–å¯¹æ¯”

| ä¼˜åŒ–ç±»å‹ | Vue2 | Vue3 | æå‡æ•ˆæœ |
|----------|------|------|----------|
| **åŒ…ä½“ç§¯** | 34KB | 13.5KB | 60%å‡å°‘ |
| **åˆå§‹æ¸²æŸ“** | åŸºå‡† | 55%æå‡ | æ›´å¿«çš„é¦–å± |
| **æ›´æ–°æ€§èƒ½** | åŸºå‡† | 133%æå‡ | æ›´å¿«çš„é‡æ¸²æŸ“ |
| **å†…å­˜ä½¿ç”¨** | åŸºå‡† | 54%å‡å°‘ | æ›´å°‘çš„å†…å­˜å ç”¨ |

#### ç¼–è¯‘æ—¶ä¼˜åŒ–

```vue
<template>
  <!-- é™æ€æå‡ï¼šé™æ€å…ƒç´ æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨ -->
  <div class="static-class">
    <h1>é™æ€æ ‡é¢˜</h1>
    <!-- åªæœ‰åŠ¨æ€å†…å®¹ä¼šé‡æ–°æ¸²æŸ“ -->
    <p>{{ message }}</p>
    <div :class="dynamicClass">{{ count }}</div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'

const message = ref('Hello Vue3')
const count = ref(0)
const dynamicClass = computed(() => count.value > 10 ? 'large' : 'small')
</script>
```

#### å“åº”å¼ä¼˜åŒ–æŠ€å·§

```javascript
// 1. ä½¿ç”¨shallowRefå‡å°‘æ·±åº¦å“åº”å¼å¼€é”€
import { shallowRef, triggerRef, markRaw } from 'vue'

const state = shallowRef({
  count: 0,
  nested: { value: 'hello' }
})

// æ‰‹åŠ¨è§¦å‘æ›´æ–°
const updateNested = () => {
  state.value.nested.value = 'world'
  triggerRef(state) // æ‰‹åŠ¨è§¦å‘å“åº”å¼æ›´æ–°
}

// 2. ä½¿ç”¨markRawé¿å…å“åº”å¼è½¬æ¢
const state = reactive({
  foo: markRaw({
    // è¿™ä¸ªå¯¹è±¡ä¸ä¼šè¢«è½¬æ¢ä¸ºå“åº”å¼
    nestedProperty: 'value'
  })
})
```

#### ç»„ä»¶ä¼˜åŒ–æŠ€å·§

```vue
<!-- 1. ä½¿ç”¨v-memoç¼“å­˜å­æ ‘ -->
<template>
  <div v-for="item in list" :key="item.id" v-memo="[item.id, item.selected]">
    <p>{{ item.name }}</p>
    <p>{{ item.description }}</p>
  </div>
</template>

<script setup>
// 2. å¼‚æ­¥ç»„ä»¶åŠ è½½
import { defineAsyncComponent } from 'vue'

const AsyncComponent = defineAsyncComponent({
  loader: () => import('./HeavyComponent.vue'),
  loadingComponent: LoadingComponent,
  delay: 200,
  timeout: 3000
})
</script>
```

#### æ€§èƒ½ä¼˜åŒ–æ¸…å•

- âœ… ä½¿ç”¨`shallowRef`å’Œ`shallowReactive`å‡å°‘æ·±åº¦å“åº”å¼
- âœ… ä½¿ç”¨`markRaw`æ ‡è®°ä¸éœ€è¦å“åº”å¼çš„å¯¹è±¡
- âœ… ä½¿ç”¨`v-memo`ç¼“å­˜å¤æ‚çš„åˆ—è¡¨é¡¹
- âœ… ä½¿ç”¨å¼‚æ­¥ç»„ä»¶è¿›è¡Œä»£ç åˆ†å‰²
- âœ… åˆç†ä½¿ç”¨`computed`ç¼“å­˜è®¡ç®—ç»“æœ
- âœ… é¿å…åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨å¤æ‚è¡¨è¾¾å¼

## Vue3ç”Ÿæ€ç³»ç»Ÿ

<Callout type="info">
Vue3æ‹¥æœ‰ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…æ‹¬å®˜æ–¹å·¥å…·ã€ç¬¬ä¸‰æ–¹åº“å’Œå¼€å‘å·¥å…·ã€‚
</Callout>

### Vue3ç”Ÿæ€ç³»ç»Ÿæ¦‚è§ˆ

#### æ ¸å¿ƒå·¥å…·å¯¹æ¯”

| å·¥å…·ç±»å‹ | Vue3æ¨è | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|----------|------|----------|
| **æ„å»ºå·¥å…·** | Vite | å¿«é€Ÿçƒ­æ›´æ–°ã€åŸç”ŸESM | ç°ä»£é¡¹ç›® |
| **è„šæ‰‹æ¶** | create-vue | å®˜æ–¹æ¨¡æ¿ã€TypeScriptæ”¯æŒ | æ–°é¡¹ç›® |
| **è·¯ç”±** | Vue Router 4 | Composition APIæ”¯æŒ | SPAåº”ç”¨ |
| **çŠ¶æ€ç®¡ç†** | Pinia | è½»é‡ã€TypeScriptå‹å¥½ | å…¨å±€çŠ¶æ€ |
| **UIåº“** | Element Plus, Vuetify 3 | Vue3åŸç”Ÿæ”¯æŒ | ä¼ä¸šåº”ç”¨ |

#### å¿«é€Ÿå¼€å§‹

```bash
# åˆ›å»ºVue3é¡¹ç›®
npm create vue@latest my-vue-app
cd my-vue-app
npm install
npm run dev
```

#### è·¯ç”±é…ç½®

```javascript
// Vue Router 4 åŸºç¡€é…ç½®
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/',
      name: 'Home',
      component: () => import('./views/Home.vue')
    },
    {
      path: '/user/:id',
      name: 'User',
      component: () => import('./views/User.vue'),
      props: true
    }
  ]
})
```

#### ä¸»è¦UIç»„ä»¶åº“

```javascript
// Element Plusï¼ˆæ¨èï¼‰
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'

app.use(ElementPlus)

// Ant Design Vue
import Antd from 'ant-design-vue'
import 'ant-design-vue/dist/antd.css'

app.use(Antd)
```

#### å¼€å‘å·¥å…·æ¨è

| å·¥å…· | åŠŸèƒ½ | å®‰è£…æ–¹å¼ |
|------|------|----------|
| **Vue DevTools** | è°ƒè¯•Vueç»„ä»¶å’ŒçŠ¶æ€ | æµè§ˆå™¨æ‰©å±• |
| **Volar** | VS Code Vue3æ”¯æŒ | VS Codeæ‰©å±• |
| **Vitest** | å•å…ƒæµ‹è¯•æ¡†æ¶ | `npm install vitest` |
| **Vue Test Utils** | Vueç»„ä»¶æµ‹è¯•å·¥å…· | `npm install @vue/test-utils` |

#### æµ‹è¯•ç¤ºä¾‹

```javascript
// Vitest + Vue Test Utils
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'

describe('MyComponent', () => {
  it('renders properly', () => {
    const wrapper = mount(MyComponent, {
      props: { msg: 'Hello Vitest' }
    })
    expect(wrapper.text()).toContain('Hello Vitest')
  })
})
```

---

<Callout type="success">
Vue3çš„Composition APIå’Œå“åº”å¼ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ›´çµæ´»ã€æ›´å¼ºå¤§çš„å¼€å‘ä½“éªŒã€‚é€šè¿‡åˆç†ä½¿ç”¨ç»„åˆå¼å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºæ›´åŠ æ¨¡å—åŒ–å’Œå¯å¤ç”¨çš„ä»£ç ã€‚
</Callout>

---

## ğŸ“š å‚è€ƒå­¦ä¹ èµ„æ–™

### ğŸ“– å®˜æ–¹æ–‡æ¡£
- [Vue3 å®˜æ–¹æ–‡æ¡£](https://vuejs.org/) - Vue3æƒå¨å­¦ä¹ èµ„æº
- [Vue3 API å‚è€ƒ](https://vuejs.org/api/) - å®Œæ•´APIæ–‡æ¡£
- [Vue Router 4](https://router.vuejs.org/) - å®˜æ–¹è·¯ç”±ç®¡ç†
- [Pinia](https://pinia.vuejs.org/) - å®˜æ–¹çŠ¶æ€ç®¡ç†åº“

### ğŸ“ ä¼˜è´¨æ•™ç¨‹
- [Vue3 å®˜æ–¹æ•™ç¨‹](https://vuejs.org/tutorial/) - å®˜æ–¹äº¤äº’å¼æ•™ç¨‹
- [Vue Mastery](https://www.vuemastery.com/) - Vueä¸“ä¸šè¯¾ç¨‹å¹³å°
- [Vue School](https://vueschool.io/) - Vueåœ¨çº¿å­¦ä¹ å¹³å°

### ğŸ› ï¸ å®è·µé¡¹ç›®
- [Vue3 ç¤ºä¾‹é¡¹ç›®](https://github.com/vuejs/petite-vue) - å®˜æ–¹ç¤ºä¾‹
- [Awesome Vue](https://github.com/vuejs/awesome-vue) - Vueèµ„æºé›†åˆ
- [Vue3 æœ€ä½³å®è·µ](https://github.com/vuejs/vue-next) - å®˜æ–¹ä»“åº“

### ğŸ”§ å¼€å‘å·¥å…·
- [Vite](https://vitejs.dev/) - å®˜æ–¹æ„å»ºå·¥å…·
- [Vue CLI](https://cli.vuejs.org/) - ä¼ ç»Ÿè„šæ‰‹æ¶å·¥å…·
- [Vue DevTools](https://devtools.vuejs.org/) - å®˜æ–¹è°ƒè¯•å·¥å…·
- [Volar](https://marketplace.visualstudio.com/items?itemName=Vue.volar) - VS Codeæ‰©å±•

### ğŸ“ æ·±å…¥é˜…è¯»
- [Vue3 è®¾è®¡ç†å¿µ](https://vuejs.org/guide/extras/composition-api-faq.html) - Composition APIè®¾è®¡æ€è·¯
- [Vue3 å“åº”å¼åŸç†](https://vuejs.org/guide/extras/reactivity-in-depth.html) - å“åº”å¼ç³»ç»Ÿæ·±å…¥
- [Vue3 æ€§èƒ½ä¼˜åŒ–](https://vuejs.org/guide/best-practices/performance.html) - å®˜æ–¹æ€§èƒ½æŒ‡å—

<Callout type="tip">
ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šå»ºè®®ä»å®˜æ–¹æ–‡æ¡£å¼€å§‹ï¼Œé€šè¿‡Viteåˆ›å»ºé¡¹ç›®å®è·µï¼Œç„¶åæ·±å…¥å­¦ä¹ Composition APIå’Œå“åº”å¼ç³»ç»Ÿï¼Œæœ€åäº†è§£Vue3ç”Ÿæ€ç³»ç»Ÿã€‚
</Callout>
