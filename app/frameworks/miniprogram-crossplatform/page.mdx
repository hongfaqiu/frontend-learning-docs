import { Callout } from 'nextra/components'

# 12. 小程序和跨端开发

## 📋 目录

- [小程序生态概览](#小程序生态概览)
- [微信小程序深入开发](#微信小程序深入开发)
- [跨端框架对比](#跨端框架对比)
- [uni-app全平台开发](#uni-app全平台开发)
- [Taro多端统一开发](#taro多端统一开发)
- [性能优化和最佳实践](#性能优化和最佳实践)

## 小程序生态概览

<Callout type="info">
小程序作为轻量级应用形态，在移动互联网时代扮演着重要角色。理解各平台小程序的特点和开发方式是现代前端开发者的必备技能。
</Callout>

### 主流小程序平台对比

```javascript
// 小程序平台特性对比
const miniProgramPlatforms = {
  // 微信小程序
  wechat: {
    name: '微信小程序',
    userBase: '12亿+',
    features: {
      支付: '微信支付',
      分享: '朋友圈、群聊',
      登录: '微信授权登录',
      地图: '腾讯地图',
      直播: '小程序直播',
      云开发: '微信云开发'
    },
    limitations: {
      包大小: '主包2MB，分包20MB',
      域名: '需要备案的HTTPS域名',
      审核: '较严格的审核机制'
    },
    适用场景: ['电商', '工具', '内容', '游戏']
  },
  
  // 支付宝小程序
  alipay: {
    name: '支付宝小程序',
    userBase: '10亿+',
    features: {
      支付: '支付宝支付',
      芝麻信用: '信用评估',
      生活服务: '城市服务',
      金融服务: '理财、保险'
    },
    limitations: {
      包大小: '主包2MB，分包8MB',
      生态: '相对封闭的生态'
    },
    适用场景: ['金融', '生活服务', '政务']
  },
  
  // 百度智能小程序
  baidu: {
    name: '百度智能小程序',
    userBase: '5亿+',
    features: {
      搜索: 'SEO友好',
      AI能力: '语音、图像识别',
      开放生态: '可在多个App中运行'
    },
    适用场景: ['内容', '工具', '服务']
  },
  
  // 字节跳动小程序
  bytedance: {
    name: '字节跳动小程序',
    userBase: '6亿+',
    features: {
      流量: '抖音、今日头条流量',
      算法推荐: '智能推荐',
      短视频: '视频能力'
    },
    适用场景: ['内容', '娱乐', '电商']
  }
};

// 跨端开发框架对比
const crossPlatformFrameworks = {
  'uni-app': {
    开发语言: 'Vue.js',
    支持平台: ['微信', '支付宝', '百度', '字节跳动', 'QQ', 'H5', 'App'],
    学习成本: '低（Vue开发者）',
    性能: '接近原生',
    生态: '丰富的插件市场',
    适合团队: 'Vue技术栈团队'
  },
  
  'Taro': {
    开发语言: 'React/Vue',
    支持平台: ['微信', '支付宝', '百度', '字节跳动', 'QQ', 'H5', 'RN'],
    学习成本: '中等',
    性能: '良好',
    生态: '京东团队维护',
    适合团队: 'React技术栈团队'
  },
  
  'Remax': {
    开发语言: 'React',
    支持平台: ['微信', '支付宝', '字节跳动'],
    学习成本: '低（React开发者）',
    性能: '优秀',
    特点: '真正的React开发体验'
  },
  
  'mpvue': {
    开发语言: 'Vue.js',
    支持平台: ['微信', '支付宝', '百度'],
    状态: '已停止维护',
    替代方案: 'uni-app'
  }
};
```

## 微信小程序深入开发

### 小程序架构和生命周期

```javascript
// 1. 小程序应用生命周期
// app.js
App({
  // 小程序初始化完成时触发，全局只触发一次
  onLaunch(options) {
    console.log('小程序启动', options);
    
    // 获取用户信息
    this.getUserInfo();
    
    // 检查更新
    this.checkForUpdate();
    
    // 初始化云开发
    if (wx.cloud) {
      wx.cloud.init({
        env: 'your-env-id',
        traceUser: true
      });
    }
  },
  
  // 小程序显示/切前台时触发
  onShow(options) {
    console.log('小程序显示', options);
    
    // 更新数据
    this.updateAppData();
  },
  
  // 小程序隐藏/切后台时触发
  onHide() {
    console.log('小程序隐藏');
    
    // 保存数据
    this.saveAppData();
  },
  
  // 小程序发生脚本错误或API调用报错时触发
  onError(msg) {
    console.error('小程序错误', msg);
    
    // 错误上报
    this.reportError(msg);
  },
  
  // 页面不存在时触发
  onPageNotFound(res) {
    console.log('页面不存在', res);
    
    // 重定向到首页
    wx.redirectTo({
      url: '/pages/index/index'
    });
  },
  
  // 全局数据
  globalData: {
    userInfo: null,
    systemInfo: null
  },
  
  // 获取用户信息
  getUserInfo() {
    return new Promise((resolve, reject) => {
      // 检查是否已授权
      wx.getSetting({
        success: (res) => {
          if (res.authSetting['scope.userInfo']) {
            wx.getUserInfo({
              success: (userRes) => {
                this.globalData.userInfo = userRes.userInfo;
                resolve(userRes.userInfo);
              },
              fail: reject
            });
          } else {
            // 未授权，引导用户授权
            resolve(null);
          }
        },
        fail: reject
      });
    });
  },
  
  // 检查小程序更新
  checkForUpdate() {
    if (wx.canIUse('getUpdateManager')) {
      const updateManager = wx.getUpdateManager();
      
      updateManager.onCheckForUpdate((res) => {
        console.log('检查更新结果', res.hasUpdate);
      });
      
      updateManager.onUpdateReady(() => {
        wx.showModal({
          title: '更新提示',
          content: '新版本已经准备好，是否重启应用？',
          success: (res) => {
            if (res.confirm) {
              updateManager.applyUpdate();
            }
          }
        });
      });
      
      updateManager.onUpdateFailed(() => {
        wx.showToast({
          title: '更新失败',
          icon: 'none'
        });
      });
    }
  }
});

// 2. 页面生命周期
// pages/index/index.js
Page({
  data: {
    userInfo: {},
    hasUserInfo: false,
    posts: [],
    loading: false
  },
  
  // 页面加载时触发，一个页面只会调用一次
  onLoad(options) {
    console.log('页面加载', options);
    
    // 获取页面参数
    this.pageParams = options;
    
    // 初始化页面数据
    this.initPageData();
  },
  
  // 页面显示/切入前台时触发
  onShow() {
    console.log('页面显示');
    
    // 刷新数据
    this.refreshData();
  },
  
  // 页面隐藏/切入后台时触发
  onHide() {
    console.log('页面隐藏');
  },
  
  // 页面卸载时触发
  onUnload() {
    console.log('页面卸载');
    
    // 清理定时器
    if (this.timer) {
      clearInterval(this.timer);
    }
  },
  
  // 监听用户下拉刷新事件
  onPullDownRefresh() {
    console.log('下拉刷新');
    
    this.refreshData().finally(() => {
      wx.stopPullDownRefresh();
    });
  },
  
  // 页面上拉触底事件
  onReachBottom() {
    console.log('上拉触底');
    
    this.loadMoreData();
  },
  
  // 用户点击右上角分享
  onShareAppMessage() {
    return {
      title: '分享标题',
      path: '/pages/index/index',
      imageUrl: '/images/share.jpg'
    };
  },
  
  // 用户点击右上角分享到朋友圈
  onShareTimeline() {
    return {
      title: '分享到朋友圈的标题',
      query: 'from=timeline',
      imageUrl: '/images/timeline-share.jpg'
    };
  },
  
  // 初始化页面数据
  async initPageData() {
    try {
      this.setData({ loading: true });
      
      // 获取用户信息
      const app = getApp();
      if (app.globalData.userInfo) {
        this.setData({
          userInfo: app.globalData.userInfo,
          hasUserInfo: true
        });
      }
      
      // 加载文章列表
      await this.loadPosts();
      
    } catch (error) {
      console.error('初始化失败', error);
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
    } finally {
      this.setData({ loading: false });
    }
  },
  
  // 加载文章列表
  async loadPosts() {
    try {
      const res = await wx.cloud.callFunction({
        name: 'getPosts',
        data: {
          page: 1,
          limit: 10
        }
      });
      
      this.setData({
        posts: res.result.data
      });
    } catch (error) {
      console.error('加载文章失败', error);
    }
  },
  
  // 刷新数据
  async refreshData() {
    await this.loadPosts();
  },
  
  // 加载更多数据
  async loadMoreData() {
    // 实现分页加载逻辑
  },
  
  // 获取用户信息按钮点击事件
  getUserProfile(e) {
    wx.getUserProfile({
      desc: '用于完善会员资料',
      success: (res) => {
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        });
        
        // 保存到全局数据
        getApp().globalData.userInfo = res.userInfo;
      }
    });
  }
});
```

### 小程序云开发

```javascript
// 1. 云函数开发
// cloudfunctions/getPosts/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();

exports.main = async (event, context) => {
  const { page = 1, limit = 10, category } = event;
  
  try {
    // 构建查询条件
    let query = db.collection('posts');
    
    if (category) {
      query = query.where({
        category: category,
        status: 'published'
      });
    } else {
      query = query.where({
        status: 'published'
      });
    }
    
    // 分页查询
    const result = await query
      .orderBy('createdAt', 'desc')
      .skip((page - 1) * limit)
      .limit(limit)
      .get();
    
    // 获取总数
    const countResult = await query.count();
    
    return {
      code: 0,
      data: result.data,
      total: countResult.total,
      page,
      limit
    };
  } catch (error) {
    console.error('获取文章失败', error);
    return {
      code: -1,
      message: '获取文章失败'
    };
  }
};

// 2. 云数据库操作
class CloudDatabase {
  constructor() {
    this.db = wx.cloud.database();
  }
  
  // 添加文档
  async add(collection, data) {
    try {
      const result = await this.db.collection(collection).add({
        data: {
          ...data,
          createdAt: new Date(),
          updatedAt: new Date()
        }
      });
      
      return {
        success: true,
        id: result._id
      };
    } catch (error) {
      console.error('添加文档失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 查询文档
  async get(collection, id) {
    try {
      const result = await this.db.collection(collection).doc(id).get();
      return {
        success: true,
        data: result.data
      };
    } catch (error) {
      console.error('查询文档失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 更新文档
  async update(collection, id, data) {
    try {
      await this.db.collection(collection).doc(id).update({
        data: {
          ...data,
          updatedAt: new Date()
        }
      });
      
      return { success: true };
    } catch (error) {
      console.error('更新文档失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 删除文档
  async remove(collection, id) {
    try {
      await this.db.collection(collection).doc(id).remove();
      return { success: true };
    } catch (error) {
      console.error('删除文档失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 复杂查询
  async query(collection, conditions = {}) {
    try {
      let query = this.db.collection(collection);
      
      // 添加查询条件
      if (Object.keys(conditions).length > 0) {
        query = query.where(conditions);
      }
      
      const result = await query.get();
      
      return {
        success: true,
        data: result.data
      };
    } catch (error) {
      console.error('查询失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
}

// 3. 云存储操作
class CloudStorage {
  // 上传文件
  async uploadFile(filePath, cloudPath) {
    try {
      const result = await wx.cloud.uploadFile({
        cloudPath,
        filePath
      });
      
      return {
        success: true,
        fileID: result.fileID
      };
    } catch (error) {
      console.error('上传文件失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 下载文件
  async downloadFile(fileID) {
    try {
      const result = await wx.cloud.downloadFile({
        fileID
      });
      
      return {
        success: true,
        tempFilePath: result.tempFilePath
      };
    } catch (error) {
      console.error('下载文件失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 删除文件
  async deleteFile(fileIDs) {
    try {
      const result = await wx.cloud.deleteFile({
        fileList: Array.isArray(fileIDs) ? fileIDs : [fileIDs]
      });
      
      return {
        success: true,
        deleteList: result.fileList
      };
    } catch (error) {
      console.error('删除文件失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // 获取临时链接
  async getTempFileURL(fileIDs) {
    try {
      const result = await wx.cloud.getTempFileURL({
        fileList: Array.isArray(fileIDs) 
          ? fileIDs.map(id => ({ fileID: id }))
          : [{ fileID: fileIDs }]
      });
      
      return {
        success: true,
        fileList: result.fileList
      };
    } catch (error) {
      console.error('获取临时链接失败', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
}

// 使用示例
const cloudDB = new CloudDatabase();
const cloudStorage = new CloudStorage();

// 在页面中使用
Page({
  data: {
    imageUrl: ''
  },
  
  // 选择并上传图片
  async chooseAndUploadImage() {
    try {
      // 选择图片
      const chooseResult = await wx.chooseImage({
        count: 1,
        sizeType: ['compressed'],
        sourceType: ['album', 'camera']
      });
      
      const tempFilePath = chooseResult.tempFilePaths[0];
      
      // 上传到云存储
      const uploadResult = await cloudStorage.uploadFile(
        tempFilePath,
        `images/${Date.now()}.jpg`
      );
      
      if (uploadResult.success) {
        // 获取临时链接用于显示
        const urlResult = await cloudStorage.getTempFileURL(uploadResult.fileID);
        
        if (urlResult.success) {
          this.setData({
            imageUrl: urlResult.fileList[0].tempFileURL
          });
        }
      }
    } catch (error) {
      console.error('上传图片失败', error);
      wx.showToast({
        title: '上传失败',
        icon: 'none'
      });
    }
  }
});
```

---

<Callout type="success">
小程序和跨端开发为前端开发者提供了更广阔的应用场景，掌握这些技术能够让你的应用覆盖更多平台和用户。
</Callout>
