import { Callout } from 'nextra/components'

# 18. ç°ä»£å‰ç«¯æ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•

- [å‰ç«¯æ¶æ„æ¼”è¿›å†ç¨‹](#å‰ç«¯æ¶æ„æ¼”è¿›å†ç¨‹)
- [å¾®å‰ç«¯æ¶æ„è®¾è®¡](#å¾®å‰ç«¯æ¶æ„è®¾è®¡)
- [ç»„ä»¶åŒ–æ¶æ„æ¨¡å¼](#ç»„ä»¶åŒ–æ¶æ„æ¨¡å¼)
- [æ¨¡å—åŒ–å’Œä¾èµ–ç®¡ç†](#æ¨¡å—åŒ–å’Œä¾èµ–ç®¡ç†)
- [å¯æ‰©å±•æ€§è®¾è®¡åŸåˆ™](#å¯æ‰©å±•æ€§è®¾è®¡åŸåˆ™)
- [æ¶æ„å†³ç­–å’Œæƒè¡¡](#æ¶æ„å†³ç­–å’Œæƒè¡¡)

## å‰ç«¯æ¶æ„æ¼”è¿›å†ç¨‹

<Callout type="info">
å‰ç«¯æ¶æ„ä»ç®€å•çš„é¡µé¢è„šæœ¬å‘å±•åˆ°å¤æ‚çš„åº”ç”¨æ¶æ„ï¼Œç†è§£è¿™ä¸ªæ¼”è¿›è¿‡ç¨‹æœ‰åŠ©äºæˆ‘ä»¬åšå‡ºæ›´å¥½çš„æ¶æ„å†³ç­–ã€‚
</Callout>

### æ¶æ„æ¼”è¿›é˜¶æ®µ

```javascript
// å‰ç«¯æ¶æ„æ¼”è¿›å†ç¨‹
const architectureEvolution = {
  // 1. ä¼ ç»Ÿå¤šé¡µåº”ç”¨ (MPA)
  traditionalMPA: {
    period: '1990s-2000s',
    characteristics: [
      'æœåŠ¡ç«¯æ¸²æŸ“',
      'é¡µé¢åˆ·æ–°å¯¼èˆª',
      'jQueryæ“ä½œDOM',
      'ç®€å•çš„è„šæœ¬æ–‡ä»¶'
    ],
    advantages: ['SEOå‹å¥½', 'ç®€å•ç›´æ¥', 'æœåŠ¡ç«¯æ§åˆ¶'],
    disadvantages: ['ç”¨æˆ·ä½“éªŒå·®', 'é‡å¤åŠ è½½', 'çŠ¶æ€éš¾ä»¥ç»´æŠ¤'],
    example: `
      <!-- ä¼ ç»ŸMPAç»“æ„ -->
      <script src="jquery.js"></script>
      <script>
        $(document).ready(function() {
          $('#button').click(function() {
            window.location.href = '/next-page';
          });
        });
      </script>
    `
  },
  
  // 2. å•é¡µåº”ç”¨ (SPA)
  singlePageApp: {
    period: '2010s',
    characteristics: [
      'å®¢æˆ·ç«¯è·¯ç”±',
      'åŠ¨æ€å†…å®¹æ›´æ–°',
      'AJAXæ•°æ®è·å–',
      'å‰ç«¯æ¡†æ¶å…´èµ·'
    ],
    advantages: ['æµç•…ä½“éªŒ', 'å¿«é€Ÿå¯¼èˆª', 'ä¸°å¯Œäº¤äº’'],
    disadvantages: ['SEOæŒ‘æˆ˜', 'é¦–å±åŠ è½½æ…¢', 'å¤æ‚åº¦å¢åŠ '],
    frameworks: ['Angular', 'React', 'Vue'],
    example: `
      // SPAè·¯ç”±ç¤ºä¾‹
      const router = new Router({
        '/home': () => import('./pages/Home'),
        '/about': () => import('./pages/About'),
        '/contact': () => import('./pages/Contact')
      });
    `
  },
  
  // 3. åŒæ„åº”ç”¨ (SSR)
  isomorphicApp: {
    period: '2015+',
    characteristics: [
      'æœåŠ¡ç«¯+å®¢æˆ·ç«¯æ¸²æŸ“',
      'ä»£ç å¤ç”¨',
      'é¦–å±ä¼˜åŒ–',
      'SEOå‹å¥½'
    ],
    advantages: ['æœ€ä½³æ€§èƒ½', 'SEOä¼˜åŒ–', 'ç”¨æˆ·ä½“éªŒå¥½'],
    disadvantages: ['å¤æ‚åº¦é«˜', 'å¼€å‘æˆæœ¬å¤§', 'æœåŠ¡å™¨å‹åŠ›'],
    frameworks: ['Next.js', 'Nuxt.js', 'SvelteKit'],
    example: `
      // Next.js SSRç¤ºä¾‹
      export async function getServerSideProps() {
        const data = await fetchData();
        return { props: { data } };
      }
    `
  },
  
  // 4. å¾®å‰ç«¯æ¶æ„
  microfrontend: {
    period: '2018+',
    characteristics: [
      'åº”ç”¨æ‹†åˆ†',
      'ç‹¬ç«‹éƒ¨ç½²',
      'æŠ€æœ¯æ ˆè‡ªç”±',
      'å›¢é˜Ÿè‡ªæ²»'
    ],
    advantages: ['å¯æ‰©å±•æ€§', 'æŠ€æœ¯å¤šæ ·æ€§', 'å›¢é˜Ÿç‹¬ç«‹'],
    disadvantages: ['å¤æ‚åº¦é«˜', 'æ€§èƒ½å¼€é”€', 'ä¸€è‡´æ€§æŒ‘æˆ˜'],
    solutions: ['Single-SPA', 'Module Federation', 'qiankun'],
    example: `
      // å¾®å‰ç«¯æ³¨å†Œ
      registerApplication({
        name: 'react-app',
        app: () => import('./react-app/main.js'),
        activeWhen: ['/react']
      });
    `
  },
  
  // 5. è¾¹ç¼˜è®¡ç®—æ¶æ„
  edgeComputing: {
    period: '2020+',
    characteristics: [
      'è¾¹ç¼˜æ¸²æŸ“',
      'å°±è¿‘è®¡ç®—',
      'ä½å»¶è¿Ÿ',
      'å…¨çƒåˆ†å¸ƒ'
    ],
    advantages: ['æä½å»¶è¿Ÿ', 'å…¨çƒæ€§èƒ½', 'é«˜å¯ç”¨æ€§'],
    disadvantages: ['å¤æ‚éƒ¨ç½²', 'æˆæœ¬è¾ƒé«˜', 'è°ƒè¯•å›°éš¾'],
    platforms: ['Cloudflare Workers', 'Vercel Edge', 'Deno Deploy']
  }
};

// æ¶æ„é€‰æ‹©å†³ç­–æ ‘
class ArchitectureDecisionTree {
  constructor() {
    this.factors = {
      teamSize: null,
      projectComplexity: null,
      performanceRequirements: null,
      seoRequirements: null,
      scalabilityNeeds: null,
      maintenanceCapacity: null
    };
  }
  
  analyze(requirements) {
    this.factors = { ...this.factors, ...requirements };
    return this.recommend();
  }
  
  recommend() {
    const { 
      teamSize, 
      projectComplexity, 
      performanceRequirements,
      seoRequirements,
      scalabilityNeeds 
    } = this.factors;
    
    // å°å›¢é˜Ÿ + ç®€å•é¡¹ç›®
    if (teamSize <= 5 && projectComplexity === 'low') {
      return {
        architecture: 'Traditional MPA',
        reason: 'ç®€å•ç›´æ¥ï¼Œç»´æŠ¤æˆæœ¬ä½',
        frameworks: ['Next.js', 'Nuxt.js', 'SvelteKit']
      };
    }
    
    // ä¸­ç­‰å›¢é˜Ÿ + ä¸­ç­‰å¤æ‚åº¦ + é«˜æ€§èƒ½è¦æ±‚
    if (teamSize <= 15 && performanceRequirements === 'high') {
      return {
        architecture: 'SSR/SSG',
        reason: 'å¹³è¡¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡',
        frameworks: ['Next.js', 'Nuxt.js', 'Remix']
      };
    }
    
    // å¤§å›¢é˜Ÿ + é«˜å¤æ‚åº¦ + é«˜æ‰©å±•æ€§éœ€æ±‚
    if (teamSize > 15 && scalabilityNeeds === 'high') {
      return {
        architecture: 'Micro-frontend',
        reason: 'æ”¯æŒå¤§è§„æ¨¡å›¢é˜Ÿåä½œ',
        solutions: ['Module Federation', 'Single-SPA', 'qiankun']
      };
    }
    
    // SEOé‡è¦çš„å†…å®¹ç½‘ç«™
    if (seoRequirements === 'critical') {
      return {
        architecture: 'Static Site Generation',
        reason: 'æœ€ä½³SEOæ€§èƒ½',
        frameworks: ['Next.js', 'Gatsby', 'Astro']
      };
    }
    
    // é»˜è®¤æ¨è
    return {
      architecture: 'SPA with SSR',
      reason: 'å¹³è¡¡å„æ–¹é¢éœ€æ±‚',
      frameworks: ['Next.js', 'Nuxt.js']
    };
  }
}
```

## å¾®å‰ç«¯æ¶æ„è®¾è®¡

### å¾®å‰ç«¯å®ç°æ–¹æ¡ˆ

```javascript
// 1. åŸºäºModule Federationçš„å¾®å‰ç«¯æ¶æ„
class MicrofrontendOrchestrator {
  constructor() {
    this.applications = new Map();
    this.sharedDependencies = new Map();
    this.eventBus = new EventTarget();
    this.setupGlobalErrorHandling();
  }
  
  // æ³¨å†Œå¾®åº”ç”¨
  registerApplication(config) {
    const {
      name,
      entry,
      container,
      activeRule,
      props = {}
    } = config;
    
    const application = {
      name,
      entry,
      container,
      activeRule,
      props,
      status: 'NOT_LOADED',
      instance: null
    };
    
    this.applications.set(name, application);
    console.log(`å¾®åº”ç”¨ ${name} æ³¨å†ŒæˆåŠŸ`);
  }
  
  // åŠ è½½å¾®åº”ç”¨
  async loadApplication(name) {
    const app = this.applications.get(name);
    if (!app) {
      throw new Error(`å¾®åº”ç”¨ ${name} æœªæ³¨å†Œ`);
    }
    
    if (app.status === 'LOADED') {
      return app.instance;
    }
    
    try {
      app.status = 'LOADING';
      
      // åŠ¨æ€å¯¼å…¥å¾®åº”ç”¨
      const module = await import(app.entry);
      
      // åˆ›å»ºåº”ç”¨å®ä¾‹
      app.instance = {
        mount: module.mount,
        unmount: module.unmount,
        update: module.update || (() => {}),
        getStatus: () => app.status
      };
      
      app.status = 'LOADED';
      
      this.eventBus.dispatchEvent(new CustomEvent('app-loaded', {
        detail: { name, app }
      }));
      
      return app.instance;
    } catch (error) {
      app.status = 'LOAD_ERROR';
      console.error(`åŠ è½½å¾®åº”ç”¨ ${name} å¤±è´¥:`, error);
      throw error;
    }
  }
  
  // æŒ‚è½½å¾®åº”ç”¨
  async mountApplication(name, container) {
    const app = this.applications.get(name);
    if (!app) {
      throw new Error(`å¾®åº”ç”¨ ${name} æœªæ³¨å†Œ`);
    }
    
    try {
      if (app.status !== 'LOADED') {
        await this.loadApplication(name);
      }
      
      // å‡†å¤‡æŒ‚è½½ç¯å¢ƒ
      const mountContainer = container || document.querySelector(app.container);
      if (!mountContainer) {
        throw new Error(`æ‰¾ä¸åˆ°å®¹å™¨: ${app.container}`);
      }
      
      // è®¾ç½®æ²™ç®±ç¯å¢ƒ
      const sandbox = this.createSandbox(name);
      
      // æŒ‚è½½åº”ç”¨
      await app.instance.mount({
        container: mountContainer,
        props: app.props,
        sandbox
      });
      
      app.status = 'MOUNTED';
      
      this.eventBus.dispatchEvent(new CustomEvent('app-mounted', {
        detail: { name, app }
      }));
      
      console.log(`å¾®åº”ç”¨ ${name} æŒ‚è½½æˆåŠŸ`);
    } catch (error) {
      app.status = 'MOUNT_ERROR';
      console.error(`æŒ‚è½½å¾®åº”ç”¨ ${name} å¤±è´¥:`, error);
      throw error;
    }
  }
  
  // å¸è½½å¾®åº”ç”¨
  async unmountApplication(name) {
    const app = this.applications.get(name);
    if (!app || app.status !== 'MOUNTED') {
      return;
    }
    
    try {
      await app.instance.unmount();
      app.status = 'LOADED';
      
      this.eventBus.dispatchEvent(new CustomEvent('app-unmounted', {
        detail: { name, app }
      }));
      
      console.log(`å¾®åº”ç”¨ ${name} å¸è½½æˆåŠŸ`);
    } catch (error) {
      console.error(`å¸è½½å¾®åº”ç”¨ ${name} å¤±è´¥:`, error);
    }
  }
  
  // åˆ›å»ºæ²™ç®±ç¯å¢ƒ
  createSandbox(appName) {
    const sandbox = {
      // æ ·å¼éš”ç¦»
      scopedCSS: this.createScopedCSS(appName),
      
      // JavaScriptéš”ç¦»
      isolatedGlobals: this.createIsolatedGlobals(appName),
      
      // äº‹ä»¶éš”ç¦»
      eventIsolation: this.createEventIsolation(appName)
    };
    
    return sandbox;
  }
  
  createScopedCSS(appName) {
    const prefix = `micro-app-${appName}`;
    
    return {
      addScope: (css) => {
        // ç®€åŒ–çš„CSSä½œç”¨åŸŸæ·»åŠ 
        return css.replace(/([^{}]+){/g, (match, selector) => {
          return `.${prefix} ${selector.trim()}{`;
        });
      },
      
      removeScope: (css) => {
        const regex = new RegExp(`\\.${prefix}\\s+`, 'g');
        return css.replace(regex, '');
      }
    };
  }
  
  createIsolatedGlobals(appName) {
    const originalGlobals = {};
    const isolatedWindow = {};
    
    return {
      isolate: () => {
        // ä¿å­˜åŸå§‹å…¨å±€å˜é‡
        ['localStorage', 'sessionStorage', 'history'].forEach(key => {
          originalGlobals[key] = window[key];
        });
        
        // åˆ›å»ºéš”ç¦»çš„å…¨å±€å¯¹è±¡
        isolatedWindow.localStorage = this.createIsolatedStorage(`${appName}-local`);
        isolatedWindow.sessionStorage = this.createIsolatedStorage(`${appName}-session`);
        isolatedWindow.history = this.createIsolatedHistory(appName);
        
        return isolatedWindow;
      },
      
      restore: () => {
        Object.assign(window, originalGlobals);
      }
    };
  }
  
  createIsolatedStorage(prefix) {
    return {
      getItem: (key) => {
        return localStorage.getItem(`${prefix}-${key}`);
      },
      setItem: (key, value) => {
        localStorage.setItem(`${prefix}-${key}`, value);
      },
      removeItem: (key) => {
        localStorage.removeItem(`${prefix}-${key}`);
      },
      clear: () => {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith(`${prefix}-`)) {
            localStorage.removeItem(key);
          }
        });
      }
    };
  }
  
  createIsolatedHistory(appName) {
    const baseUrl = `/micro-app/${appName}`;
    
    return {
      pushState: (state, title, url) => {
        const fullUrl = `${baseUrl}${url}`;
        history.pushState(state, title, fullUrl);
      },
      replaceState: (state, title, url) => {
        const fullUrl = `${baseUrl}${url}`;
        history.replaceState(state, title, fullUrl);
      },
      back: () => history.back(),
      forward: () => history.forward(),
      go: (delta) => history.go(delta)
    };
  }
  
  createEventIsolation(appName) {
    const eventMap = new Map();
    
    return {
      addEventListener: (type, listener, options) => {
        const wrappedListener = (event) => {
          // æ£€æŸ¥äº‹ä»¶æ˜¯å¦å±äºå½“å‰åº”ç”¨
          if (this.isEventFromApp(event, appName)) {
            listener(event);
          }
        };
        
        eventMap.set(listener, wrappedListener);
        document.addEventListener(type, wrappedListener, options);
      },
      
      removeEventListener: (type, listener, options) => {
        const wrappedListener = eventMap.get(listener);
        if (wrappedListener) {
          document.removeEventListener(type, wrappedListener, options);
          eventMap.delete(listener);
        }
      }
    };
  }
  
  isEventFromApp(event, appName) {
    const target = event.target;
    const appContainer = document.querySelector(`[data-app="${appName}"]`);
    return appContainer && appContainer.contains(target);
  }
  
  // åº”ç”¨é—´é€šä¿¡
  createCommunicationBridge() {
    return {
      // å‘é€æ¶ˆæ¯
      emit: (event, data) => {
        this.eventBus.dispatchEvent(new CustomEvent(event, {
          detail: data
        }));
      },
      
      // ç›‘å¬æ¶ˆæ¯
      on: (event, callback) => {
        this.eventBus.addEventListener(event, callback);
      },
      
      // ç§»é™¤ç›‘å¬
      off: (event, callback) => {
        this.eventBus.removeEventListener(event, callback);
      },
      
      // å…±äº«çŠ¶æ€
      setSharedState: (key, value) => {
        window.__SHARED_STATE__ = window.__SHARED_STATE__ || {};
        window.__SHARED_STATE__[key] = value;
        
        this.eventBus.dispatchEvent(new CustomEvent('shared-state-change', {
          detail: { key, value }
        }));
      },
      
      getSharedState: (key) => {
        return window.__SHARED_STATE__?.[key];
      }
    };
  }
  
  setupGlobalErrorHandling() {
    window.addEventListener('error', (event) => {
      console.error('å¾®å‰ç«¯å…¨å±€é”™è¯¯:', event.error);
      
      // å°è¯•è¯†åˆ«é”™è¯¯æ¥æºçš„åº”ç”¨
      const sourceApp = this.identifyErrorSource(event);
      if (sourceApp) {
        console.log(`é”™è¯¯æ¥æºåº”ç”¨: ${sourceApp}`);
        
        // å¯ä»¥é€‰æ‹©é‡å¯åº”ç”¨æˆ–æ˜¾ç¤ºé”™è¯¯é¡µé¢
        this.handleApplicationError(sourceApp, event.error);
      }
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('å¾®å‰ç«¯æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
    });
  }
  
  identifyErrorSource(event) {
    // ç®€åŒ–çš„é”™è¯¯æºè¯†åˆ«
    const stack = event.error?.stack || '';
    
    for (const [name] of this.applications) {
      if (stack.includes(name) || stack.includes(`micro-app-${name}`)) {
        return name;
      }
    }
    
    return null;
  }
  
  handleApplicationError(appName, error) {
    const app = this.applications.get(appName);
    if (app && app.status === 'MOUNTED') {
      // å°è¯•é‡æ–°æŒ‚è½½åº”ç”¨
      this.unmountApplication(appName)
        .then(() => this.mountApplication(appName))
        .catch(console.error);
    }
  }
}

// 2. å¾®å‰ç«¯è·¯ç”±ç®¡ç†
class MicrofrontendRouter {
  constructor(orchestrator) {
    this.orchestrator = orchestrator;
    this.routes = new Map();
    this.currentApp = null;
    this.setupRouting();
  }
  
  registerRoute(path, appName) {
    this.routes.set(path, appName);
  }
  
  setupRouting() {
    window.addEventListener('popstate', () => {
      this.handleRouteChange();
    });
    
    // æ‹¦æˆªpushStateå’ŒreplaceState
    this.interceptHistoryMethods();
    
    // åˆå§‹è·¯ç”±å¤„ç†
    this.handleRouteChange();
  }
  
  interceptHistoryMethods() {
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;
    
    history.pushState = (...args) => {
      originalPushState.apply(history, args);
      this.handleRouteChange();
    };
    
    history.replaceState = (...args) => {
      originalReplaceState.apply(history, args);
      this.handleRouteChange();
    };
  }
  
  async handleRouteChange() {
    const currentPath = window.location.pathname;
    const targetApp = this.findMatchingApp(currentPath);
    
    if (targetApp !== this.currentApp) {
      // å¸è½½å½“å‰åº”ç”¨
      if (this.currentApp) {
        await this.orchestrator.unmountApplication(this.currentApp);
      }
      
      // æŒ‚è½½æ–°åº”ç”¨
      if (targetApp) {
        await this.orchestrator.mountApplication(targetApp);
        this.currentApp = targetApp;
      }
    }
  }
  
  findMatchingApp(path) {
    for (const [routePath, appName] of this.routes) {
      if (path.startsWith(routePath)) {
        return appName;
      }
    }
    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const orchestrator = new MicrofrontendOrchestrator();
const router = new MicrofrontendRouter(orchestrator);

// æ³¨å†Œå¾®åº”ç”¨
orchestrator.registerApplication({
  name: 'header-app',
  entry: './micro-apps/header/index.js',
  container: '#header-container',
  activeRule: () => true
});

orchestrator.registerApplication({
  name: 'dashboard-app',
  entry: './micro-apps/dashboard/index.js',
  container: '#main-container',
  activeRule: (location) => location.pathname.startsWith('/dashboard')
});

// æ³¨å†Œè·¯ç”±
router.registerRoute('/dashboard', 'dashboard-app');
router.registerRoute('/profile', 'profile-app');

// åˆ›å»ºé€šä¿¡æ¡¥
const communicationBridge = orchestrator.createCommunicationBridge();

// åº”ç”¨é—´é€šä¿¡ç¤ºä¾‹
communicationBridge.on('user-login', (event) => {
  console.log('ç”¨æˆ·ç™»å½•:', event.detail);
  communicationBridge.setSharedState('currentUser', event.detail.user);
});
```

---

<Callout type="success">
ç°ä»£å‰ç«¯æ¶æ„è®¾è®¡éœ€è¦å¹³è¡¡å¤æ‚æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚é€‰æ‹©åˆé€‚çš„æ¶æ„æ¨¡å¼å¯¹é¡¹ç›®çš„é•¿æœŸæˆåŠŸè‡³å…³é‡è¦ã€‚
</Callout>
