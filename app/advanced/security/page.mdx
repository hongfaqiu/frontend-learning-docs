import { Callout } from 'nextra/components'

# 17. å‰ç«¯å®‰å…¨å’Œæœ€ä½³å®è·µ

## ğŸ“‹ ç›®å½•

- [å‰ç«¯å®‰å…¨å¨èƒæ¦‚è§ˆ](#å‰ç«¯å®‰å…¨å¨èƒæ¦‚è§ˆ)
- [XSSæ”»å‡»é˜²æŠ¤](#xssæ”»å‡»é˜²æŠ¤)
- [CSRFæ”»å‡»é˜²æŠ¤](#csrfæ”»å‡»é˜²æŠ¤)
- [å†…å®¹å®‰å…¨ç­–ç•¥CSP](#å†…å®¹å®‰å…¨ç­–ç•¥csp)
- [æ•°æ®ä¼ è¾“å®‰å…¨](#æ•°æ®ä¼ è¾“å®‰å…¨)
- [æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨](#æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨)
- [èº«ä»½è®¤è¯ä¸æˆæƒ](#èº«ä»½è®¤è¯ä¸æˆæƒ)
- [å®‰å…¨æµ‹è¯•ä¸ç›‘æ§](#å®‰å…¨æµ‹è¯•ä¸ç›‘æ§)
- [å®‰å…¨å¼€å‘æœ€ä½³å®è·µ](#å®‰å…¨å¼€å‘æœ€ä½³å®è·µ)

## å‰ç«¯å®‰å…¨å¨èƒæ¦‚è§ˆ

<Callout type="warning">
å‰ç«¯å®‰å…¨æ˜¯[Web](https://developer.mozilla.org/en-US/docs/Web)åº”ç”¨å®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œäº†è§£å¸¸è§å¨èƒå’Œé˜²æŠ¤æªæ–½å¯¹äºæ„å»ºå®‰å…¨çš„Webåº”ç”¨è‡³å…³é‡è¦ã€‚
</Callout>

### å¸¸è§å®‰å…¨å¨èƒåˆ†ç±»

#### å‰ç«¯å®‰å…¨å¨èƒæ¦‚è§ˆ

| å¨èƒç±»å‹ | å¸¸è§å½¢å¼ | å½±å“ | é˜²æŠ¤æªæ–½ |
|----------|----------|------|----------|
| **æ³¨å…¥æ”»å‡»** | XSSã€SQLæ³¨å…¥ã€ä»£ç æ³¨å…¥ | æ•°æ®æ³„éœ²ã€ä¼šè¯åŠ«æŒ | è¾“å…¥éªŒè¯ã€è¾“å‡ºç¼–ç ã€CSP |
| **èº«ä»½è®¤è¯ç¼ºé™·** | å¼±å¯†ç ã€ä¼šè¯åŠ«æŒã€æš´åŠ›ç ´è§£ | è´¦æˆ·è¢«ç›—ã€æœªæˆæƒè®¿é—® | å¼ºå¯†ç ç­–ç•¥ã€MFAã€ä¼šè¯ç®¡ç† |
| **æ•æ„Ÿæ•°æ®æš´éœ²** | æ˜æ–‡ä¼ è¾“ã€ä¸å½“å­˜å‚¨ã€ç¼“å­˜æ³„éœ² | éšç§æ³„éœ²ã€åˆè§„é£é™© | HTTPSã€æ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶ |
| **CSRFæ”»å‡»** | è·¨ç«™è¯·æ±‚ä¼ªé€  | æ¶æ„æ“ä½œã€æ•°æ®ç¯¡æ”¹ | CSRF Tokenã€SameSite Cookie |
| **å®‰å…¨é…ç½®é”™è¯¯** | é»˜è®¤é…ç½®ã€æƒé™é”™è¯¯ã€ä¿¡æ¯æ³„éœ² | ç³»ç»Ÿæš´éœ²ã€æ”»å‡»é¢æ‰©å¤§ | å®‰å…¨é…ç½®æ£€æŸ¥ã€æœ€å°æƒé™åŸåˆ™ |

#### å®‰å…¨å¨èƒä¸¥é‡ç¨‹åº¦

| ä¸¥é‡ç¨‹åº¦ | æè¿° | ç¤ºä¾‹ | å¤„ç†ä¼˜å…ˆçº§ |
|----------|------|------|------------|
| **ä¸¥é‡** | å¯ç›´æ¥è·å–ç³»ç»Ÿæ§åˆ¶æƒ | è¿œç¨‹ä»£ç æ‰§è¡Œã€SQLæ³¨å…¥ | ç«‹å³ä¿®å¤ |
| **é«˜** | å¯è·å–æ•æ„Ÿæ•°æ® | XSSã€CSRFã€æ•°æ®æ³„éœ² | 24å°æ—¶å†…ä¿®å¤ |
| **ä¸­** | å¯å½±å“ç³»ç»Ÿå¯ç”¨æ€§ | æ‹’ç»æœåŠ¡ã€ä¿¡æ¯æ³„éœ² | 1å‘¨å†…ä¿®å¤ |
| **ä½** | å½±å“æœ‰é™ | é…ç½®é—®é¢˜ã€å¼±åŠ å¯† | 1ä¸ªæœˆå†…ä¿®å¤ |

#### å®‰å…¨è¯„ä¼°æµç¨‹

| è¯„ä¼°é˜¶æ®µ | æ£€æŸ¥é¡¹ç›® | å·¥å…·/æ–¹æ³• | é¢‘ç‡ |
|----------|----------|-----------|------|
| **ä»£ç å®¡æŸ¥** | XSSã€CSRFã€æ³¨å…¥æ¼æ´ | ESLint Securityã€äººå·¥å®¡æŸ¥ | æ¯æ¬¡æäº¤ |
| **ä¾èµ–æ‰«æ** | å·²çŸ¥æ¼æ´ã€è¿‡æœŸä¾èµ– | npm auditã€Snyk | æ¯æ—¥ |
| **é…ç½®æ£€æŸ¥** | å®‰å…¨å¤´ã€CSPã€HTTPS | Security Headerså·¥å…· | æ¯å‘¨ |
| **æ¸—é€æµ‹è¯•** | ç»¼åˆå®‰å…¨è¯„ä¼° | OWASP ZAPã€ä¸“ä¸šæµ‹è¯• | æ¯æœˆ |

```javascript
// ç®€åŒ–çš„å®‰å…¨æ£€æŸ¥ç¤ºä¾‹
class SimpleSecurityChecker {
  static checkBasicSecurity() {
    const checks = {
      https: location.protocol === 'https:',
      csp: !!document.querySelector('meta[http-equiv*="Content-Security-Policy"]'),
      xFrameOptions: this.hasSecurityHeader('X-Frame-Options'),
      noSniff: this.hasSecurityHeader('X-Content-Type-Options')
    };

    const score = Object.values(checks).filter(Boolean).length;
    return { checks, score: (score / 4) * 100 };
  }

  static hasSecurityHeader(header) {
    // ç®€åŒ–æ£€æŸ¥ï¼Œå®é™…éœ€è¦æ£€æŸ¥HTTPå“åº”å¤´
    return document.querySelector(`meta[http-equiv="${header}"]`) !== null;
  }
}


```

## XSSæ”»å‡»é˜²æŠ¤

<Callout type="warning">
XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰æ˜¯æœ€å¸¸è§çš„Webå®‰å…¨å¨èƒä¹‹ä¸€ï¼Œé€šè¿‡æ³¨å…¥æ¶æ„è„šæœ¬æ¥çªƒå–ç”¨æˆ·ä¿¡æ¯æˆ–æ‰§è¡Œæ¶æ„æ“ä½œã€‚
</Callout>

### XSSæ”»å‡»ç±»å‹

| ç±»å‹ | æè¿° | ç¤ºä¾‹ | é˜²æŠ¤æ–¹æ³• |
|------|------|------|----------|
| **å­˜å‚¨å‹XSS** | æ¶æ„è„šæœ¬å­˜å‚¨åœ¨æœåŠ¡å™¨ | è¯„è®ºã€ç•™è¨€æ¿ | æœåŠ¡ç«¯è¿‡æ»¤ã€è¾“å‡ºç¼–ç  |
| **åå°„å‹XSS** | æ¶æ„è„šæœ¬é€šè¿‡URLå‚æ•°ä¼ é€’ | æœç´¢ç»“æœé¡µé¢ | è¾“å…¥éªŒè¯ã€è¾“å‡ºç¼–ç  |
| **DOMå‹XSS** | å®¢æˆ·ç«¯è„šæœ¬ç›´æ¥æ“ä½œDOM | innerHTMLèµ‹å€¼ | é¿å…å±é™©APIã€ä½¿ç”¨å®‰å…¨æ–¹æ³• |

### XSSé˜²æŠ¤ç­–ç•¥

#### è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 

| é˜²æŠ¤å±‚é¢ | æ–¹æ³• | å®æ–½ä½ç½® | æ•ˆæœ |
|----------|------|----------|------|
| **è¾“å…¥éªŒè¯** | ç™½åå•è¿‡æ»¤ã€é•¿åº¦é™åˆ¶ | å®¢æˆ·ç«¯+æœåŠ¡ç«¯ | é˜»æ­¢æ¶æ„è¾“å…¥ |
| **è¾“å‡ºç¼–ç ** | HTMLå®ä½“ç¼–ç  | æ¨¡æ¿å¼•æ“ | é˜²æ­¢è„šæœ¬æ‰§è¡Œ |
| **CSPç­–ç•¥** | å†…å®¹å®‰å…¨ç­–ç•¥ | HTTPå¤´ | é™åˆ¶è„šæœ¬æ¥æº |
| **å®‰å…¨API** | textContentæ›¿ä»£innerHTML | å®¢æˆ·ç«¯ä»£ç  | é¿å…HTMLè§£æ |

#### ç®€åŒ–çš„XSSé˜²æŠ¤å®ç°

```javascript
// ç®€å•çš„XSSé˜²æŠ¤å·¥å…·
class SimpleXSSProtection {
  // HTMLå®ä½“ç¼–ç 
  static escapeHTML(str) {
    const entityMap = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    };

    return String(str).replace(/[&<>"'/]/g, (s) => entityMap[s]);
  }

  // å®‰å…¨åœ°è®¾ç½®æ–‡æœ¬å†…å®¹
  static safeSetText(element, text) {
    element.textContent = text; // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTML
  }

  // å®‰å…¨åœ°è®¾ç½®HTMLå†…å®¹ï¼ˆä½¿ç”¨DOMPurifyç­‰åº“ï¼‰
  static safeSetHTML(element, html) {
    // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨DOMPurifyåº“
    element.innerHTML = this.escapeHTML(html);
  }
```

### å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)

CSPæ˜¯é˜²æ­¢XSSæ”»å‡»çš„é‡è¦å®‰å…¨æœºåˆ¶ï¼Œé€šè¿‡é™åˆ¶èµ„æºåŠ è½½æ¥æºæ¥é˜²æ­¢æ¶æ„è„šæœ¬æ‰§è¡Œã€‚

#### CSPé…ç½®ç¤ºä¾‹

| æŒ‡ä»¤ | ä½œç”¨ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|------|------|--------|------|
| **default-src** | é»˜è®¤èµ„æºç­–ç•¥ | 'self' | åªå…è®¸åŒæºèµ„æº |
| **script-src** | è„šæœ¬èµ„æºç­–ç•¥ | 'self' 'unsafe-inline' | å…è®¸åŒæºå’Œå†…è”è„šæœ¬ |
| **style-src** | æ ·å¼èµ„æºç­–ç•¥ | 'self' 'unsafe-inline' | å…è®¸åŒæºå’Œå†…è”æ ·å¼ |
| **img-src** | å›¾ç‰‡èµ„æºç­–ç•¥ | 'self' data: https: | å…è®¸åŒæºã€dataå’ŒHTTPSå›¾ç‰‡ |

```html
<!-- CSPé…ç½®ç¤ºä¾‹ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline' https://cdn.example.com;
               style-src 'self' 'unsafe-inline';
               img-src 'self' data: https:;">
```

```javascript
// åŠ¨æ€è®¾ç½®CSP
function setCSP() {
  const meta = document.createElement('meta');
  meta.httpEquiv = 'Content-Security-Policy';
  meta.content = "default-src 'self'; script-src 'self' 'unsafe-inline'";
  document.head.appendChild(meta);
```

## CSRFæ”»å‡»é˜²æŠ¤

<Callout type="warning">
CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ”»å‡»é€šè¿‡è¯±å¯¼ç”¨æˆ·åœ¨å·²è®¤è¯çš„ç½‘ç«™ä¸Šæ‰§è¡Œéé¢„æœŸçš„æ“ä½œï¼Œæ˜¯å¸¸è§çš„Webå®‰å…¨å¨èƒã€‚
</Callout>

### CSRFæ”»å‡»åŸç†

| æ”»å‡»æ­¥éª¤ | æè¿° | ç¤ºä¾‹ |
|----------|------|------|
| **1. ç”¨æˆ·ç™»å½•** | ç”¨æˆ·ç™»å½•ç›®æ ‡ç½‘ç«™ | é“¶è¡Œç½‘ç«™ã€ç¤¾äº¤å¹³å° |
| **2. è·å–å‡­è¯** | æµè§ˆå™¨ä¿å­˜è®¤è¯ä¿¡æ¯ | Session Cookie |
| **3. è®¿é—®æ¶æ„ç½‘ç«™** | ç”¨æˆ·è®¿é—®æ”»å‡»è€…ç½‘ç«™ | é’“é±¼é‚®ä»¶ã€æ¶æ„é“¾æ¥ |
| **4. å‘èµ·è¯·æ±‚** | æ¶æ„ç½‘ç«™å‘ç›®æ ‡ç½‘ç«™å‘è¯·æ±‚ | è½¬è´¦ã€ä¿®æ”¹å¯†ç  |
| **5. è‡ªåŠ¨è®¤è¯** | æµè§ˆå™¨è‡ªåŠ¨æºå¸¦å‡­è¯ | Cookieè‡ªåŠ¨å‘é€ |

### CSRFé˜²æŠ¤ç­–ç•¥

#### é˜²æŠ¤æ–¹æ³•å¯¹æ¯”

| é˜²æŠ¤æ–¹æ³• | å®‰å…¨æ€§ | å®æ–½éš¾åº¦ | ç”¨æˆ·ä½“éªŒ | é€‚ç”¨åœºæ™¯ |
|----------|--------|----------|----------|----------|
| **CSRF Token** | é«˜ | ä¸­ | å¥½ | è¡¨å•æäº¤ |
| **SameSite Cookie** | é«˜ | ä½ | å¥½ | ç°ä»£æµè§ˆå™¨ |
| **åŒé‡æäº¤Cookie** | ä¸­ | ä½ | å¥½ | APIæ¥å£ |
| **éªŒè¯Referer** | ä½ | ä½ | å¥½ | è¾…åŠ©éªŒè¯ |

#### ç®€åŒ–çš„CSRFé˜²æŠ¤å®ç°

```javascript
// ç®€å•çš„CSRFé˜²æŠ¤å·¥å…·
class SimpleCSRFProtection {
  // ç”ŸæˆCSRF Token
  static generateToken() {
    return Math.random().toString(36).substring(2) + Date.now().toString(36);
  }

  // è®¾ç½®CSRF Tokenåˆ°è¡¨å•
  static addTokenToForm(form) {
    const token = this.generateToken();
    sessionStorage.setItem('csrf_token', token);

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'csrf_token';
    input.value = token;
    form.appendChild(input);
  }

  // éªŒè¯CSRF Token
  static validateToken(submittedToken) {
    const storedToken = sessionStorage.getItem('csrf_token');
    return submittedToken === storedToken;
  }
```

### SameSite Cookieé…ç½®

SameSiteå±æ€§æ˜¯é˜²æ­¢CSRFæ”»å‡»çš„ç°ä»£æ–¹æ³•ï¼Œé€šè¿‡é™åˆ¶Cookieçš„è·¨ç«™å‘é€æ¥æä¾›ä¿æŠ¤ã€‚

#### SameSiteå±æ€§å€¼

| å€¼ | è¡Œä¸º | å®‰å…¨æ€§ | å…¼å®¹æ€§ | é€‚ç”¨åœºæ™¯ |
|----|------|--------|--------|----------|
| **Strict** | å®Œå…¨ç¦æ­¢è·¨ç«™å‘é€ | æœ€é«˜ | å¥½ | é«˜å®‰å…¨è¦æ±‚ |
| **Lax** | å¯¼èˆªè¯·æ±‚å¯å‘é€ | é«˜ | å¥½ | å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ |
| **None** | å…è®¸è·¨ç«™å‘é€ | ä½ | éœ€HTTPS | ç¬¬ä¸‰æ–¹é›†æˆ |

```javascript
// è®¾ç½®å®‰å…¨çš„Cookie
function setSecureCookie(name, value, options = {}) {
  const defaults = {
    secure: true,        // ä»…HTTPSä¼ è¾“
    httpOnly: true,      // é˜²æ­¢XSSè®¿é—®
    sameSite: 'Lax',     // é˜²æ­¢CSRF
    maxAge: 3600         // 1å°æ—¶è¿‡æœŸ
  };

  const config = { ...defaults, ...options };
  const cookieString = `${name}=${value}; ${Object.entries(config)
    .map(([key, val]) => `${key}=${val}`)
    .join('; ')}`;

  document.cookie = cookieString;
```

## å†…å®¹å®‰å…¨ç­–ç•¥CSP

<Callout type="info">
å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆContent Security Policy, CSPï¼‰æ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨å±‚ï¼Œç”¨äºæ£€æµ‹å’Œå‡è½»æŸäº›ç±»å‹çš„æ”»å‡»ï¼ŒåŒ…æ‹¬è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰å’Œæ•°æ®æ³¨å…¥æ”»å‡»ã€‚
</Callout>

### CSPåŸºç¡€æ¦‚å¿µ

CSPé€šè¿‡æŒ‡å®šæµè§ˆå™¨åº”è¯¥ä¿¡ä»»çš„å†…å®¹æ¥æºï¼Œå¸®åŠ©é˜²æ­¢æ¶æ„å†…å®¹çš„æ‰§è¡Œã€‚

#### CSPæŒ‡ä»¤ç±»å‹

| æŒ‡ä»¤ | ä½œç”¨ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| **default-src** | é»˜è®¤ç­–ç•¥ | 'self' | ä¸ºå…¶ä»–æŒ‡ä»¤æä¾›é»˜è®¤å€¼ |
| **script-src** | è„šæœ¬æ¥æº | 'self' 'unsafe-inline' | æ§åˆ¶JavaScriptæ‰§è¡Œ |
| **style-src** | æ ·å¼æ¥æº | 'self' 'unsafe-inline' | æ§åˆ¶CSSåŠ è½½ |
| **img-src** | å›¾ç‰‡æ¥æº | 'self' data: https: | æ§åˆ¶å›¾ç‰‡èµ„æº |
| **connect-src** | è¿æ¥æ¥æº | 'self' https://api.example.com | æ§åˆ¶Ajaxã€WebSocketç­‰ |
| **font-src** | å­—ä½“æ¥æº | 'self' https://fonts.googleapis.com | æ§åˆ¶å­—ä½“èµ„æº |
| **object-src** | å¯¹è±¡æ¥æº | 'none' | æ§åˆ¶æ’ä»¶ï¼ˆFlashç­‰ï¼‰ |
| **media-src** | åª’ä½“æ¥æº | 'self' | æ§åˆ¶éŸ³è§†é¢‘èµ„æº |

#### CSPå€¼ç±»å‹

| å€¼ | å«ä¹‰ | å®‰å…¨æ€§ | ä½¿ç”¨åœºæ™¯ |
|----|------|--------|----------|
| **'none'** | ç¦æ­¢æ‰€æœ‰æ¥æº | æœ€é«˜ | å®Œå…¨ç¦ç”¨æŸç±»èµ„æº |
| **'self'** | åŒæºç­–ç•¥ | é«˜ | åªå…è®¸åŒæºèµ„æº |
| **'unsafe-inline'** | å…è®¸å†…è” | ä½ | å…¼å®¹å†…è”è„šæœ¬/æ ·å¼ |
| **'unsafe-eval'** | å…è®¸eval | æä½ | å…¼å®¹åŠ¨æ€ä»£ç æ‰§è¡Œ |
| **åŸŸå** | æŒ‡å®šåŸŸå | ä¸­ | ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹åŸŸå |
| **'nonce-xxx'** | éšæœºæ•°éªŒè¯ | é«˜ | åŠ¨æ€å†…è”å†…å®¹ |
| **'sha256-xxx'** | å“ˆå¸ŒéªŒè¯ | é«˜ | é™æ€å†…è”å†…å®¹ |

### CSPé…ç½®å®è·µ

#### æ¸è¿›å¼CSPéƒ¨ç½²

| é˜¶æ®µ | ç­–ç•¥ | ç›®æ ‡ | é£é™© |
|------|------|------|------|
| **1. ç›‘æ§æ¨¡å¼** | Report-Only | æ”¶é›†è¿è§„æŠ¥å‘Š | æ—  |
| **2. å®½æ¾ç­–ç•¥** | å…è®¸unsafe-inline | ç¡®ä¿åŠŸèƒ½æ­£å¸¸ | ä¸­ |
| **3. ä¸¥æ ¼ç­–ç•¥** | ç¦ç”¨unsafe-inline | æé«˜å®‰å…¨æ€§ | é«˜ |
| **4. æœ€ä¸¥ç­–ç•¥** | ä½¿ç”¨nonce/hash | æœ€å¤§å®‰å…¨æ€§ | æœ€é«˜ |

```html
<!-- é˜¶æ®µ1ï¼šç›‘æ§æ¨¡å¼ -->
<meta http-equiv="Content-Security-Policy-Report-Only"
      content="default-src 'self'; report-uri /csp-report">

<!-- é˜¶æ®µ2ï¼šå®½æ¾ç­–ç•¥ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline' https://cdn.example.com;
               style-src 'self' 'unsafe-inline';">

<!-- é˜¶æ®µ3ï¼šä¸¥æ ¼ç­–ç•¥ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' https://cdn.example.com;
               style-src 'self';">
```

#### åŠ¨æ€CSPç®¡ç†

```javascript
// CSPç®¡ç†å·¥å…·
class CSPManager {
  constructor() {
    this.policies = new Map();
    this.nonces = new Map();
  }

  // ç”Ÿæˆéšæœºnonce
  generateNonce() {
    const array = new Uint8Array(16);
    crypto.getRandomValues(array);
    return btoa(String.fromCharCode.apply(null, array));
  }

  // è®¾ç½®é¡µé¢çº§CSP
  setPageCSP(policies) {
    const cspString = Object.entries(policies)
      .map(([directive, sources]) => {
        const sourceList = Array.isArray(sources) ? sources.join(' ') : sources;
        return `${directive} ${sourceList}`;
      })
      .join('; ');

    const meta = document.createElement('meta');
    meta.httpEquiv = 'Content-Security-Policy';
    meta.content = cspString;
    document.head.appendChild(meta);
  }

  // ä¸ºå†…è”è„šæœ¬ç”Ÿæˆnonce
  createInlineScript(code, nonce = null) {
    if (!nonce) {
      nonce = this.generateNonce();
    }

    const script = document.createElement('script');
    script.nonce = nonce;
    script.textContent = code;

    return { script, nonce };
  }

  // éªŒè¯CSPè¿è§„
  handleCSPViolation(event) {
    const violation = {
      documentURI: event.documentURI,
      violatedDirective: event.violatedDirective,
      blockedURI: event.blockedURI,
      lineNumber: event.lineNumber,
      sourceFile: event.sourceFile,
      timestamp: Date.now()
    };

    // å‘é€è¿è§„æŠ¥å‘Š
    this.reportViolation(violation);
  }

  // å‘é€è¿è§„æŠ¥å‘Š
  async reportViolation(violation) {
    try {
      await fetch('/api/csp-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(violation)
      });
    } catch (error) {
      console.error('Failed to report CSP violation:', error);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cspManager = new CSPManager();

// è®¾ç½®ä¸¥æ ¼çš„CSPç­–ç•¥
cspManager.setPageCSP({
  'default-src': "'self'",
  'script-src': "'self' 'nonce-abc123'",
  'style-src': "'self' 'unsafe-inline'",
  'img-src': "'self' data: https:",
  'connect-src': "'self' https://api.example.com"
});

// ç›‘å¬CSPè¿è§„äº‹ä»¶
document.addEventListener('securitypolicyviolation', (event) => {
  cspManager.handleCSPViolation(event);
});
```

### CSPæœ€ä½³å®è·µ

#### å¸¸è§CSPé…ç½®æ¨¡æ¿

```javascript
// CSPé…ç½®æ¨¡æ¿
const CSPTemplates = {
  // ä¸¥æ ¼æ¨¡å¼ - æœ€é«˜å®‰å…¨æ€§
  strict: {
    'default-src': "'none'",
    'script-src': "'self'",
    'style-src': "'self'",
    'img-src': "'self' data:",
    'font-src': "'self'",
    'connect-src': "'self'",
    'object-src': "'none'",
    'base-uri': "'self'",
    'form-action': "'self'"
  },

  // å¹³è¡¡æ¨¡å¼ - å®‰å…¨æ€§ä¸å…¼å®¹æ€§å¹³è¡¡
  balanced: {
    'default-src': "'self'",
    'script-src': "'self' 'unsafe-inline' https://cdn.jsdelivr.net",
    'style-src': "'self' 'unsafe-inline' https://fonts.googleapis.com",
    'img-src': "'self' data: https:",
    'font-src': "'self' https://fonts.gstatic.com",
    'connect-src': "'self' https://api.example.com"
  },

  // å®½æ¾æ¨¡å¼ - å…¼å®¹æ€§ä¼˜å…ˆ
  permissive: {
    'default-src': "'self'",
    'script-src': "'self' 'unsafe-inline' 'unsafe-eval'",
    'style-src': "'self' 'unsafe-inline'",
    'img-src': "*",
    'font-src': "*"
  }
};
```

## æ•°æ®ä¼ è¾“å®‰å…¨

<Callout type="warning">
æ•°æ®ä¼ è¾“å®‰å…¨æ˜¯Webåº”ç”¨å®‰å…¨çš„åŸºç¡€ï¼ŒåŒ…æ‹¬HTTPSé…ç½®ã€æ•°æ®åŠ å¯†å’Œå®‰å…¨é€šä¿¡åè®®çš„å®æ–½ã€‚
</Callout>

### HTTPSé…ç½®æœ€ä½³å®è·µ

#### SSL/TLSé…ç½®

| é…ç½®é¡¹ | æ¨èå€¼ | å®‰å…¨çº§åˆ« | è¯´æ˜ |
|--------|--------|----------|------|
| **TLSç‰ˆæœ¬** | TLS 1.2+ | é«˜ | ç¦ç”¨TLS 1.0/1.1 |
| **åŠ å¯†å¥—ä»¶** | AEADä¼˜å…ˆ | é«˜ | ä½¿ç”¨ç°ä»£åŠ å¯†ç®—æ³• |
| **å¯†é’¥é•¿åº¦** | RSA 2048+, ECDSA 256+ | é«˜ | è¶³å¤Ÿçš„å¯†é’¥å¼ºåº¦ |
| **è¯ä¹¦ç±»å‹** | EV/OVè¯ä¹¦ | ä¸­ | å¢å¼ºç”¨æˆ·ä¿¡ä»» |

#### å®‰å…¨å¤´é…ç½®

```javascript
// å®‰å…¨å¤´é…ç½®
const SecurityHeaders = {
  // å¼ºåˆ¶HTTPS
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',

  // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
  'X-Frame-Options': 'DENY',

  // é˜²æ­¢MIMEç±»å‹å—…æ¢
  'X-Content-Type-Options': 'nosniff',

  // XSSä¿æŠ¤
  'X-XSS-Protection': '1; mode=block',

  // å¼•ç”¨ç­–ç•¥
  'Referrer-Policy': 'strict-origin-when-cross-origin',

  // æƒé™ç­–ç•¥
  'Permissions-Policy': 'geolocation=(), microphone=(), camera=()'
};

// æ£€æŸ¥å®‰å…¨å¤´
class SecurityHeaderChecker {
  static async checkHeaders(url) {
    try {
      const response = await fetch(url, { method: 'HEAD' });
      const headers = {};

      for (const [key, value] of response.headers.entries()) {
        headers[key] = value;
      }

      return this.analyzeHeaders(headers);
    } catch (error) {
      return { error: error.message };
    }
  }

  static analyzeHeaders(headers) {
    const analysis = {
      score: 0,
      maxScore: 0,
      details: {}
    };

    const checks = [
      {
        name: 'HTTPS Enforcement',
        header: 'strict-transport-security',
        weight: 20,
        check: (value) => value && value.includes('max-age')
      },
      {
        name: 'Clickjacking Protection',
        header: 'x-frame-options',
        weight: 15,
        check: (value) => value && (value.includes('DENY') || value.includes('SAMEORIGIN'))
      },
      {
        name: 'MIME Sniffing Protection',
        header: 'x-content-type-options',
        weight: 10,
        check: (value) => value === 'nosniff'
      },
      {
        name: 'XSS Protection',
        header: 'x-xss-protection',
        weight: 10,
        check: (value) => value && value.includes('1')
      },
      {
        name: 'Content Security Policy',
        header: 'content-security-policy',
        weight: 25,
        check: (value) => value && value.length > 0
      }
    ];

    checks.forEach(check => {
      analysis.maxScore += check.weight;
      const headerValue = headers[check.header];
      const passed = check.check(headerValue);

      if (passed) {
        analysis.score += check.weight;
      }

      analysis.details[check.name] = {
        passed,
        value: headerValue || 'Not set',
        weight: check.weight
      };
    });

    analysis.grade = this.calculateGrade(analysis.score, analysis.maxScore);
    return analysis;
  }

  static calculateGrade(score, maxScore) {
    const percentage = (score / maxScore) * 100;
    if (percentage >= 90) return 'A';
    if (percentage >= 80) return 'B';
    if (percentage >= 70) return 'C';
    if (percentage >= 60) return 'D';
    return 'F';
  }
}
```

## æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨

<Callout type="info">
å‰ç«¯æ•°æ®åŠ å¯†ä¸»è¦ç”¨äºæ•æ„Ÿä¿¡æ¯çš„ä¸´æ—¶ä¿æŠ¤ï¼ŒçœŸæ­£çš„å®‰å…¨åº”è¯¥ä¾èµ–æœåŠ¡ç«¯åŠ å¯†å’ŒHTTPSä¼ è¾“ã€‚
</Callout>

### å‰ç«¯åŠ å¯†åœºæ™¯

| åœºæ™¯ | åŠ å¯†ç›®çš„ | æ¨èæ–¹æ¡ˆ | å®‰å…¨çº§åˆ« |
|------|----------|----------|----------|
| **æœ¬åœ°å­˜å‚¨** | é˜²æ­¢æœ¬åœ°æ•°æ®æ³„éœ² | AES-GCM | ä¸­ |
| **ä¼ è¾“å‰åŠ å¯†** | é¢å¤–ä¼ è¾“ä¿æŠ¤ | RSA + AES | é«˜ |
| **å¯†ç å¤„ç†** | å®¢æˆ·ç«¯é¢„å¤„ç† | bcrypt, PBKDF2 | é«˜ |
| **Tokenä¿æŠ¤** | é˜²æ­¢XSSçªƒå– | åŠ å¯†å­˜å‚¨ | ä¸­ |

### Web Crypto APIä½¿ç”¨

ç°ä»£æµè§ˆå™¨æä¾›äº†Web Crypto APIç”¨äºåŠ å¯†æ“ä½œï¼Œæ¯”è‡ªå®šä¹‰å®ç°æ›´å®‰å…¨ã€‚

#### åŠ å¯†ç®—æ³•å¯¹æ¯”

| ç®—æ³• | ç±»å‹ | å¯†é’¥é•¿åº¦ | æ€§èƒ½ | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|------|--------|----------|
| **AES-GCM** | å¯¹ç§°åŠ å¯† | 128/256ä½ | é«˜ | é«˜ | æ•°æ®åŠ å¯† |
| **RSA-OAEP** | éå¯¹ç§°åŠ å¯† | 2048/4096ä½ | ä½ | é«˜ | å¯†é’¥äº¤æ¢ |
| **ECDSA** | æ•°å­—ç­¾å | 256/384ä½ | ä¸­ | é«˜ | èº«ä»½éªŒè¯ |
| **PBKDF2** | å¯†é’¥æ´¾ç”Ÿ | å¯å˜ | ä½ | é«˜ | å¯†ç å¤„ç† |

#### ç®€åŒ–çš„åŠ å¯†å·¥å…·

```javascript
// ç®€å•çš„å‰ç«¯åŠ å¯†å·¥å…·
class SimpleCrypto {
  // ç”Ÿæˆéšæœºå¯†é’¥
  static async generateKey() {
    return await crypto.subtle.generateKey(
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }

  // åŠ å¯†æ•°æ®
  static async encrypt(data, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedData = new TextEncoder().encode(data);

    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      encodedData
    );

    return { encrypted, iv };
  }

  // è§£å¯†æ•°æ®
  static async decrypt(encryptedData, key, iv) {
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      encryptedData
    );

    return new TextDecoder().decode(decrypted);
  }
```

### å®‰å…¨å­˜å‚¨æ–¹æ¡ˆ

| å­˜å‚¨æ–¹å¼ | å®‰å…¨æ€§ | æŒä¹…æ€§ | å®¹é‡ | é€‚ç”¨æ•°æ® |
|----------|--------|--------|------|----------|
| **Memory** | æœ€é«˜ | ä¼šè¯æœŸé—´ | æ— é™åˆ¶ | ä¸´æ—¶æ•æ„Ÿæ•°æ® |
| **SessionStorage** | é«˜ | æ ‡ç­¾é¡µæœŸé—´ | 5-10MB | ä¼šè¯æ•°æ® |
| **LocalStorage** | ä¸­ | æ°¸ä¹… | 5-10MB | ç”¨æˆ·åå¥½ |
| **IndexedDB** | ä¸­ | æ°¸ä¹… | å¤§å®¹é‡ | ç¦»çº¿æ•°æ® |
| **Cookie** | ä½ | å¯è®¾ç½® | 4KB | è®¤è¯ä¿¡æ¯ |

```javascript
// å®‰å…¨å­˜å‚¨å·¥å…·
class SecureStorage {
  // åŠ å¯†å­˜å‚¨åˆ°localStorage
  static async setEncrypted(key, data, password) {
    const cryptoKey = await this.deriveKey(password);
    const { encrypted, iv } = await SimpleCrypto.encrypt(JSON.stringify(data), cryptoKey);

    localStorage.setItem(key, JSON.stringify({
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    }));
  }

  // ä»localStorageè§£å¯†è¯»å–
  static async getEncrypted(key, password) {
    const stored = localStorage.getItem(key);
    if (!stored) return null;

    const { data, iv } = JSON.parse(stored);
    const cryptoKey = await this.deriveKey(password);

    const decrypted = await SimpleCrypto.decrypt(
      new Uint8Array(data),
      cryptoKey,
      new Uint8Array(iv)
    );

    return JSON.parse(decrypted);
  }

  // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
  static async deriveKey(password) {
    const encoder = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      encoder.encode(password),
      'PBKDF2',
      false,
      ['deriveKey']
    );

    return await crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt: encoder.encode('salt'), // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨éšæœºsalt
        iterations: 100000,
        hash: 'SHA-256'
      },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  }
```

## èº«ä»½è®¤è¯ä¸æˆæƒ

<Callout type="info">
å‰ç«¯èº«ä»½è®¤è¯ä¸»è¦è´Ÿè´£ç”¨æˆ·ç•Œé¢çš„è®¿é—®æ§åˆ¶ï¼ŒçœŸæ­£çš„å®‰å…¨éªŒè¯åº”è¯¥åœ¨æœåŠ¡ç«¯è¿›è¡Œã€‚
</Callout>

### è®¤è¯æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | å¤æ‚åº¦ | æ‰©å±•æ€§ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|--------|----------|
| **Session Cookie** | é«˜ | ä½ | ä¸­ | ä¼ ç»ŸWebåº”ç”¨ |
| **JWT Token** | ä¸­ | ä¸­ | é«˜ | SPAã€API |
| **OAuth 2.0** | é«˜ | é«˜ | é«˜ | ç¬¬ä¸‰æ–¹ç™»å½• |
| **WebAuthn** | æœ€é«˜ | é«˜ | ä¸­ | æ— å¯†ç è®¤è¯ |

### Tokenç®¡ç†æœ€ä½³å®è·µ

#### Tokenå­˜å‚¨ç­–ç•¥

| å­˜å‚¨ä½ç½® | å®‰å…¨æ€§ | XSSé£é™© | CSRFé£é™© | æ¨èåº¦ |
|----------|--------|---------|----------|--------|
| **Memory** | æœ€é«˜ | æ—  | æ—  | â­â­â­â­â­ |
| **HttpOnly Cookie** | é«˜ | æ—  | æœ‰ | â­â­â­â­ |
| **LocalStorage** | ä½ | æœ‰ | æ—  | â­â­ |
| **SessionStorage** | ä¸­ | æœ‰ | æ—  | â­â­â­ |

#### ç®€åŒ–çš„è®¤è¯ç®¡ç†

```javascript
// ç®€å•çš„è®¤è¯ç®¡ç†å™¨
class SimpleAuthManager {
  constructor() {
    this.token = null;
    this.user = null;
    this.refreshTimer = null;
  }

  // ç™»å½•
  async login(credentials) {
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credentials)
      });

      if (response.ok) {
        const data = await response.json();
        this.setAuth(data.token, data.user);
        return { success: true, user: data.user };
      }

      return { success: false, error: 'Invalid credentials' };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // è®¾ç½®è®¤è¯ä¿¡æ¯
  setAuth(token, user) {
    this.token = token;
    this.user = user;
    this.scheduleRefresh();
  }

  // ç™»å‡º
  logout() {
    this.token = null;
    this.user = null;
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
    }
  }

  // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
  isAuthenticated() {
    return !!this.token && !!this.user;
  }

  // è·å–å½“å‰ç”¨æˆ·
  getCurrentUser() {
    return this.user;
  }

  // å®šæ—¶åˆ·æ–°token
  scheduleRefresh() {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
    }

    // 15åˆ†é’Ÿååˆ·æ–°
    this.refreshTimer = setTimeout(() => {
      this.refreshToken();
    }, 15 * 60 * 1000);
  }

  // åˆ·æ–°token
  async refreshToken() {
    try {
      const response = await fetch('/api/auth/refresh', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        this.setAuth(data.token, data.user);
      } else {
        this.logout();
      }
    } catch (error) {
      console.error('Token refresh failed:', error);
      this.logout();
    }
  }
```

### æƒé™æ§åˆ¶

å‰ç«¯æƒé™æ§åˆ¶ä¸»è¦ç”¨äºç”¨æˆ·ç•Œé¢çš„æ˜¾ç¤ºé€»è¾‘ï¼Œä¸èƒ½æ›¿ä»£æœåŠ¡ç«¯çš„æƒé™éªŒè¯ã€‚

#### æƒé™æ¨¡å‹

| æ¨¡å‹ | æè¿° | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|------|------|----------|--------|
| **RBAC** | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ | ä¼ä¸šåº”ç”¨ | ä¸­ |
| **ABAC** | åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ | å¤æ‚æƒé™åœºæ™¯ | é«˜ |
| **ACL** | è®¿é—®æ§åˆ¶åˆ—è¡¨ | ç®€å•æƒé™åœºæ™¯ | ä½ |

```javascript
// ç®€å•çš„æƒé™æ§åˆ¶
class SimplePermissionManager {
  constructor(user) {
    this.user = user;
    this.permissions = user?.permissions || [];
    this.roles = user?.roles || [];
  }

  // æ£€æŸ¥æƒé™
  hasPermission(permission) {
    return this.permissions.includes(permission);
  }

  // æ£€æŸ¥è§’è‰²
  hasRole(role) {
    return this.roles.includes(role);
  }

  // æ£€æŸ¥å¤šä¸ªæƒé™ï¼ˆä»»ä¸€ï¼‰
  hasAnyPermission(permissions) {
    return permissions.some(p => this.hasPermission(p));
  }

  // æ£€æŸ¥å¤šä¸ªæƒé™ï¼ˆå…¨éƒ¨ï¼‰
  hasAllPermissions(permissions) {
    return permissions.every(p => this.hasPermission(p));
  }
}

// Reactæƒé™ç»„ä»¶ç¤ºä¾‹
function ProtectedComponent({ permission, children }) {
  const { user } = useAuth();
  const permissionManager = new SimplePermissionManager(user);

  if (!permissionManager.hasPermission(permission)) {
    return <div>Access Denied</div>;
  }

  return children;
```

## å®‰å…¨æµ‹è¯•ä¸ç›‘æ§

<Callout type="warning">
å®‰å…¨æµ‹è¯•åº”è¯¥è´¯ç©¿æ•´ä¸ªå¼€å‘ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬é™æ€ä»£ç åˆ†æã€åŠ¨æ€æµ‹è¯•å’ŒæŒç»­ç›‘æ§ã€‚
</Callout>

### å®‰å…¨æµ‹è¯•ç±»å‹

| æµ‹è¯•ç±»å‹ | æµ‹è¯•é˜¶æ®µ | å·¥å…·ç¤ºä¾‹ | æ£€æµ‹å†…å®¹ |
|----------|----------|----------|----------|
| **é™æ€åˆ†æ** | å¼€å‘é˜¶æ®µ | ESLint Security, SonarQube | ä»£ç æ¼æ´ã€å®‰å…¨è§„åˆ™ |
| **ä¾èµ–æ‰«æ** | æ„å»ºé˜¶æ®µ | npm audit, Snyk | å·²çŸ¥æ¼æ´ã€è®¸å¯è¯ |
| **åŠ¨æ€æµ‹è¯•** | æµ‹è¯•é˜¶æ®µ | OWASP ZAP, Burp Suite | è¿è¡Œæ—¶æ¼æ´ |
| **æ¸—é€æµ‹è¯•** | ä¸Šçº¿å‰ | ä¸“ä¸šæµ‹è¯•å›¢é˜Ÿ | ç»¼åˆå®‰å…¨è¯„ä¼° |

### å®‰å…¨ç›‘æ§æŒ‡æ ‡

#### å…³é”®ç›‘æ§é¡¹

| ç›‘æ§é¡¹ | æŒ‡æ ‡ | é˜ˆå€¼å»ºè®® | å¤„ç†æ–¹å¼ |
|--------|------|----------|----------|
| **å¼‚å¸¸ç™»å½•** | å¤±è´¥æ¬¡æ•°ã€åœ°ç†ä½ç½® | 5æ¬¡/å°æ—¶ | è´¦æˆ·é”å®š |
| **XSSå°è¯•** | æ¶æ„è„šæœ¬æ£€æµ‹ | ä»»ä½•æ£€æµ‹ | ç«‹å³é˜»æ­¢ |
| **CSRFæ”»å‡»** | TokenéªŒè¯å¤±è´¥ | 10æ¬¡/å°æ—¶ | IPå°ç¦ |
| **æš´åŠ›ç ´è§£** | å¯†ç å°è¯•é¢‘ç‡ | 20æ¬¡/å°æ—¶ | éªŒè¯ç  |

#### ç®€åŒ–çš„å®‰å…¨ç›‘æ§

```javascript
// ç®€å•çš„å®‰å…¨äº‹ä»¶ç›‘æ§
class SimpleSecurityMonitor {
  constructor() {
    this.events = [];
    this.thresholds = {
      loginFailures: 5,
      xssAttempts: 1,
      csrfFailures: 10
    };
  }

  // è®°å½•å®‰å…¨äº‹ä»¶
  logEvent(type, details) {
    const event = {
      type,
      details,
      timestamp: Date.now(),
      userAgent: navigator.userAgent,
      ip: this.getClientIP()
    };

    this.events.push(event);
    this.checkThresholds(type);
    this.sendToServer(event);
  }

  // æ£€æŸ¥é˜ˆå€¼
  checkThresholds(type) {
    const recentEvents = this.getRecentEvents(type, 3600000); // 1å°æ—¶å†…
    const threshold = this.thresholds[type];

    if (threshold && recentEvents.length >= threshold) {
      this.triggerAlert(type, recentEvents.length);
    }
  }

  // è·å–æœ€è¿‘äº‹ä»¶
  getRecentEvents(type, timeWindow) {
    const cutoff = Date.now() - timeWindow;
    return this.events.filter(event =>
      event.type === type && event.timestamp > cutoff
    );
  }

  // è§¦å‘è­¦æŠ¥
  triggerAlert(type, count) {
    console.warn(`Security Alert: ${type} threshold exceeded (${count} events)`);
    // å®é™…åº”ç”¨ä¸­åº”å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  }

  // å‘é€åˆ°æœåŠ¡å™¨
  async sendToServer(event) {
    try {
      await fetch('/api/security/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(event)
      });
    } catch (error) {
      console.error('Failed to send security event:', error);
    }
  }

  // è·å–å®¢æˆ·ç«¯IPï¼ˆç®€åŒ–å®ç°ï¼‰
  getClientIP() {
    // å®é™…åº”ç”¨ä¸­éœ€è¦æœåŠ¡ç«¯é…åˆ
    return 'unknown';
  }
```

### å®‰å…¨å¼€å‘æµç¨‹

#### DevSecOpsé›†æˆ

| é˜¶æ®µ | å®‰å…¨æ´»åŠ¨ | å·¥å…· | è‡ªåŠ¨åŒ–ç¨‹åº¦ |
|------|----------|------|------------|
| **å¼€å‘** | å®‰å…¨ç¼–ç ã€ä»£ç å®¡æŸ¥ | ESLint Security | é«˜ |
| **æ„å»º** | ä¾èµ–æ‰«æã€SAST | npm audit, SonarQube | é«˜ |
| **æµ‹è¯•** | å®‰å…¨æµ‹è¯•ã€DAST | OWASP ZAP | ä¸­ |
| **éƒ¨ç½²** | é…ç½®æ£€æŸ¥ã€ç›‘æ§ | è‡ªå®šä¹‰è„šæœ¬ | ä¸­ |
| **è¿ç»´** | æŒç»­ç›‘æ§ã€åº”æ€¥å“åº” | ç›‘æ§å¹³å° | ä½ |

## å®‰å…¨å¼€å‘æœ€ä½³å®è·µ

<Callout type="success">
å®‰å…¨å¼€å‘æœ€ä½³å®è·µæ¶µç›–äº†ä»ä»£ç ç¼–å†™åˆ°éƒ¨ç½²è¿ç»´çš„å…¨ç”Ÿå‘½å‘¨æœŸï¼Œå»ºç«‹ç³»ç»Ÿæ€§çš„å®‰å…¨ä¿éšœä½“ç³»ã€‚
</Callout>

### å®‰å…¨ç¼–ç è§„èŒƒ

#### è¾“å…¥éªŒè¯åŸåˆ™

| éªŒè¯ç±»å‹ | éªŒè¯æ–¹æ³• | å®æ–½ä½ç½® | å®‰å…¨çº§åˆ« |
|----------|----------|----------|----------|
| **ç™½åå•éªŒè¯** | å…è®¸å·²çŸ¥å®‰å…¨çš„è¾“å…¥ | å®¢æˆ·ç«¯+æœåŠ¡ç«¯ | æœ€é«˜ |
| **é»‘åå•è¿‡æ»¤** | é˜»æ­¢å·²çŸ¥å±é™©çš„è¾“å…¥ | å®¢æˆ·ç«¯+æœåŠ¡ç«¯ | ä¸­ |
| **æ ¼å¼éªŒè¯** | æ£€æŸ¥æ•°æ®æ ¼å¼å’Œç±»å‹ | å®¢æˆ·ç«¯+æœåŠ¡ç«¯ | é«˜ |
| **é•¿åº¦é™åˆ¶** | é™åˆ¶è¾“å…¥æ•°æ®é•¿åº¦ | å®¢æˆ·ç«¯+æœåŠ¡ç«¯ | ä¸­ |
| **ç¼–ç è½¬æ¢** | ç»Ÿä¸€å­—ç¬¦ç¼–ç  | æœåŠ¡ç«¯ | é«˜ |

#### å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

```javascript
// å®‰å…¨ç¼–ç æ£€æŸ¥å·¥å…·
class SecureCodingChecker {
  static checkCode(code) {
    const issues = [];

    // æ£€æŸ¥å±é™©å‡½æ•°ä½¿ç”¨
    const dangerousFunctions = [
      'eval', 'Function', 'setTimeout', 'setInterval',
      'innerHTML', 'outerHTML', 'insertAdjacentHTML'
    ];

    dangerousFunctions.forEach(func => {
      const regex = new RegExp(`\\b${func}\\s*\\(`, 'g');
      const matches = code.match(regex);
      if (matches) {
        issues.push({
          type: 'dangerous-function',
          function: func,
          count: matches.length,
          severity: 'high',
          message: `ä½¿ç”¨äº†å±é™©å‡½æ•° ${func}ï¼Œå¯èƒ½å¯¼è‡´ä»£ç æ³¨å…¥`
        });
      }
    });

    // æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
    const sensitivePatterns = [
      { name: 'API Key', pattern: /api[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi },
      { name: 'Password', pattern: /password\s*[:=]\s*['"][^'"]+['"]/gi },
      { name: 'Token', pattern: /token\s*[:=]\s*['"][^'"]+['"]/gi },
      { name: 'Secret', pattern: /secret\s*[:=]\s*['"][^'"]+['"]/gi }
    ];

    sensitivePatterns.forEach(pattern => {
      const matches = code.match(pattern.pattern);
      if (matches) {
        issues.push({
          type: 'hardcoded-secret',
          pattern: pattern.name,
          count: matches.length,
          severity: 'critical',
          message: `å‘ç°ç¡¬ç¼–ç çš„${pattern.name}ï¼Œåº”ä½¿ç”¨ç¯å¢ƒå˜é‡`
        });
      }
    });

    // æ£€æŸ¥ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ
    if (code.includes('Math.random()')) {
      issues.push({
        type: 'weak-random',
        severity: 'medium',
        message: 'Math.random()ä¸é€‚ç”¨äºå®‰å…¨åœºæ™¯ï¼Œåº”ä½¿ç”¨crypto.getRandomValues()'
      });
    }

    return {
      totalIssues: issues.length,
      criticalIssues: issues.filter(i => i.severity === 'critical').length,
      highIssues: issues.filter(i => i.severity === 'high').length,
      mediumIssues: issues.filter(i => i.severity === 'medium').length,
      issues
    };
  }

  // ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
  static generateReport(checkResult) {
    const { totalIssues, criticalIssues, highIssues, mediumIssues, issues } = checkResult;

    let grade = 'A';
    if (criticalIssues > 0) grade = 'F';
    else if (highIssues > 3) grade = 'D';
    else if (highIssues > 1) grade = 'C';
    else if (highIssues > 0 || mediumIssues > 3) grade = 'B';

    return {
      grade,
      summary: {
        total: totalIssues,
        critical: criticalIssues,
        high: highIssues,
        medium: mediumIssues
      },
      recommendations: this.getRecommendations(issues)
    };
  }

  static getRecommendations(issues) {
    const recommendations = [];

    if (issues.some(i => i.type === 'dangerous-function')) {
      recommendations.push('ä½¿ç”¨å®‰å…¨çš„DOMæ“ä½œæ–¹æ³•ï¼Œå¦‚textContentæ›¿ä»£innerHTML');
    }

    if (issues.some(i => i.type === 'hardcoded-secret')) {
      recommendations.push('å°†æ•æ„Ÿä¿¡æ¯ç§»è‡³ç¯å¢ƒå˜é‡æˆ–å®‰å…¨é…ç½®æ–‡ä»¶');
    }

    if (issues.some(i => i.type === 'weak-random')) {
      recommendations.push('ä½¿ç”¨crypto.getRandomValues()ç”Ÿæˆå®‰å…¨éšæœºæ•°');
    }

    return recommendations;
  }
}
```

### ä¾èµ–å®‰å…¨ç®¡ç†

#### ä¾èµ–é£é™©è¯„ä¼°

| é£é™©ç±»å‹ | è¯„ä¼°æŒ‡æ ‡ | å·¥å…· | å¤„ç†ç­–ç•¥ |
|----------|----------|------|----------|
| **å·²çŸ¥æ¼æ´** | CVEæ•°é‡ã€CVSSè¯„åˆ† | npm audit, Snyk | ç«‹å³æ›´æ–° |
| **ç»´æŠ¤çŠ¶æ€** | æœ€åæ›´æ–°æ—¶é—´ã€æ´»è·ƒåº¦ | npm outdated | è€ƒè™‘æ›¿æ¢ |
| **è®¸å¯è¯é£é™©** | è®¸å¯è¯ç±»å‹ã€å…¼å®¹æ€§ | license-checker | æ³•åŠ¡å®¡æŸ¥ |
| **ä¾›åº”é“¾é£é™©** | ä¾èµ–æ·±åº¦ã€ç»´æŠ¤è€…ä¿¡èª‰ | äººå·¥å®¡æŸ¥ | è°¨æ…é€‰æ‹© |

#### è‡ªåŠ¨åŒ–ä¾èµ–æ£€æŸ¥

```javascript
// ä¾èµ–å®‰å…¨æ£€æŸ¥å·¥å…·
class DependencySecurityChecker {
  constructor() {
    this.vulnerabilityDB = new Map(); // ç®€åŒ–çš„æ¼æ´æ•°æ®åº“
  }

  // æ£€æŸ¥package.jsonä¸­çš„ä¾èµ–
  async checkDependencies(packageJson) {
    const dependencies = {
      ...packageJson.dependencies,
      ...packageJson.devDependencies
    };

    const results = [];

    for (const [name, version] of Object.entries(dependencies)) {
      const result = await this.checkSingleDependency(name, version);
      results.push(result);
    }

    return this.generateDependencyReport(results);
  }

  async checkSingleDependency(name, version) {
    // æ¨¡æ‹Ÿä¾èµ–æ£€æŸ¥
    const vulnerabilities = await this.getVulnerabilities(name, version);
    const maintenance = await this.getMaintenanceInfo(name);
    const license = await this.getLicenseInfo(name);

    return {
      name,
      version,
      vulnerabilities,
      maintenance,
      license,
      riskScore: this.calculateRiskScore(vulnerabilities, maintenance)
    };
  }

  calculateRiskScore(vulnerabilities, maintenance) {
    let score = 0;

    // æ¼æ´é£é™©
    vulnerabilities.forEach(vuln => {
      switch (vuln.severity) {
        case 'critical': score += 10; break;
        case 'high': score += 7; break;
        case 'medium': score += 4; break;
        case 'low': score += 1; break;
      }
    });

    // ç»´æŠ¤é£é™©
    if (maintenance.lastUpdate > 365) score += 5; // è¶…è¿‡1å¹´æœªæ›´æ–°
    if (maintenance.weeklyDownloads < 1000) score += 3; // ä½¿ç”¨é‡ä½

    return Math.min(score, 100);
  }

  generateDependencyReport(results) {
    const highRiskDeps = results.filter(r => r.riskScore >= 7);
    const mediumRiskDeps = results.filter(r => r.riskScore >= 4 && r.riskScore < 7);
    const totalVulns = results.reduce((sum, r) => sum + r.vulnerabilities.length, 0);

    return {
      summary: {
        totalDependencies: results.length,
        highRisk: highRiskDeps.length,
        mediumRisk: mediumRiskDeps.length,
        totalVulnerabilities: totalVulns
      },
      recommendations: this.generateRecommendations(highRiskDeps),
      details: results
    };
  }

  generateRecommendations(highRiskDeps) {
    const recommendations = [];

    highRiskDeps.forEach(dep => {
      if (dep.vulnerabilities.length > 0) {
        recommendations.push(`æ›´æ–° ${dep.name} ä»¥ä¿®å¤å®‰å…¨æ¼æ´`);
      }
      if (dep.maintenance.lastUpdate > 365) {
        recommendations.push(`è€ƒè™‘æ›¿æ¢é•¿æœŸæœªç»´æŠ¤çš„ä¾èµ– ${dep.name}`);
      }
    });

    return recommendations;
  }

  // æ¨¡æ‹Ÿæ–¹æ³•
  async getVulnerabilities(name, version) {
    // å®é™…åº”ç”¨ä¸­åº”æŸ¥è¯¢çœŸå®çš„æ¼æ´æ•°æ®åº“
    return [];
  }

  async getMaintenanceInfo(name) {
    // å®é™…åº”ç”¨ä¸­åº”æŸ¥è¯¢npm registry
    return {
      lastUpdate: Math.floor(Math.random() * 1000),
      weeklyDownloads: Math.floor(Math.random() * 100000)
    };
  }

  async getLicenseInfo(name) {
    // å®é™…åº”ç”¨ä¸­åº”æŸ¥è¯¢åŒ…çš„è®¸å¯è¯ä¿¡æ¯
    return { license: 'MIT', compatible: true };
  }
}
```

### å®‰å…¨æµ‹è¯•ç­–ç•¥

#### æµ‹è¯•ç±»å‹ä¸è¦†ç›–èŒƒå›´

| æµ‹è¯•ç±»å‹ | æµ‹è¯•å†…å®¹ | å·¥å…· | æ‰§è¡Œé¢‘ç‡ |
|----------|----------|------|----------|
| **å•å…ƒæµ‹è¯•** | è¾“å…¥éªŒè¯ã€è¾¹ç•Œæ¡ä»¶ | Jest, Mocha | æ¯æ¬¡æäº¤ |
| **é›†æˆæµ‹è¯•** | APIå®‰å…¨ã€è®¤è¯æµç¨‹ | Cypress, Playwright | æ¯æ—¥æ„å»º |
| **å®‰å…¨æ‰«æ** | é™æ€ä»£ç åˆ†æ | ESLint Security, SonarQube | æ¯æ¬¡æäº¤ |
| **æ¸—é€æµ‹è¯•** | æ¨¡æ‹Ÿæ”»å‡»åœºæ™¯ | OWASP ZAP, Burp Suite | æ¯æœˆ |

#### å®‰å…¨æµ‹è¯•è‡ªåŠ¨åŒ–

```javascript
// å®‰å…¨æµ‹è¯•å¥—ä»¶
class SecurityTestSuite {
  constructor() {
    this.testResults = [];
  }

  // XSSé˜²æŠ¤æµ‹è¯•
  testXSSProtection() {
    const testCases = [
      '<script>alert("xss")</script>',
      'javascript:alert("xss")',
      '<img src="x" onerror="alert(\'xss\')">',
      '"><script>alert("xss")</script>',
      '\';alert("xss");//'
    ];

    const results = testCases.map(payload => {
      try {
        // æµ‹è¯•è¾“å…¥è¿‡æ»¤
        const filtered = this.filterXSS(payload);
        const isBlocked = !filtered.includes('<script>') &&
                         !filtered.includes('javascript:') &&
                         !filtered.includes('onerror=');

        return {
          payload,
          filtered,
          blocked: isBlocked,
          passed: isBlocked
        };
      } catch (error) {
        return {
          payload,
          error: error.message,
          passed: false
        };
      }
    });

    this.testResults.push({
      test: 'XSS Protection',
      results,
      passed: results.every(r => r.passed)
    });

    return results;
  }

  // CSRFé˜²æŠ¤æµ‹è¯•
  testCSRFProtection() {
    const testCases = [
      { method: 'POST', hasToken: false, expected: false },
      { method: 'POST', hasToken: true, validToken: false, expected: false },
      { method: 'POST', hasToken: true, validToken: true, expected: true },
      { method: 'GET', hasToken: false, expected: true } // GETè¯·æ±‚é€šå¸¸ä¸éœ€è¦CSRF token
    ];

    const results = testCases.map(testCase => {
      const passed = this.validateCSRFToken(testCase) === testCase.expected;
      return { ...testCase, passed };
    });

    this.testResults.push({
      test: 'CSRF Protection',
      results,
      passed: results.every(r => r.passed)
    });

    return results;
  }

  // è¾“å…¥éªŒè¯æµ‹è¯•
  testInputValidation() {
    const testCases = [
      { input: 'normal@email.com', type: 'email', expected: true },
      { input: 'invalid-email', type: 'email', expected: false },
      { input: '12345', type: 'number', expected: true },
      { input: 'abc', type: 'number', expected: false },
      { input: 'a'.repeat(1000), type: 'text', maxLength: 100, expected: false }
    ];

    const results = testCases.map(testCase => {
      const isValid = this.validateInput(testCase.input, testCase.type, testCase);
      return {
        ...testCase,
        valid: isValid,
        passed: isValid === testCase.expected
      };
    });

    this.testResults.push({
      test: 'Input Validation',
      results,
      passed: results.every(r => r.passed)
    });

    return results;
  }

  // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
  generateReport() {
    const totalTests = this.testResults.length;
    const passedTests = this.testResults.filter(t => t.passed).length;
    const failedTests = totalTests - passedTests;

    return {
      summary: {
        total: totalTests,
        passed: passedTests,
        failed: failedTests,
        passRate: totalTests > 0 ? (passedTests / totalTests * 100).toFixed(2) : 0
      },
      details: this.testResults,
      recommendations: this.generateTestRecommendations()
    };
  }

  generateTestRecommendations() {
    const recommendations = [];

    this.testResults.forEach(test => {
      if (!test.passed) {
        switch (test.test) {
          case 'XSS Protection':
            recommendations.push('åŠ å¼ºXSSé˜²æŠ¤ï¼Œæ£€æŸ¥è¾“å…¥è¿‡æ»¤å’Œè¾“å‡ºç¼–ç ');
            break;
          case 'CSRF Protection':
            recommendations.push('å®æ–½CSRF TokenéªŒè¯æˆ–SameSite Cookie');
            break;
          case 'Input Validation':
            recommendations.push('å®Œå–„è¾“å…¥éªŒè¯è§„åˆ™ï¼Œç¡®ä¿æ•°æ®æ ¼å¼å’Œé•¿åº¦é™åˆ¶');
            break;
        }
      }
    });

    return recommendations;
  }

  // è¾…åŠ©æ–¹æ³•ï¼ˆç®€åŒ–å®ç°ï¼‰
  filterXSS(input) {
    return input
      .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/javascript:/gi, '')
      .replace(/on\w+\s*=/gi, '');
  }

  validateCSRFToken(testCase) {
    if (testCase.method === 'GET') return true;
    if (!testCase.hasToken) return false;
    return testCase.validToken === true;
  }

  validateInput(input, type, options = {}) {
    switch (type) {
      case 'email':
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
      case 'number':
        return !isNaN(input) && !isNaN(parseFloat(input));
      case 'text':
        return options.maxLength ? input.length <= options.maxLength : true;
      default:
        return true;
    }
  }
}
```

---

<Callout type="success">
å‰ç«¯å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨å¼€å‘çš„æ¯ä¸ªé˜¶æ®µéƒ½è€ƒè™‘å®‰å…¨å› ç´ ï¼Œå»ºç«‹å®Œå–„çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ã€‚
</Callout>

---

## ğŸ“š å‚è€ƒå­¦ä¹ èµ„æ–™

### ğŸ“– å®˜æ–¹æ–‡æ¡£
- [OWASP Top 10](https://owasp.org/www-project-top-ten/) - Webåº”ç”¨å®‰å…¨é£é™©
- [MDN Web Security](https://developer.mozilla.org/en-US/docs/Web/Security) - Webå®‰å…¨æŒ‡å—
- [Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) - CSPæ–‡æ¡£
- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API) - WebåŠ å¯†API

### ğŸ“ ä¼˜è´¨æ•™ç¨‹
- [Frontend Security](https://frontendmasters.com/courses/web-security/) - Frontend Masterså®‰å…¨è¯¾ç¨‹
- [XSS Prevention](https://excess-xss.com/) - XSSé˜²æŠ¤æŒ‡å—
- [CSRF Protection](https://portswigger.net/web-security/csrf) - CSRFé˜²æŠ¤æ•™ç¨‹

### ğŸ› ï¸ å®è·µé¡¹ç›®
- [OWASP WebGoat](https://owasp.org/www-project-webgoat/) - Webå®‰å…¨å­¦ä¹ å¹³å°
- [DVWA](http://www.dvwa.co.uk/) - æ•…æ„å­˜åœ¨æ¼æ´çš„Webåº”ç”¨
- [OWASP ZAP](https://www.zaproxy.org/) - Webåº”ç”¨å®‰å…¨æµ‹è¯•å·¥å…·
- [Security Checklist](https://github.com/FallibleInc/security-guide-for-developers) - å¼€å‘è€…å®‰å…¨æŒ‡å—

### ğŸ”§ å¼€å‘å·¥å…·
- [ESLint Security](https://github.com/nodesecurity/eslint-plugin-security) - ESLintå®‰å…¨æ’ä»¶
- [Snyk](https://snyk.io/) - ä¾èµ–å®‰å…¨æ‰«æ
- [npm audit](https://docs.npmjs.com/cli/v8/commands/npm-audit) - npmå®‰å…¨å®¡è®¡
- [Helmet.js](https://helmetjs.github.io/) - Expresså®‰å…¨ä¸­é—´ä»¶

### ğŸ“ æ·±å…¥é˜…è¯»
- [Frontend Security Best Practices](https://blog.logrocket.com/frontend-security-best-practices/) - å‰ç«¯å®‰å…¨æœ€ä½³å®è·µ
- [XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html) - XSSé˜²æŠ¤å¤‡å¿˜å•
- [CSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html) - CSRFé˜²æŠ¤æŒ‡å—

<Callout type="tip">
ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šå»ºè®®ä»OWASP Top 10å¼€å§‹äº†è§£å¸¸è§å®‰å…¨å¨èƒï¼Œå­¦ä¹ XSSå’ŒCSRFé˜²æŠ¤æŠ€æœ¯ï¼Œç„¶åæŒæ¡CSPé…ç½®ï¼Œæœ€åå»ºç«‹å®Œæ•´çš„å®‰å…¨å¼€å‘æµç¨‹ã€‚
</Callout>

---
