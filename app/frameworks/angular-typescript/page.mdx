import { Callout } from 'nextra/components'

# 09. Angularæ¡†æ¶å’ŒTypeScript

## ğŸ“‹ ç›®å½•

- [Angularæ¶æ„æ·±å…¥](#angularæ¶æ„æ·±å…¥)
- [TypeScriptåœ¨Angularä¸­çš„åº”ç”¨](#typescriptåœ¨angularä¸­çš„åº”ç”¨)
- [ä¾èµ–æ³¨å…¥ç³»ç»Ÿ](#ä¾èµ–æ³¨å…¥ç³»ç»Ÿ)
- [RxJSå“åº”å¼ç¼–ç¨‹](#rxjså“åº”å¼ç¼–ç¨‹)
- [Angularä¼ä¸šçº§å¼€å‘](#angularä¼ä¸šçº§å¼€å‘)
- [æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ](#æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ)

## Angularæ¶æ„æ·±å…¥

<Callout type="info">
[Angular](https://angular.io/)æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¼ä¸šçº§å‰ç«¯æ¡†æ¶ï¼Œæä¾›äº†ä»å¼€å‘åˆ°éƒ¨ç½²çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚åˆå¤§å‹å¤æ‚åº”ç”¨çš„å¼€å‘ã€‚
</Callout>

### Angularæ ¸å¿ƒæ¦‚å¿µ

```typescript
// 1. ç»„ä»¶ï¼ˆComponentï¼‰
import { Component, Input, Output, EventEmitter, OnInit, OnDestroy } from '@angular/core';
import { Subject, takeUntil } from 'rxjs';

@Component({
  selector: 'app-user-card',
  template: `
    <div class="user-card" [class.active]="isActive">
      <img [src]="user.avatar" [alt]="user.name">
      <h3>{{ user.name }}</h3>
      <p>{{ user.email }}</p>
      <button (click)="onEdit()" [disabled]="!canEdit">
        ç¼–è¾‘
      </button>
      <button (click)="onDelete()" class="danger">
        åˆ é™¤
      </button>
    </div>
  `,
  styleUrls: ['./user-card.component.scss']
})
export class UserCardComponent implements OnInit, OnDestroy {
  @Input() user!: User;
  @Input() canEdit: boolean = true;
  @Input() isActive: boolean = false;
  
  @Output() edit = new EventEmitter<User>();
  @Output() delete = new EventEmitter<string>();
  
  private destroy$ = new Subject<void>();
  
  ngOnInit(): void {
    console.log('UserCard component initialized');
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
  
  onEdit(): void {
    this.edit.emit(this.user);
  }
  
  onDelete(): void {
    this.delete.emit(this.user.id);
  }
}

// 2. æœåŠ¡ï¼ˆServiceï¼‰
import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError, BehaviorSubject } from 'rxjs';
import { catchError, map, tap } from 'rxjs/operators';

export interface User {
  id: string;
  name: string;
  email: string;
  avatar: string;
  role: 'admin' | 'user';
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private readonly apiUrl = '/api/users';
  private usersSubject = new BehaviorSubject<User[]>([]);
  
  public users$ = this.usersSubject.asObservable();
  
  constructor(private http: HttpClient) {}
  
  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl).pipe(
      tap(users => this.usersSubject.next(users)),
      catchError(this.handleError)
    );
  }
  
  getUserById(id: string): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/${id}`).pipe(
      catchError(this.handleError)
    );
  }
  
  createUser(user: Omit<User, 'id'>): Observable<User> {
    return this.http.post<User>(this.apiUrl, user).pipe(
      tap(newUser => {
        const currentUsers = this.usersSubject.value;
        this.usersSubject.next([...currentUsers, newUser]);
      }),
      catchError(this.handleError)
    );
  }
  
  updateUser(id: string, user: Partial<User>): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/${id}`, user).pipe(
      tap(updatedUser => {
        const currentUsers = this.usersSubject.value;
        const index = currentUsers.findIndex(u => u.id === id);
        if (index !== -1) {
          currentUsers[index] = updatedUser;
          this.usersSubject.next([...currentUsers]);
        }
      }),
      catchError(this.handleError)
    );
  }
  
  deleteUser(id: string): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`).pipe(
      tap(() => {
        const currentUsers = this.usersSubject.value;
        const filteredUsers = currentUsers.filter(u => u.id !== id);
        this.usersSubject.next(filteredUsers);
      }),
      catchError(this.handleError)
    );
  }
  
  private handleError(error: HttpErrorResponse): Observable<never> {
    let errorMessage = 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
    
    if (error.error instanceof ErrorEvent) {
      // å®¢æˆ·ç«¯é”™è¯¯
      errorMessage = `å®¢æˆ·ç«¯é”™è¯¯: ${error.error.message}`;
    } else {
      // æœåŠ¡ç«¯é”™è¯¯
      errorMessage = `æœåŠ¡ç«¯é”™è¯¯: ${error.status} - ${error.message}`;
    }
    
    console.error(errorMessage);
    return throwError(() => new Error(errorMessage));
  }
}

// 3. æŒ‡ä»¤ï¼ˆDirectiveï¼‰
import { Directive, ElementRef, HostListener, Input } from '@angular/core';

@Directive({
  selector: '[appHighlight]'
})
export class HighlightDirective {
  @Input() appHighlight = '';
  @Input() defaultColor = 'yellow';
  
  constructor(private el: ElementRef) {}
  
  @HostListener('mouseenter') onMouseEnter() {
    this.highlight(this.appHighlight || this.defaultColor);
  }
  
  @HostListener('mouseleave') onMouseLeave() {
    this.highlight('');
  }
  
  private highlight(color: string) {
    this.el.nativeElement.style.backgroundColor = color;
  }
}

// 4. ç®¡é“ï¼ˆPipeï¼‰
import { Pipe, PipeTransform } from '@angular/core';

@Pipe({
  name: 'truncate',
  pure: true
})
export class TruncatePipe implements PipeTransform {
  transform(value: string, limit: number = 50, trail: string = '...'): string {
    if (!value) return '';
    
    return value.length > limit 
      ? value.substring(0, limit) + trail 
      : value;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
// <p>{{ longText | truncate:100:'...' }}</p>
```

### æ¨¡å—ç³»ç»Ÿ

```typescript
// 1. ç‰¹æ€§æ¨¡å—
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule } from '@angular/forms';
import { RouterModule } from '@angular/router';

import { UserListComponent } from './components/user-list/user-list.component';
import { UserCardComponent } from './components/user-card/user-card.component';
import { UserFormComponent } from './components/user-form/user-form.component';
import { UserService } from './services/user.service';
import { TruncatePipe } from './pipes/truncate.pipe';
import { HighlightDirective } from './directives/highlight.directive';

@NgModule({
  declarations: [
    UserListComponent,
    UserCardComponent,
    UserFormComponent,
    TruncatePipe,
    HighlightDirective
  ],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterModule.forChild([
      { path: '', component: UserListComponent },
      { path: 'create', component: UserFormComponent },
      { path: ':id/edit', component: UserFormComponent }
    ])
  ],
  providers: [
    UserService
  ],
  exports: [
    UserCardComponent,
    TruncatePipe
  ]
})
export class UserModule {}

// 2. å…±äº«æ¨¡å—
@NgModule({
  declarations: [
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ],
  imports: [
    CommonModule,
    MaterialModule
  ],
  exports: [
    CommonModule,
    MaterialModule,
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ]
})
export class SharedModule {}

// 3. æ ¸å¿ƒæ¨¡å—
@NgModule({
  providers: [
    AuthService,
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true },
    { provide: HTTP_INTERCEPTORS, useClass: ErrorInterceptor, multi: true }
  ]
})
export class CoreModule {
  constructor(@Optional() @SkipSelf() parentModule: CoreModule) {
    if (parentModule) {
      throw new Error('CoreModuleå·²ç»åŠ è½½ï¼Œåªèƒ½åœ¨AppModuleä¸­å¯¼å…¥ä¸€æ¬¡');
    }
  }
}
```

## TypeScriptåœ¨Angularä¸­çš„åº”ç”¨

### é«˜çº§ç±»å‹ç³»ç»Ÿ

<Callout type="warning">
TypeScriptçš„å¼ºç±»å‹ç³»ç»Ÿæ˜¯Angularçš„æ ¸å¿ƒä¼˜åŠ¿ä¹‹ä¸€ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶å‘ç°é”™è¯¯ï¼Œæé«˜ä»£ç è´¨é‡ã€‚
</Callout>

```typescript
// 1. æ¥å£å’Œç±»å‹å®šä¹‰
export interface ApiResponse<T> {
  data: T;
  message: string;
  success: boolean;
  timestamp: number;
}

export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

export type UserRole = 'admin' | 'moderator' | 'user';
export type UserStatus = 'active' | 'inactive' | 'pending';

export interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
  status: UserStatus;
  createdAt: Date;
  updatedAt: Date;
  profile?: UserProfile;
}

export interface UserProfile {
  avatar?: string;
  bio?: string;
  location?: string;
  website?: string;
}

// 2. æ³›å‹æœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class ApiService {
  constructor(private http: HttpClient) {}
  
  get<T>(url: string): Observable<ApiResponse<T>> {
    return this.http.get<ApiResponse<T>>(url);
  }
  
  post<T, U = any>(url: string, data: U): Observable<ApiResponse<T>> {
    return this.http.post<ApiResponse<T>>(url, data);
  }
  
  put<T, U = any>(url: string, data: U): Observable<ApiResponse<T>> {
    return this.http.put<ApiResponse<T>>(url, data);
  }
  
  delete<T = any>(url: string): Observable<ApiResponse<T>> {
    return this.http.delete<ApiResponse<T>>(url);
  }
  
  getPaginated<T>(
    url: string, 
    params: { page: number; limit: number }
  ): Observable<PaginatedResponse<T>> {
    const httpParams = new HttpParams()
      .set('page', params.page.toString())
      .set('limit', params.limit.toString());
      
    return this.http.get<PaginatedResponse<T>>(url, { params: httpParams });
  }
}

// 3. è£…é¥°å™¨å’Œå…ƒæ•°æ®
function LogMethod(target: any, propertyName: string, descriptor: PropertyDescriptor) {
  const method = descriptor.value;
  
  descriptor.value = function (...args: any[]) {
    console.log(`è°ƒç”¨æ–¹æ³• ${propertyName}ï¼Œå‚æ•°:`, args);
    const result = method.apply(this, args);
    console.log(`æ–¹æ³• ${propertyName} è¿”å›:`, result);
    return result;
  };
}

function Cacheable(ttl: number = 5000) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const cache = new Map<string, { value: any; timestamp: number }>();
    const method = descriptor.value;
    
    descriptor.value = function (...args: any[]) {
      const key = JSON.stringify(args);
      const cached = cache.get(key);
      
      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.value;
      }
      
      const result = method.apply(this, args);
      cache.set(key, { value: result, timestamp: Date.now() });
      
      return result;
    };
  };
}

// ä½¿ç”¨è£…é¥°å™¨
@Injectable({
  providedIn: 'root'
})
export class DataService {
  @LogMethod
  @Cacheable(10000)
  fetchData(id: string): Observable<any> {
    return this.http.get(`/api/data/${id}`);
  }
}

// 4. æ¡ä»¶ç±»å‹å’Œæ˜ å°„ç±»å‹
type NonNullable<T> = T extends null | undefined ? never : T;
type Partial<T> = { [P in keyof T]?: T[P] };
type Required<T> = { [P in keyof T]-?: T[P] };
type Pick<T, K extends keyof T> = { [P in K]: T[P] };
type Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;

// å®ç”¨ç±»å‹ç¤ºä¾‹
export type CreateUserDto = Omit<User, 'id' | 'createdAt' | 'updatedAt'>;
export type UpdateUserDto = Partial<Pick<User, 'name' | 'email' | 'role' | 'status'>>;
export type UserSummary = Pick<User, 'id' | 'name' | 'email' | 'role'>;

// 5. ç±»å‹å®ˆå«
export function isUser(obj: any): obj is User {
  return obj && 
         typeof obj.id === 'string' &&
         typeof obj.name === 'string' &&
         typeof obj.email === 'string' &&
         ['admin', 'moderator', 'user'].includes(obj.role);
}

export function isApiResponse<T>(obj: any): obj is ApiResponse<T> {
  return obj &&
         typeof obj.success === 'boolean' &&
         typeof obj.message === 'string' &&
         typeof obj.timestamp === 'number' &&
         obj.data !== undefined;
}

// ä½¿ç”¨ç±»å‹å®ˆå«
@Component({
  selector: 'app-user-detail',
  template: `
    <div *ngIf="user">
      <h2>{{ user.name }}</h2>
      <p>{{ user.email }}</p>
    </div>
  `
})
export class UserDetailComponent {
  user: User | null = null;
  
  loadUser(data: unknown): void {
    if (isUser(data)) {
      this.user = data;
    } else {
      console.error('Invalid user data:', data);
    }
  }
}
```

## ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

### é«˜çº§ä¾èµ–æ³¨å…¥

```typescript
// 1. æ³¨å…¥ä»¤ç‰Œ
import { InjectionToken } from '@angular/core';

export const API_CONFIG = new InjectionToken<ApiConfig>('api.config');
export const FEATURE_FLAGS = new InjectionToken<FeatureFlags>('feature.flags');

export interface ApiConfig {
  baseUrl: string;
  timeout: number;
  retryAttempts: number;
}

export interface FeatureFlags {
  enableNewUI: boolean;
  enableAnalytics: boolean;
  enableBetaFeatures: boolean;
}

// 2. å·¥å‚æä¾›è€…
export function createApiService(
  http: HttpClient,
  config: ApiConfig
): ApiService {
  return new ApiService(http, config);
}

export function createLogger(isDevelopment: boolean): Logger {
  return isDevelopment ? new ConsoleLogger() : new RemoteLogger();
}

// 3. æ¨¡å—é…ç½®
@NgModule({
  providers: [
    {
      provide: API_CONFIG,
      useValue: {
        baseUrl: 'https://api.example.com',
        timeout: 5000,
        retryAttempts: 3
      }
    },
    {
      provide: FEATURE_FLAGS,
      useFactory: () => ({
        enableNewUI: environment.production,
        enableAnalytics: true,
        enableBetaFeatures: !environment.production
      })
    },
    {
      provide: ApiService,
      useFactory: createApiService,
      deps: [HttpClient, API_CONFIG]
    },
    {
      provide: Logger,
      useFactory: createLogger,
      deps: [ENVIRONMENT]
    }
  ]
})
export class AppModule {}

// 4. å¤šæä¾›è€…
export const VALIDATORS = new InjectionToken<Validator[]>('validators');

@Injectable()
export class EmailValidator implements Validator {
  validate(value: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }
}

@Injectable()
export class PhoneValidator implements Validator {
  validate(value: string): boolean {
    return /^\d{10,11}$/.test(value);
  }
}

@NgModule({
  providers: [
    { provide: VALIDATORS, useClass: EmailValidator, multi: true },
    { provide: VALIDATORS, useClass: PhoneValidator, multi: true }
  ]
})
export class ValidationModule {}

// 5. å±‚çº§æ³¨å…¥å™¨
@Component({
  selector: 'app-user-list',
  providers: [
    // ç»„ä»¶çº§æä¾›è€…
    { provide: UserService, useClass: CachedUserService }
  ],
  template: `
    <app-user-card 
      *ngFor="let user of users" 
      [user]="user">
    </app-user-card>
  `
})
export class UserListComponent {
  constructor(
    private userService: UserService, // ä½¿ç”¨CachedUserService
    @Inject(FEATURE_FLAGS) private featureFlags: FeatureFlags,
    @Optional() private analytics: AnalyticsService,
    @Self() private localService: LocalService
  ) {}
}
```

## RxJSå“åº”å¼ç¼–ç¨‹

### Observableæ¨¡å¼æ·±å…¥

<Callout type="info">
RxJSæ˜¯Angularçš„æ ¸å¿ƒä¾èµ–ï¼ŒæŒæ¡å“åº”å¼ç¼–ç¨‹å¯¹äºæ„å»ºé«˜è´¨é‡çš„Angularåº”ç”¨è‡³å…³é‡è¦ã€‚
</Callout>

```typescript
// 1. å¤æ‚çš„æ•°æ®æµå¤„ç†
@Injectable({
  providedIn: 'root'
})
export class SearchService {
  private searchTerms = new Subject<string>();
  
  // æœç´¢ç»“æœæµ
  public searchResults$ = this.searchTerms.pipe(
    debounceTime(300),           // é˜²æŠ–
    distinctUntilChanged(),      // å»é‡
    filter(term => term.length >= 2), // è¿‡æ»¤çŸ­æŸ¥è¯¢
    switchMap(term => 
      this.apiService.search(term).pipe(
        catchError(error => {
          console.error('æœç´¢é”™è¯¯:', error);
          return of([]); // è¿”å›ç©ºæ•°ç»„ä½œä¸ºé»˜è®¤å€¼
        })
      )
    ),
    shareReplay(1)               // ç¼“å­˜æœ€æ–°ç»“æœ
  );
  
  search(term: string): void {
    this.searchTerms.next(term);
  }
}

// 2. çŠ¶æ€ç®¡ç†
@Injectable({
  providedIn: 'root'
})
export class UserStateService {
  private usersSubject = new BehaviorSubject<User[]>([]);
  private loadingSubject = new BehaviorSubject<boolean>(false);
  private errorSubject = new BehaviorSubject<string | null>(null);
  
  public users$ = this.usersSubject.asObservable();
  public loading$ = this.loadingSubject.asObservable();
  public error$ = this.errorSubject.asObservable();
  
  // ç»„åˆçŠ¶æ€
  public state$ = combineLatest([
    this.users$,
    this.loading$,
    this.error$
  ]).pipe(
    map(([users, loading, error]) => ({
      users,
      loading,
      error,
      hasUsers: users.length > 0,
      isEmpty: users.length === 0 && !loading && !error
    }))
  );
  
  loadUsers(): void {
    this.loadingSubject.next(true);
    this.errorSubject.next(null);
    
    this.userService.getUsers().pipe(
      finalize(() => this.loadingSubject.next(false))
    ).subscribe({
      next: users => this.usersSubject.next(users),
      error: error => this.errorSubject.next(error.message)
    });
  }
  
  addUser(user: CreateUserDto): Observable<User> {
    return this.userService.createUser(user).pipe(
      tap(newUser => {
        const currentUsers = this.usersSubject.value;
        this.usersSubject.next([...currentUsers, newUser]);
      })
    );
  }
  
  updateUser(id: string, updates: UpdateUserDto): Observable<User> {
    return this.userService.updateUser(id, updates).pipe(
      tap(updatedUser => {
        const currentUsers = this.usersSubject.value;
        const index = currentUsers.findIndex(u => u.id === id);
        if (index !== -1) {
          currentUsers[index] = updatedUser;
          this.usersSubject.next([...currentUsers]);
        }
      })
    );
  }
  
  deleteUser(id: string): Observable<void> {
    return this.userService.deleteUser(id).pipe(
      tap(() => {
        const currentUsers = this.usersSubject.value;
        const filteredUsers = currentUsers.filter(u => u.id !== id);
        this.usersSubject.next(filteredUsers);
      })
    );
  }
}

// 3. è‡ªå®šä¹‰æ“ä½œç¬¦
export function retryWithBackoff(maxRetries: number = 3, baseDelay: number = 1000) {
  return <T>(source: Observable<T>) => source.pipe(
    retryWhen(errors => 
      errors.pipe(
        scan((retryCount, error) => {
          if (retryCount >= maxRetries) {
            throw error;
          }
          return retryCount + 1;
        }, 0),
        delay(baseDelay),
        tap(retryCount => console.log(`é‡è¯•ç¬¬ ${retryCount} æ¬¡`))
      )
    )
  );
}

export function cacheWithExpiry<T>(ttl: number = 5000) {
  return (source: Observable<T>) => {
    let cache: { value: T; timestamp: number } | null = null;
    
    return new Observable<T>(observer => {
      if (cache && Date.now() - cache.timestamp < ttl) {
        observer.next(cache.value);
        observer.complete();
        return;
      }
      
      return source.subscribe({
        next: value => {
          cache = { value, timestamp: Date.now() };
          observer.next(value);
        },
        error: error => observer.error(error),
        complete: () => observer.complete()
      });
    });
  };
}

// ä½¿ç”¨è‡ªå®šä¹‰æ“ä½œç¬¦
@Injectable({
  providedIn: 'root'
})
export class DataService {
  getData(): Observable<any> {
    return this.http.get('/api/data').pipe(
      retryWithBackoff(3, 1000),
      cacheWithExpiry(10000),
      catchError(error => {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        return throwError(() => error);
      })
    );
  }
}

// 4. å“åº”å¼è¡¨å•
@Component({
  selector: 'app-user-form',
  template: `
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="name">å§“å</label>
        <input 
          id="name" 
          type="text" 
          formControlName="name"
          [class.invalid]="nameControl.invalid && nameControl.touched">
        <div *ngIf="nameControl.invalid && nameControl.touched" class="error">
          <span *ngIf="nameControl.errors?.['required']">å§“åæ˜¯å¿…å¡«é¡¹</span>
          <span *ngIf="nameControl.errors?.['minlength']">å§“åè‡³å°‘2ä¸ªå­—ç¬¦</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="email">é‚®ç®±</label>
        <input 
          id="email" 
          type="email" 
          formControlName="email"
          [class.invalid]="emailControl.invalid && emailControl.touched">
        <div *ngIf="emailControl.invalid && emailControl.touched" class="error">
          <span *ngIf="emailControl.errors?.['required']">é‚®ç®±æ˜¯å¿…å¡«é¡¹</span>
          <span *ngIf="emailControl.errors?.['email']">é‚®ç®±æ ¼å¼ä¸æ­£ç¡®</span>
          <span *ngIf="emailControl.errors?.['emailTaken']">é‚®ç®±å·²è¢«ä½¿ç”¨</span>
        </div>
      </div>
      
      <button type="submit" [disabled]="userForm.invalid || submitting">
        {{ submitting ? 'æäº¤ä¸­...' : 'æäº¤' }}
      </button>
    </form>
  `
})
export class UserFormComponent implements OnInit, OnDestroy {
  userForm!: FormGroup;
  submitting = false;
  private destroy$ = new Subject<void>();
  
  constructor(
    private fb: FormBuilder,
    private userService: UserService
  ) {}
  
  ngOnInit(): void {
    this.createForm();
    this.setupFormValidation();
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
  
  get nameControl() { return this.userForm.get('name')!; }
  get emailControl() { return this.userForm.get('email')!; }
  
  private createForm(): void {
    this.userForm = this.fb.group({
      name: ['', [Validators.required, Validators.minLength(2)]],
      email: ['', [Validators.required, Validators.email], [this.emailValidator.bind(this)]]
    });
  }
  
  private setupFormValidation(): void {
    // å®æ—¶éªŒè¯
    this.userForm.valueChanges.pipe(
      debounceTime(300),
      takeUntil(this.destroy$)
    ).subscribe(value => {
      console.log('è¡¨å•å€¼å˜åŒ–:', value);
    });
    
    // é‚®ç®±å­—æ®µå˜åŒ–æ—¶çš„ç‰¹æ®Šå¤„ç†
    this.emailControl.valueChanges.pipe(
      debounceTime(500),
      distinctUntilChanged(),
      takeUntil(this.destroy$)
    ).subscribe(email => {
      if (email && this.emailControl.valid) {
        console.log('é‚®ç®±éªŒè¯é€šè¿‡:', email);
      }
    });
  }
  
  private emailValidator(control: AbstractControl): Observable<ValidationErrors | null> {
    if (!control.value) {
      return of(null);
    }
    
    return this.userService.checkEmailExists(control.value).pipe(
      map(exists => exists ? { emailTaken: true } : null),
      catchError(() => of(null))
    );
  }
  
  onSubmit(): void {
    if (this.userForm.valid) {
      this.submitting = true;
      
      this.userService.createUser(this.userForm.value).pipe(
        finalize(() => this.submitting = false),
        takeUntil(this.destroy$)
      ).subscribe({
        next: user => {
          console.log('ç”¨æˆ·åˆ›å»ºæˆåŠŸ:', user);
          this.userForm.reset();
        },
        error: error => {
          console.error('ç”¨æˆ·åˆ›å»ºå¤±è´¥:', error);
        }
      });
    }
  }
}
```

---

<Callout type="success">
Angularæä¾›äº†å®Œæ•´çš„ä¼ä¸šçº§å¼€å‘è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡TypeScriptã€ä¾èµ–æ³¨å…¥å’ŒRxJSçš„å¼ºå¤§ç»„åˆï¼Œèƒ½å¤Ÿæ„å»ºå¤§å‹ã€å¯ç»´æŠ¤çš„å‰ç«¯åº”ç”¨ã€‚
</Callout>
