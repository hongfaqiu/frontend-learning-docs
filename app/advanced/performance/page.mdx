import { Callout } from 'nextra/components'

# 16. æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

## ğŸ“‹ ç›®å½•

- [æ€§èƒ½æŒ‡æ ‡å’ŒCore Web Vitals](#æ€§èƒ½æŒ‡æ ‡å’Œcore-web-vitals)
- [åŠ è½½æ€§èƒ½ä¼˜åŒ–](#åŠ è½½æ€§èƒ½ä¼˜åŒ–)
- [è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–](#è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–)
- [æ€§èƒ½ç›‘æ§å’Œåˆ†æ](#æ€§èƒ½ç›‘æ§å’Œåˆ†æ)
- [è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•](#è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•)
- [æ€§èƒ½é¢„ç®—å’ŒæŒç»­ä¼˜åŒ–](#æ€§èƒ½é¢„ç®—å’ŒæŒç»­ä¼˜åŒ–)

## æ€§èƒ½æŒ‡æ ‡å’ŒCore Web Vitals

<Callout type="info">
[Core Web Vitals](https://web.dev/vitals/)æ˜¯[Google](https://developers.google.com/web)æå‡ºçš„ç”¨æˆ·ä½“éªŒæ ¸å¿ƒæŒ‡æ ‡ï¼Œç›´æ¥å½±å“SEOæ’åå’Œç”¨æˆ·æ»¡æ„åº¦ã€‚
</Callout>

### Core Web Vitalsè¯¦è§£

#### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | ä¼˜ç§€ | éœ€æ”¹è¿› | è¾ƒå·® | å½±å“å› ç´  |
|------|------|------|--------|------|----------|
| **LCP** | æœ€å¤§å†…å®¹ç»˜åˆ¶ | â‰¤2.5s | 2.5s-4.0s | >4.0s | å›¾ç‰‡å¤§å°ã€æœåŠ¡å™¨å“åº” |
| **FID** | é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ | â‰¤100ms | 100ms-300ms | >300ms | JavaScriptæ‰§è¡Œæ—¶é—´ |
| **CLS** | ç´¯ç§¯å¸ƒå±€åç§» | â‰¤0.1 | 0.1-0.25 | >0.25 | åŠ¨æ€å†…å®¹ã€å­—ä½“åŠ è½½ |
| **FCP** | é¦–æ¬¡å†…å®¹ç»˜åˆ¶ | â‰¤1.8s | 1.8s-3.0s | >3.0s | å…³é”®èµ„æºåŠ è½½ |
| **TTFB** | é¦–å­—èŠ‚æ—¶é—´ | â‰¤800ms | 800ms-1.8s | >1.8s | æœåŠ¡å™¨æ€§èƒ½ã€ç½‘ç»œ |

#### æ€§èƒ½ç›‘æ§å®ç°

```javascript
// ç®€åŒ–çš„æ€§èƒ½ç›‘æ§
import { onLCP, onFID, onCLS } from 'web-vitals';

class SimpleWebVitalsMonitor {
  constructor() {
    this.initMonitoring();
  }

  initMonitoring() {
    onLCP(this.sendMetric);
    onFID(this.sendMetric);
    onCLS(this.sendMetric);
  }

  sendMetric(metric) {
    // å‘é€åˆ°åˆ†ææœåŠ¡
    console.log(`${metric.name}: ${metric.value}`);

    // é›†æˆGoogle Analytics
    if (window.gtag) {
      window.gtag('event', 'web_vitals', {
        event_category: 'Performance',
        event_label: metric.name,
        value: Math.round(metric.value)
      });
    }
  }
}
```

#### æ€§èƒ½é¢„ç®—ç­–ç•¥

æ€§èƒ½é¢„ç®—æ˜¯è®¾å®šèµ„æºå¤§å°å’Œæ€§èƒ½æŒ‡æ ‡çš„é™åˆ¶ï¼Œç¡®ä¿åº”ç”¨ä¿æŒè‰¯å¥½æ€§èƒ½ã€‚

| èµ„æºç±»å‹ | æ¨èé¢„ç®— | è¯´æ˜ |
|----------|----------|------|
| **JavaScript** | â‰¤200KB | åŒ…å«æ‰€æœ‰JSæ–‡ä»¶å‹ç¼©åå¤§å° |
| **CSS** | â‰¤100KB | åŒ…å«æ‰€æœ‰æ ·å¼æ–‡ä»¶ |
| **å›¾ç‰‡** | â‰¤500KB | é¦–å±å›¾ç‰‡æ€»å¤§å° |
| **å­—ä½“** | â‰¤100KB | Webå­—ä½“æ–‡ä»¶å¤§å° |
| **æ€»èµ„æº** | â‰¤1MB | é¦–å±æ‰€æœ‰èµ„æºæ€»å’Œ |

```javascript
// ç®€åŒ–çš„æ€§èƒ½é¢„ç®—æ£€æŸ¥
class PerformanceBudget {
  constructor() {
    this.budgets = {
      javascript: 200, // KB
      css: 100,
      images: 500,
      total: 1000
    };
  }

  checkBudgets() {
    const resources = performance.getEntriesByType('resource');
    const sizes = { javascript: 0, css: 0, images: 0, total: 0 };

    resources.forEach(resource => {
      const size = resource.transferSize || 0;
      sizes.total += size;

      if (resource.name.includes('.js')) sizes.javascript += size;
      else if (resource.name.includes('.css')) sizes.css += size;
      else if (/\.(jpg|jpeg|png|gif|webp)/.test(resource.name)) sizes.images += size;
    });

    // æ£€æŸ¥é¢„ç®—è¿è§„
    const violations = [];
    Object.entries(sizes).forEach(([type, size]) => {
      const budgetKB = this.budgets[type];
      const actualKB = Math.round(size / 1024);

      if (actualKB > budgetKB) {
        violations.push({
          type,
          actual: actualKB,
          budget: budgetKB,
          excess: actualKB - budgetKB
        });
      }
    });

    return violations;
  }
}
```

## åŠ è½½æ€§èƒ½ä¼˜åŒ–

### èµ„æºä¼˜åŒ–ç­–ç•¥

#### å›¾ç‰‡ä¼˜åŒ–æœ€ä½³å®è·µ

| ä¼˜åŒ–ç­–ç•¥ | å®æ–½æ–¹æ³• | æ€§èƒ½æå‡ |
|----------|----------|----------|
| **æ ¼å¼é€‰æ‹©** | WebP > AVIF > JPEG | å‡å°‘30-50%æ–‡ä»¶å¤§å° |
| **æ‡’åŠ è½½** | Intersection Observer | å‡å°‘åˆå§‹åŠ è½½æ—¶é—´ |
| **å“åº”å¼å›¾ç‰‡** | srcset + sizes | é€‚é…ä¸åŒè®¾å¤‡ |
| **é¢„åŠ è½½** | `<link rel="preload">` | å…³é”®å›¾ç‰‡ä¼˜å…ˆåŠ è½½ |
| **å‹ç¼©** | è´¨é‡80-90% | å¹³è¡¡è´¨é‡ä¸å¤§å° |

```javascript
// ç®€åŒ–çš„å›¾ç‰‡æ‡’åŠ è½½
class SimpleImageLazyLoader {
  constructor() {
    this.setupLazyLoading();
  }

  setupLazyLoading() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.add('loaded');
          observer.unobserve(img);
        }
      });
    }, { rootMargin: '50px' });

    // ç›‘å¬æ‰€æœ‰æ‡’åŠ è½½å›¾ç‰‡
    document.querySelectorAll('img[data-src]').forEach(img => {
      observer.observe(img);
    });
  }

  // é¢„åŠ è½½å…³é”®å›¾ç‰‡
  preloadImages(urls) {
    urls.forEach(url => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'image';
      link.href = url;
      document.head.appendChild(link);
    });
  }
}
```

#### ä»£ç åˆ†å‰²ç­–ç•¥

| åˆ†å‰²ç±»å‹ | å®æ–½æ–¹æ³• | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|
| **è·¯ç”±åˆ†å‰²** | React.lazy + Suspense | ä¸åŒé¡µé¢ç»„ä»¶ |
| **ç»„ä»¶åˆ†å‰²** | åŠ¨æ€import | å¤§å‹ç»„ä»¶åº“ |
| **ç¬¬ä¸‰æ–¹åº“åˆ†å‰²** | Webpack splitChunks | ç‹¬ç«‹çš„vendoråŒ… |
| **æŒ‰éœ€åŠ è½½** | æ¡ä»¶import | åŠŸèƒ½æ¨¡å— |

```javascript
// ç®€åŒ–çš„ä»£ç åˆ†å‰²å®ç°
class SimpleCodeSplitting {
  // è·¯ç”±çº§æ‡’åŠ è½½
  static createLazyRoute(importFn) {
    return React.lazy(() => import(importFn));
  }

  // åŠ¨æ€å¯¼å…¥æ¨¡å—
  static async loadModule(modulePath) {
    try {
      const module = await import(modulePath);
      return module;
    } catch (error) {
      console.error(`æ¨¡å—åŠ è½½å¤±è´¥: ${modulePath}`, error);
      throw error;
    }
  }

  // é¢„åŠ è½½å…³é”®æ¨¡å—
  static preloadModule(modulePath) {
    const link = document.createElement('link');
    link.rel = 'modulepreload';
    link.href = modulePath;
    document.head.appendChild(link);
  }
}

// Reactç»„ä»¶æ‡’åŠ è½½ç¤ºä¾‹
const LazyDashboard = React.lazy(() => import('./Dashboard'));
const LazyProfile = React.lazy(() => import('./Profile'));

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <Routes>
        <Route path="/dashboard" element={<LazyDashboard />} />
        <Route path="/profile" element={<LazyProfile />} />
      </Routes>
    </Suspense>
  );
}
```

#### ç¼“å­˜ç­–ç•¥

| èµ„æºç±»å‹ | ç¼“å­˜ç­–ç•¥ | ç¼“å­˜æ—¶é—´ | è¯´æ˜ |
|----------|----------|----------|------|
| **é™æ€èµ„æº** | Cache First | 1å¹´ | JSã€CSSã€å›¾ç‰‡ã€å­—ä½“ |
| **APIæ•°æ®** | Network First | 5åˆ†é’Ÿ | åŠ¨æ€æ•°æ®ï¼Œç½‘ç»œä¼˜å…ˆ |
| **HTMLé¡µé¢** | Network First | 1å°æ—¶ | é¡µé¢å†…å®¹ï¼Œæ”¯æŒç¦»çº¿ |
| **ç”¨æˆ·æ•°æ®** | No Cache | - | æ•æ„Ÿæ•°æ®ä¸ç¼“å­˜ |

```javascript
// ç®€åŒ–çš„ç¼“å­˜å®ç°
class SimpleCacheManager {
  // æ³¨å†ŒService Worker
  static async registerSW() {
    if ('serviceWorker' in navigator) {
      try {
        await navigator.serviceWorker.register('/sw.js');
        console.log('Service Workeræ³¨å†ŒæˆåŠŸ');
      } catch (error) {
        console.error('Service Workeræ³¨å†Œå¤±è´¥:', error);
      }
    }
  }

  // é¢„ç¼“å­˜å…³é”®èµ„æº
  static precacheResources(urls) {
    urls.forEach(url => {
      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = url;
      document.head.appendChild(link);
    });
  }
}
```

## è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

<Callout type="warning">
è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–å…³æ³¨åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­çš„æ€§èƒ½è¡¨ç°ï¼ŒåŒ…æ‹¬æ¸²æŸ“æ€§èƒ½ã€å†…å­˜ç®¡ç†ã€äº¤äº’å“åº”ç­‰æ–¹é¢ã€‚
</Callout>

### Reactæ€§èƒ½ä¼˜åŒ–

#### Reactæ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–æŠ€æœ¯ | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½æå‡ |
|----------|----------|----------|
| **React.memo** | é¿å…ä¸å¿…è¦é‡æ¸²æŸ“ | å‡å°‘æ¸²æŸ“æ¬¡æ•° |
| **useMemo** | ç¼“å­˜è®¡ç®—ç»“æœ | é¿å…é‡å¤è®¡ç®— |
| **useCallback** | ç¼“å­˜å‡½æ•°å¼•ç”¨ | é¿å…å­ç»„ä»¶é‡æ¸²æŸ“ |
| **è™šæ‹Ÿæ»šåŠ¨** | é•¿åˆ—è¡¨æ¸²æŸ“ | å‡å°‘DOMèŠ‚ç‚¹ |
| **ä»£ç åˆ†å‰²** | æŒ‰éœ€åŠ è½½ç»„ä»¶ | å‡å°‘åˆå§‹åŒ…å¤§å° |

```javascript
// ç®€åŒ–çš„Reactæ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
import React, { memo, useMemo, useCallback, useState } from 'react';

// 1. ä½¿ç”¨memoé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
const UserCard = memo(({ user, onEdit }) => {
  const handleEdit = useCallback(() => {
    onEdit(user.id);
  }, [user.id, onEdit]);

  const displayName = useMemo(() => {
    return `${user.firstName} ${user.lastName}`.trim();
  }, [user.firstName, user.lastName]);

  return (
    <div className="user-card">
      <h3>{displayName}</h3>
      <button onClick={handleEdit}>Edit</button>
    </div>
  );
});

// 2. é˜²æŠ–æœç´¢ä¼˜åŒ–
const SearchInput = ({ onSearch }) => {
  const [value, setValue] = useState('');

  const debouncedSearch = useCallback(
    debounce((searchTerm) => onSearch(searchTerm), 300),
    [onSearch]
  );

  useEffect(() => {
    debouncedSearch(value);
  }, [value, debouncedSearch]);

  return (
    <input
      value={value}
      onChange={(e) => setValue(e.target.value)}
      placeholder="æœç´¢ç”¨æˆ·..."
    />
  );
};

// 3. å†…å­˜æ³„æ¼é˜²æŠ¤
const DataFetcher = ({ userId }) => {
  const [data, setData] = useState(null);

  useEffect(() => {
    let cancelled = false;

    const fetchData = async () => {
      try {
        const response = await fetch(`/api/users/${userId}`);
        const result = await response.json();

        if (!cancelled) {
          setData(result);
        }
      } catch (error) {
        console.error('Fetch error:', error);
      }
    };

    fetchData();

    return () => {
      cancelled = true; // é˜²æ­¢å†…å­˜æ³„æ¼
    };
  }, [userId]);

  return <div>{data ? JSON.stringify(data) : 'Loading...'}</div>;
};

// 4. è™šæ‹Ÿæ»šåŠ¨ï¼ˆä½¿ç”¨react-windowï¼‰
import { FixedSizeList as List } from 'react-window';

const VirtualList = ({ items }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      {items[index].name}
    </div>
  );

  return (
    <List
      height={400}
      itemCount={items.length}
      itemSize={50}
    >
      {Row}
    </List>
  );
};
```

## æ€§èƒ½ç›‘æ§å’Œåˆ†æ

<Callout type="info">
æ€§èƒ½ç›‘æ§å¸®åŠ©æˆ‘ä»¬äº†è§£åº”ç”¨åœ¨çœŸå®ç¯å¢ƒä¸­çš„è¡¨ç°ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚
</Callout>

### æ€§èƒ½ç›‘æ§å®æ–½

#### ç›‘æ§æŒ‡æ ‡ä½“ç³»

| ç›‘æ§å±‚é¢ | å…³é”®æŒ‡æ ‡ | ç›‘æ§å·¥å…· |
|----------|----------|----------|
| **ç”¨æˆ·ä½“éªŒ** | Core Web Vitals | web-vitalsåº“ |
| **èµ„æºåŠ è½½** | èµ„æºå¤§å°ã€åŠ è½½æ—¶é—´ | Performance API |
| **é”™è¯¯ç›‘æ§** | JavaScripté”™è¯¯ | Sentry, Bugsnag |
| **ä¸šåŠ¡æŒ‡æ ‡** | è½¬åŒ–ç‡ã€è·³å‡ºç‡ | Google Analytics |

```javascript
// ç®€åŒ–çš„æ€§èƒ½ç›‘æ§å®ç°
import { onLCP, onFID, onCLS } from 'web-vitals';

class SimplePerformanceMonitor {
  constructor() {
    this.setupWebVitals();
  }

  setupWebVitals() {
    onLCP(this.sendMetric);
    onFID(this.sendMetric);
    onCLS(this.sendMetric);
  }

  sendMetric(metric) {
    // å‘é€åˆ°åˆ†ææœåŠ¡
    fetch('/api/analytics/performance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: metric.name,
        value: metric.value,
        rating: metric.rating,
        timestamp: Date.now()
      })
    });
  }
}

```

### æ€§èƒ½ä¼˜åŒ–å·¥å…·é“¾

#### å¼€å‘é˜¶æ®µå·¥å…·

| å·¥å…· | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|
| **Lighthouse** | æ€§èƒ½å®¡è®¡ | å…¨é¢çš„æ€§èƒ½è¯„ä¼° |
| **Chrome DevTools** | æ€§èƒ½è°ƒè¯• | å®æ—¶æ€§èƒ½åˆ†æ |
| **Webpack Bundle Analyzer** | åŒ…åˆ†æ | å¯è§†åŒ–åŒ…å¤§å° |
| **React DevTools Profiler** | Reactæ€§èƒ½ | ç»„ä»¶æ¸²æŸ“åˆ†æ |

#### ç”Ÿäº§ç¯å¢ƒç›‘æ§

| å·¥å…· | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|
| **Google Analytics** | ç”¨æˆ·ä½“éªŒç›‘æ§ | Core Web Vitals |
| **Sentry** | é”™è¯¯ç›‘æ§ | æ€§èƒ½é—®é¢˜è¿½è¸ª |
| **New Relic** | APMç›‘æ§ | å…¨æ ˆæ€§èƒ½ç›‘æ§ |
| **DataDog** | åŸºç¡€è®¾æ–½ç›‘æ§ | æœåŠ¡å™¨æ€§èƒ½ |

```javascript
// ç®€åŒ–çš„æ€§èƒ½ç›‘æ§åˆå§‹åŒ–
class PerformanceTracker {
  static init() {
    // åˆå§‹åŒ–Web Vitalsç›‘æ§
    new SimplePerformanceMonitor();

    // åˆå§‹åŒ–é”™è¯¯ç›‘æ§
    window.addEventListener('error', (event) => {
      console.error('JavaScript Error:', event.error);
    });

    // åˆå§‹åŒ–èµ„æºç›‘æ§
    new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.duration > 1000) {
          console.warn('Slow resource:', entry.name);
        }
      });
    }).observe({ entryTypes: ['resource'] });
  }
}

// åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
PerformanceTracker.init();
```

---

<Callout type="success">
æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆç›‘æ§æ•°æ®ã€ç”¨æˆ·åé¦ˆå’Œä¸šåŠ¡éœ€æ±‚æ¥åˆ¶å®šåˆé€‚çš„ä¼˜åŒ–ç­–ç•¥ã€‚
</Callout>

---

## ğŸ“š å‚è€ƒå­¦ä¹ èµ„æ–™

### ğŸ“– å®˜æ–¹æ–‡æ¡£
- [Web.dev Performance](https://web.dev/performance/) - Google Webæ€§èƒ½æŒ‡å—
- [Core Web Vitals](https://web.dev/vitals/) - æ ¸å¿ƒWebæŒ‡æ ‡
- [MDN Performance](https://developer.mozilla.org/en-US/docs/Web/Performance) - MDNæ€§èƒ½æ–‡æ¡£
- [Chrome DevTools](https://developer.chrome.com/docs/devtools/performance/) - Chromeæ€§èƒ½è°ƒè¯•å·¥å…·

### ğŸ“ ä¼˜è´¨æ•™ç¨‹
- [Frontend Performance](https://frontendmasters.com/courses/web-performance/) - Frontend Mastersæ€§èƒ½è¯¾ç¨‹
- [Performance Budget](https://web.dev/performance-budgets-101/) - æ€§èƒ½é¢„ç®—æŒ‡å—
- [Image Optimization](https://web.dev/fast/#optimize-your-images) - å›¾ç‰‡ä¼˜åŒ–æŒ‡å—

### ğŸ› ï¸ å®è·µé¡¹ç›®
- [Lighthouse](https://developers.google.com/web/tools/lighthouse) - Googleæ€§èƒ½å®¡è®¡å·¥å…·
- [WebPageTest](https://www.webpagetest.org/) - Webæ€§èƒ½æµ‹è¯•å·¥å…·
- [Performance Monitoring](https://github.com/GoogleChrome/web-vitals) - Web Vitalsç›‘æ§åº“

### ğŸ”§ å¼€å‘å·¥å…·
- [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci) - æŒç»­é›†æˆæ€§èƒ½æµ‹è¯•
- [Bundle Analyzer](https://github.com/webpack-contrib/webpack-bundle-analyzer) - WebpackåŒ…åˆ†æ
- [Perfume.js](https://zizzamia.github.io/perfume/) - æ€§èƒ½ç›‘æ§åº“
- [SpeedCurve](https://speedcurve.com/) - æ€§èƒ½ç›‘æ§å¹³å°

### ğŸ“ æ·±å…¥é˜…è¯»
- [High Performance Browser Networking](https://hpbn.co/) - é«˜æ€§èƒ½æµè§ˆå™¨ç½‘ç»œ
- [Performance Patterns](https://web.dev/patterns/performance/) - æ€§èƒ½ä¼˜åŒ–æ¨¡å¼
- [Critical Rendering Path](https://developers.google.com/web/fundamentals/performance/critical-rendering-path) - å…³é”®æ¸²æŸ“è·¯å¾„

<Callout type="tip">
ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šå»ºè®®ä»Core Web Vitalså¼€å§‹äº†è§£æ€§èƒ½æŒ‡æ ‡ï¼Œå­¦ä¹ ä½¿ç”¨Lighthouseè¿›è¡Œæ€§èƒ½å®¡è®¡ï¼Œç„¶åæŒæ¡å„ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œæœ€åå»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ã€‚
</Callout>