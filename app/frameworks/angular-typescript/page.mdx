import { Callout } from 'nextra/components'

# 09. Angularæ¡†æ¶å’ŒTypeScript

## ğŸ“‹ ç›®å½•

- [Angularæ¶æ„æ·±å…¥](#angularæ¶æ„æ·±å…¥)
- [TypeScriptåœ¨Angularä¸­çš„åº”ç”¨](#typescriptåœ¨angularä¸­çš„åº”ç”¨)
- [ä¾èµ–æ³¨å…¥ç³»ç»Ÿ](#ä¾èµ–æ³¨å…¥ç³»ç»Ÿ)
- [RxJSå“åº”å¼ç¼–ç¨‹](#rxjså“åº”å¼ç¼–ç¨‹)
- [Angularä¼ä¸šçº§å¼€å‘](#angularä¼ä¸šçº§å¼€å‘)
- [æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ](#æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ)

## Angularæ¶æ„æ·±å…¥

<Callout type="info">
[Angular](https://angular.io/)æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¼ä¸šçº§å‰ç«¯æ¡†æ¶ï¼Œæä¾›äº†ä»å¼€å‘åˆ°éƒ¨ç½²çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚åˆå¤§å‹å¤æ‚åº”ç”¨çš„å¼€å‘ã€‚
</Callout>

### Angularæ ¸å¿ƒæ¦‚å¿µ

#### æ ¸å¿ƒæ„å»ºå—å¯¹æ¯”

| æ„å»ºå— | ä½œç”¨ | è£…é¥°å™¨ | ä½¿ç”¨åœºæ™¯ |
|--------|------|--------|----------|
| **Component** | UIç»„ä»¶ | `@Component` | é¡µé¢å…ƒç´ ã€å¯å¤ç”¨ç»„ä»¶ |
| **Service** | ä¸šåŠ¡é€»è¾‘ | `@Injectable` | æ•°æ®å¤„ç†ã€APIè°ƒç”¨ |
| **Directive** | DOMæ“ä½œ | `@Directive` | è¡Œä¸ºå¢å¼ºã€DOMä¿®æ”¹ |
| **Pipe** | æ•°æ®è½¬æ¢ | `@Pipe` | æ•°æ®æ ¼å¼åŒ–ã€è¿‡æ»¤ |
| **Module** | åŠŸèƒ½æ¨¡å— | `@NgModule` | åŠŸèƒ½ç»„ç»‡ã€ä¾èµ–ç®¡ç† |

#### ç»„ä»¶ç¤ºä¾‹

```typescript
// 1. åŸºç¡€ç»„ä»¶
@Component({
  selector: 'app-user-card',
  template: `
    <div class="user-card" [class.active]="isActive">
      <img [src]="user.avatar" [alt]="user.name">
      <h3>{{ user.name }}</h3>
      <p>{{ user.email }}</p>
      <button (click)="onEdit()" [disabled]="!canEdit">ç¼–è¾‘</button>
      <button (click)="onDelete()" class="danger">åˆ é™¤</button>
    </div>
  `,
  styleUrls: ['./user-card.component.scss']
})
export class UserCardComponent implements OnInit, OnDestroy {
  @Input() user!: User;
  @Input() canEdit: boolean = true;
  @Input() isActive: boolean = false;

  @Output() edit = new EventEmitter<User>();
  @Output() delete = new EventEmitter<string>();

  private destroy$ = new Subject<void>();

  ngOnInit(): void {
    console.log('UserCard component initialized');
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }

  onEdit(): void {
    this.edit.emit(this.user);
  }

  onDelete(): void {
    this.delete.emit(this.user.id);
  }
}
```

#### æœåŠ¡ç¤ºä¾‹

```typescript
// 2. æ•°æ®æœåŠ¡
export interface User {
  id: string;
  name: string;
  email: string;
  avatar: string;
  role: 'admin' | 'user';
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private readonly apiUrl = '/api/users';
  private usersSubject = new BehaviorSubject<User[]>([]);

  public users$ = this.usersSubject.asObservable();

  constructor(private http: HttpClient) {}

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(this.apiUrl).pipe(
      tap(users => this.usersSubject.next(users)),
      catchError(this.handleError)
    );
  }

  createUser(user: Omit<User, 'id'>): Observable<User> {
    return this.http.post<User>(this.apiUrl, user).pipe(
      tap(newUser => {
        const currentUsers = this.usersSubject.value;
        this.usersSubject.next([...currentUsers, newUser]);
      }),
      catchError(this.handleError)
    );
  }

  private handleError(error: HttpErrorResponse): Observable<never> {
    const errorMessage = error.error instanceof ErrorEvent
      ? `å®¢æˆ·ç«¯é”™è¯¯: ${error.error.message}`
      : `æœåŠ¡ç«¯é”™è¯¯: ${error.status} - ${error.message}`;

    console.error(errorMessage);
    return throwError(() => new Error(errorMessage));
  }
}
```

#### æŒ‡ä»¤å’Œç®¡é“ç¤ºä¾‹

```typescript
// 3. è‡ªå®šä¹‰æŒ‡ä»¤
@Directive({
  selector: '[appHighlight]'
})
export class HighlightDirective {
  @Input() appHighlight = '';
  @Input() defaultColor = 'yellow';

  constructor(private el: ElementRef) {}

  @HostListener('mouseenter') onMouseEnter() {
    this.highlight(this.appHighlight || this.defaultColor);
  }

  @HostListener('mouseleave') onMouseLeave() {
    this.highlight('');
  }

  private highlight(color: string) {
    this.el.nativeElement.style.backgroundColor = color;
  }
}

// 4. è‡ªå®šä¹‰ç®¡é“
@Pipe({
  name: 'truncate',
  pure: true
})
export class TruncatePipe implements PipeTransform {
  transform(value: string, limit: number = 50, trail: string = '...'): string {
    if (!value) return '';
    return value.length > limit ? value.substring(0, limit) + trail : value;
  }
}

// ä½¿ç”¨ï¼š<p>{{ longText | truncate:100:'...' }}</p>
```

### æ¨¡å—ç³»ç»Ÿ

#### æ¨¡å—ç±»å‹å¯¹æ¯”

| æ¨¡å—ç±»å‹ | ä½œç”¨ | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **ç‰¹æ€§æ¨¡å—** | ç»„ç»‡ç›¸å…³åŠŸèƒ½ | åŒ…å«ç»„ä»¶ã€æœåŠ¡ã€è·¯ç”± | ç”¨æˆ·ç®¡ç†ã€è®¢å•ç®¡ç† |
| **å…±äº«æ¨¡å—** | å…±äº«é€šç”¨ç»„ä»¶ | å¯¼å‡ºå¸¸ç”¨ç»„ä»¶å’ŒæŒ‡ä»¤ | UIç»„ä»¶åº“ã€å·¥å…·å‡½æ•° |
| **æ ¸å¿ƒæ¨¡å—** | å…¨å±€å•ä¾‹æœåŠ¡ | åªå¯¼å…¥ä¸€æ¬¡ | è®¤è¯ã€æ‹¦æˆªå™¨ |
| **æ‡’åŠ è½½æ¨¡å—** | æŒ‰éœ€åŠ è½½ | å‡å°‘åˆå§‹åŒ…å¤§å° | å¤§å‹åŠŸèƒ½æ¨¡å— |

#### æ¨¡å—ç¤ºä¾‹

```typescript
// 1. ç‰¹æ€§æ¨¡å—
@NgModule({
  declarations: [
    UserListComponent,
    UserCardComponent,
    UserFormComponent,
    TruncatePipe,
    HighlightDirective
  ],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterModule.forChild([
      { path: '', component: UserListComponent },
      { path: 'create', component: UserFormComponent },
      { path: ':id/edit', component: UserFormComponent }
    ])
  ],
  providers: [UserService],
  exports: [UserCardComponent, TruncatePipe]
})
export class UserModule {}

// 2. å…±äº«æ¨¡å—
@NgModule({
  declarations: [
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ],
  imports: [CommonModule, MaterialModule],
  exports: [
    CommonModule,
    MaterialModule,
    LoadingSpinnerComponent,
    ConfirmDialogComponent,
    ToastComponent
  ]
})
export class SharedModule {}

// 3. æ ¸å¿ƒæ¨¡å—ï¼ˆå•ä¾‹ï¼‰
@NgModule({
  providers: [
    AuthService,
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true },
    { provide: HTTP_INTERCEPTORS, useClass: ErrorInterceptor, multi: true }
  ]
})
export class CoreModule {
  constructor(@Optional() @SkipSelf() parentModule: CoreModule) {
    if (parentModule) {
      throw new Error('CoreModuleå·²ç»åŠ è½½ï¼Œåªèƒ½åœ¨AppModuleä¸­å¯¼å…¥ä¸€æ¬¡');
    }
  }
}
```

#### æ¨¡å—æœ€ä½³å®è·µ

- **ç‰¹æ€§æ¨¡å—**ï¼šæŒ‰ä¸šåŠ¡åŠŸèƒ½ç»„ç»‡ï¼ŒåŒ…å«ç›¸å…³çš„ç»„ä»¶ã€æœåŠ¡å’Œè·¯ç”±
- **å…±äº«æ¨¡å—**ï¼šå¯¼å‡ºé€šç”¨ç»„ä»¶å’Œç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œé¿å…é‡å¤å¯¼å…¥
- **æ ¸å¿ƒæ¨¡å—**ï¼šåŒ…å«å…¨å±€å•ä¾‹æœåŠ¡ï¼Œç¡®ä¿åªå¯¼å…¥ä¸€æ¬¡
- **æ‡’åŠ è½½**ï¼šå¤§å‹åŠŸèƒ½æ¨¡å—ä½¿ç”¨æ‡’åŠ è½½ï¼Œæå‡åº”ç”¨å¯åŠ¨æ€§èƒ½

## TypeScriptåœ¨Angularä¸­çš„åº”ç”¨

### é«˜çº§ç±»å‹ç³»ç»Ÿ

<Callout type="warning">
TypeScriptçš„å¼ºç±»å‹ç³»ç»Ÿæ˜¯Angularçš„æ ¸å¿ƒä¼˜åŠ¿ä¹‹ä¸€ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶å‘ç°é”™è¯¯ï¼Œæé«˜ä»£ç è´¨é‡ã€‚
</Callout>

#### TypeScriptç‰¹æ€§åœ¨Angularä¸­çš„åº”ç”¨

| ç‰¹æ€§ | ç”¨é€” | ä¼˜åŠ¿ | ç¤ºä¾‹ |
|------|------|------|------|
| **æ¥å£å®šä¹‰** | æ•°æ®ç»“æ„çº¦æŸ | ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ | `interface User` |
| **æ³›å‹** | ç±»å‹å‚æ•°åŒ– | ä»£ç å¤ç”¨ï¼Œç±»å‹å®‰å…¨ | `ApiResponse<T>` |
| **è”åˆç±»å‹** | å¤šç§å¯èƒ½ç±»å‹ | ç²¾ç¡®çš„ç±»å‹çº¦æŸ | `'admin' \| 'user'` |
| **æ˜ å°„ç±»å‹** | ç±»å‹è½¬æ¢ | åŸºäºç°æœ‰ç±»å‹ç”Ÿæˆæ–°ç±»å‹ | `Partial<T>` |
| **ç±»å‹å®ˆå«** | è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ | ç±»å‹å®‰å…¨çš„ç±»å‹ç¼©çª„ | `obj is User` |

#### åŸºç¡€ç±»å‹å®šä¹‰

```typescript
// 1. æ¥å£å’Œç±»å‹å®šä¹‰
export interface ApiResponse<T> {
  data: T;
  message: string;
  success: boolean;
  timestamp: number;
}

export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

export type UserRole = 'admin' | 'moderator' | 'user';
export type UserStatus = 'active' | 'inactive' | 'pending';

export interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
  status: UserStatus;
  createdAt: Date;
  updatedAt: Date;
  profile?: UserProfile;
}
```

#### æ³›å‹æœåŠ¡

```typescript
// 2. æ³›å‹APIæœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class ApiService {
  constructor(private http: HttpClient) {}

  get<T>(url: string): Observable<ApiResponse<T>> {
    return this.http.get<ApiResponse<T>>(url);
  }

  post<T, U = any>(url: string, data: U): Observable<ApiResponse<T>> {
    return this.http.post<ApiResponse<T>>(url, data);
  }

  getPaginated<T>(
    url: string,
    params: { page: number; limit: number }
  ): Observable<PaginatedResponse<T>> {
    const httpParams = new HttpParams()
      .set('page', params.page.toString())
      .set('limit', params.limit.toString());

    return this.http.get<PaginatedResponse<T>>(url, { params: httpParams });
  }
}
```

#### å®ç”¨ç±»å‹å’Œç±»å‹å®ˆå«

```typescript
// 3. å®ç”¨ç±»å‹ç¤ºä¾‹
export type CreateUserDto = Omit<User, 'id' | 'createdAt' | 'updatedAt'>;
export type UpdateUserDto = Partial<Pick<User, 'name' | 'email' | 'role' | 'status'>>;
export type UserSummary = Pick<User, 'id' | 'name' | 'email' | 'role'>;

// 4. ç±»å‹å®ˆå«
export function isUser(obj: any): obj is User {
  return obj &&
         typeof obj.id === 'string' &&
         typeof obj.name === 'string' &&
         typeof obj.email === 'string' &&
         ['admin', 'moderator', 'user'].includes(obj.role);
}

// 5. ä½¿ç”¨ç±»å‹å®ˆå«
@Component({
  selector: 'app-user-detail',
  template: `
    <div *ngIf="user">
      <h2>{{ user.name }}</h2>
      <p>{{ user.email }}</p>
    </div>
  `
})
export class UserDetailComponent {
  user: User | null = null;

  loadUser(data: unknown): void {
    if (isUser(data)) {
      this.user = data; // TypeScriptçŸ¥é“è¿™é‡Œdataæ˜¯Userç±»å‹
    } else {
      console.error('Invalid user data:', data);
    }
  }
}
```

#### TypeScriptæœ€ä½³å®è·µ

- **ä¸¥æ ¼æ¨¡å¼**ï¼šå¯ç”¨`strict: true`è·å¾—æœ€ä½³ç±»å‹æ£€æŸ¥
- **æ¥å£ä¼˜äºç±»å‹åˆ«å**ï¼šå¯¹äºå¯¹è±¡ç»“æ„ä½¿ç”¨interface
- **æ³›å‹çº¦æŸ**ï¼šä½¿ç”¨`extends`çº¦æŸæ³›å‹å‚æ•°
- **ç±»å‹å®ˆå«**ï¼šè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ç¡®ä¿ç±»å‹å®‰å…¨
- **å®ç”¨ç±»å‹**ï¼šå……åˆ†åˆ©ç”¨å†…ç½®å®ç”¨ç±»å‹ç®€åŒ–ç±»å‹å®šä¹‰

## ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

### é«˜çº§ä¾èµ–æ³¨å…¥

#### ä¾èµ–æ³¨å…¥æä¾›è€…ç±»å‹

| æä¾›è€…ç±»å‹ | è¯­æ³• | ç”¨é€” | ç¤ºä¾‹ |
|------------|------|------|------|
| **ç±»æä¾›è€…** | `useClass` | æä¾›ç±»å®ä¾‹ | `{ provide: Service, useClass: MockService }` |
| **å€¼æä¾›è€…** | `useValue` | æä¾›é™æ€å€¼ | `{ provide: CONFIG, useValue: config }` |
| **å·¥å‚æä¾›è€…** | `useFactory` | åŠ¨æ€åˆ›å»ºå®ä¾‹ | `{ provide: Logger, useFactory: createLogger }` |
| **åˆ«åæä¾›è€…** | `useExisting` | å¼•ç”¨ç°æœ‰æä¾›è€… | `{ provide: NewService, useExisting: OldService }` |

#### æ³¨å…¥ä»¤ç‰Œå’Œé…ç½®

```typescript
// 1. æ³¨å…¥ä»¤ç‰Œ
import { InjectionToken } from '@angular/core';

export const API_CONFIG = new InjectionToken<ApiConfig>('api.config');
export const FEATURE_FLAGS = new InjectionToken<FeatureFlags>('feature.flags');

export interface ApiConfig {
  baseUrl: string;
  timeout: number;
  retryAttempts: number;
}

export interface FeatureFlags {
  enableNewUI: boolean;
  enableAnalytics: boolean;
  enableBetaFeatures: boolean;
}

// 2. å·¥å‚æä¾›è€…
export function createApiService(http: HttpClient, config: ApiConfig): ApiService {
  return new ApiService(http, config);
}

export function createLogger(isDevelopment: boolean): Logger {
  return isDevelopment ? new ConsoleLogger() : new RemoteLogger();
}
```

#### æ¨¡å—é…ç½®ç¤ºä¾‹

```typescript
// 3. æ¨¡å—é…ç½®
@NgModule({
  providers: [
    {
      provide: API_CONFIG,
      useValue: {
        baseUrl: 'https://api.example.com',
        timeout: 5000,
        retryAttempts: 3
      }
    },
    {
      provide: FEATURE_FLAGS,
      useFactory: () => ({
        enableNewUI: environment.production,
        enableAnalytics: true,
        enableBetaFeatures: !environment.production
      })
    },
    {
      provide: ApiService,
      useFactory: createApiService,
      deps: [HttpClient, API_CONFIG]
    }
  ]
})
export class AppModule {}
```

#### æ³¨å…¥è£…é¥°å™¨

```typescript
// 4. æ³¨å…¥è£…é¥°å™¨ä½¿ç”¨
@Component({
  selector: 'app-user-list',
  providers: [
    { provide: UserService, useClass: CachedUserService }
  ]
})
export class UserListComponent {
  constructor(
    private userService: UserService, // ä½¿ç”¨CachedUserService
    @Inject(FEATURE_FLAGS) private featureFlags: FeatureFlags,
    @Optional() private analytics: AnalyticsService, // å¯é€‰ä¾èµ–
    @Self() private localService: LocalService // åªåœ¨å½“å‰æ³¨å…¥å™¨æŸ¥æ‰¾
  ) {}
}
```

#### ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

- **ä½¿ç”¨æ¥å£**ï¼šå®šä¹‰æœåŠ¡å¥‘çº¦ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢
- **æ³¨å…¥ä»¤ç‰Œ**ï¼šä¸ºéç±»ä¾èµ–æä¾›ç±»å‹å®‰å…¨çš„æ³¨å…¥
- **å·¥å‚å‡½æ•°**ï¼šå¤æ‚å¯¹è±¡åˆ›å»ºé€»è¾‘
- **å±‚çº§æ³¨å…¥**ï¼šåˆç†åˆ©ç”¨æ³¨å…¥å™¨å±‚çº§ï¼Œé¿å…ä¸å¿…è¦çš„å•ä¾‹
- **å¯é€‰ä¾èµ–**ï¼šä½¿ç”¨`@Optional()`å¤„ç†å¯é€‰æœåŠ¡

## RxJSå“åº”å¼ç¼–ç¨‹

### Observableæ¨¡å¼æ·±å…¥

<Callout type="info">
RxJSæ˜¯Angularçš„æ ¸å¿ƒä¾èµ–ï¼ŒæŒæ¡å“åº”å¼ç¼–ç¨‹å¯¹äºæ„å»ºé«˜è´¨é‡çš„Angularåº”ç”¨è‡³å…³é‡è¦ã€‚
</Callout>

#### å¸¸ç”¨RxJSæ“ä½œç¬¦

| æ“ä½œç¬¦ç±»å‹ | æ“ä½œç¬¦ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|------------|--------|------|----------|
| **åˆ›å»º** | `of`, `from`, `interval` | åˆ›å»ºObservable | æ•°æ®æºåˆ›å»º |
| **è½¬æ¢** | `map`, `switchMap`, `mergeMap` | æ•°æ®è½¬æ¢ | æ•°æ®å¤„ç†ã€APIè°ƒç”¨ |
| **è¿‡æ»¤** | `filter`, `debounceTime`, `distinctUntilChanged` | æ•°æ®è¿‡æ»¤ | æœç´¢ã€å»é‡ |
| **ç»„åˆ** | `combineLatest`, `merge`, `zip` | æµç»„åˆ | çŠ¶æ€ç®¡ç† |
| **é”™è¯¯å¤„ç†** | `catchError`, `retry`, `retryWhen` | é”™è¯¯å¤„ç† | å¼‚å¸¸æ¢å¤ |

#### æœç´¢æœåŠ¡ç¤ºä¾‹

```typescript
// 1. æœç´¢æœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class SearchService {
  private searchTerms = new Subject<string>();

  // æœç´¢ç»“æœæµ
  public searchResults$ = this.searchTerms.pipe(
    debounceTime(300),           // é˜²æŠ–
    distinctUntilChanged(),      // å»é‡
    filter(term => term.length >= 2), // è¿‡æ»¤çŸ­æŸ¥è¯¢
    switchMap(term =>
      this.apiService.search(term).pipe(
        catchError(error => {
          console.error('æœç´¢é”™è¯¯:', error);
          return of([]); // è¿”å›ç©ºæ•°ç»„ä½œä¸ºé»˜è®¤å€¼
        })
      )
    ),
    shareReplay(1)               // ç¼“å­˜æœ€æ–°ç»“æœ
  );

  search(term: string): void {
    this.searchTerms.next(term);
  }
}
```

#### çŠ¶æ€ç®¡ç†æœåŠ¡

```typescript
// 2. çŠ¶æ€ç®¡ç†æœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class UserStateService {
  private usersSubject = new BehaviorSubject<User[]>([]);
  private loadingSubject = new BehaviorSubject<boolean>(false);
  private errorSubject = new BehaviorSubject<string | null>(null);

  public users$ = this.usersSubject.asObservable();
  public loading$ = this.loadingSubject.asObservable();
  public error$ = this.errorSubject.asObservable();

  // ç»„åˆçŠ¶æ€
  public state$ = combineLatest([
    this.users$,
    this.loading$,
    this.error$
  ]).pipe(
    map(([users, loading, error]) => ({
      users,
      loading,
      error,
      hasUsers: users.length > 0,
      isEmpty: users.length === 0 && !loading && !error
    }))
  );

  loadUsers(): void {
    this.loadingSubject.next(true);
    this.errorSubject.next(null);

    this.userService.getUsers().pipe(
      finalize(() => this.loadingSubject.next(false))
    ).subscribe({
      next: users => this.usersSubject.next(users),
      error: error => this.errorSubject.next(error.message)
    });
  }
}
```

#### RxJSæœ€ä½³å®è·µ

- **å†…å­˜æ³„æ¼é˜²æŠ¤**ï¼šä½¿ç”¨`takeUntil`æˆ–`async`ç®¡é“è‡ªåŠ¨å–æ¶ˆè®¢é˜…
- **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨`catchError`å¤„ç†é”™è¯¯ï¼Œé¿å…æµä¸­æ–­
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨`shareReplay`ç¼“å­˜ç»“æœï¼Œé¿å…é‡å¤è¯·æ±‚
- **æ“ä½œç¬¦é€‰æ‹©**ï¼š`switchMap`ç”¨äºæœç´¢ï¼Œ`mergeMap`ç”¨äºå¹¶å‘è¯·æ±‚
- **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨`BehaviorSubject`ç®¡ç†ç»„ä»¶çŠ¶æ€

## Angularä¼ä¸šçº§å¼€å‘

### é«˜çº§RxJSæ¨¡å¼

```typescript
// 1. è‡ªå®šä¹‰æ“ä½œç¬¦
export function retryWithBackoff(maxRetries: number = 3, baseDelay: number = 1000) {
  return <T>(source: Observable<T>) => source.pipe(
    retryWhen(errors =>
      errors.pipe(
        scan((retryCount, error) => {
          if (retryCount >= maxRetries) {
            throw error;
          }
          return retryCount + 1;
        }, 0),
        delay(baseDelay),
        tap(retryCount => console.log(`é‡è¯•ç¬¬ ${retryCount} æ¬¡`))
      )
    )
  );
}

// 2. ç¼“å­˜æ“ä½œç¬¦
export function cacheWithExpiry<T>(ttl: number = 5000) {
  return (source: Observable<T>) => {
    let cache: { value: T; timestamp: number } | null = null;
    
    return new Observable<T>(observer => {
      if (cache && Date.now() - cache.timestamp < ttl) {
        observer.next(cache.value);
        observer.complete();
        return;
      }
      
      return source.subscribe({
        next: value => {
          cache = { value, timestamp: Date.now() };
          observer.next(value);
        },
        error: error => observer.error(error),
        complete: () => observer.complete()
      });
    });
  };
}

// ä½¿ç”¨è‡ªå®šä¹‰æ“ä½œç¬¦
@Injectable({
  providedIn: 'root'
})
export class DataService {
  getData(): Observable<any> {
    return this.http.get('/api/data').pipe(
      retryWithBackoff(3, 1000),
      cacheWithExpiry(10000),
      catchError(error => {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        return throwError(() => error);
      })
    );
  }
}

// 4. å“åº”å¼è¡¨å•
@Component({
  selector: 'app-user-form',
  template: `
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="name">å§“å</label>
        <input 
          id="name" 
          type="text" 
          formControlName="name"
          [class.invalid]="nameControl.invalid && nameControl.touched">
        <div *ngIf="nameControl.invalid && nameControl.touched" class="error">
          <span *ngIf="nameControl.errors?.['required']">å§“åæ˜¯å¿…å¡«é¡¹</span>
          <span *ngIf="nameControl.errors?.['minlength']">å§“åè‡³å°‘2ä¸ªå­—ç¬¦</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="email">é‚®ç®±</label>
        <input 
          id="email" 
          type="email" 
          formControlName="email"
          [class.invalid]="emailControl.invalid && emailControl.touched">
        <div *ngIf="emailControl.invalid && emailControl.touched" class="error">
          <span *ngIf="emailControl.errors?.['required']">é‚®ç®±æ˜¯å¿…å¡«é¡¹</span>
          <span *ngIf="emailControl.errors?.['email']">é‚®ç®±æ ¼å¼ä¸æ­£ç¡®</span>
          <span *ngIf="emailControl.errors?.['emailTaken']">é‚®ç®±å·²è¢«ä½¿ç”¨</span>
        </div>
      </div>
      
      <button type="submit" [disabled]="userForm.invalid || submitting">
        {{ submitting ? 'æäº¤ä¸­...' : 'æäº¤' }}
      </button>
    </form>
  `
})
export class UserFormComponent implements OnInit, OnDestroy {
  userForm!: FormGroup;
  submitting = false;
  private destroy$ = new Subject<void>();
  
  constructor(
    private fb: FormBuilder,
    private userService: UserService
  ) {}
  
  ngOnInit(): void {
    this.createForm();
    this.setupFormValidation();
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
  
  get nameControl() { return this.userForm.get('name')!; }
  get emailControl() { return this.userForm.get('email')!; }
  
  private createForm(): void {
    this.userForm = this.fb.group({
      name: ['', [Validators.required, Validators.minLength(2)]],
      email: ['', [Validators.required, Validators.email], [this.emailValidator.bind(this)]]
    });
  }
  
  private setupFormValidation(): void {
    // å®æ—¶éªŒè¯
    this.userForm.valueChanges.pipe(
      debounceTime(300),
      takeUntil(this.destroy$)
    ).subscribe(value => {
      console.log('è¡¨å•å€¼å˜åŒ–:', value);
    });
    
    // é‚®ç®±å­—æ®µå˜åŒ–æ—¶çš„ç‰¹æ®Šå¤„ç†
    this.emailControl.valueChanges.pipe(
      debounceTime(500),
      distinctUntilChanged(),
      takeUntil(this.destroy$)
    ).subscribe(email => {
      if (email && this.emailControl.valid) {
        console.log('é‚®ç®±éªŒè¯é€šè¿‡:', email);
      }
    });
  }
  
  private emailValidator(control: AbstractControl): Observable<ValidationErrors | null> {
    if (!control.value) {
      return of(null);
    }
    
    return this.userService.checkEmailExists(control.value).pipe(
      map(exists => exists ? { emailTaken: true } : null),
      catchError(() => of(null))
    );
  }
  
  onSubmit(): void {
    if (this.userForm.valid) {
      this.submitting = true;
      
      this.userService.createUser(this.userForm.value).pipe(
        finalize(() => this.submitting = false),
        takeUntil(this.destroy$)
      ).subscribe({
        next: user => {
          console.log('ç”¨æˆ·åˆ›å»ºæˆåŠŸ:', user);
          this.userForm.reset();
        },
        error: error => {
          console.error('ç”¨æˆ·åˆ›å»ºå¤±è´¥:', error);
        }
      });
    }
  }
}
```

### ä¼ä¸šçº§æ¶æ„æ¨¡å¼

```typescript
// 1. ç‰¹æ€§æ¨¡å—æ¶æ„
// shared/shared.module.ts
@NgModule({
  declarations: [
    LoadingComponent,
    ConfirmDialogComponent,
    DataTableComponent
  ],
  imports: [
    CommonModule,
    MaterialModule,
    ReactiveFormsModule
  ],
  exports: [
    LoadingComponent,
    ConfirmDialogComponent,
    DataTableComponent,
    MaterialModule,
    ReactiveFormsModule
  ]
})
export class SharedModule {}

// core/core.module.ts
@NgModule({
  providers: [
    AuthService,
    ErrorHandlerService,
    LoggerService,
    {
      provide: HTTP_INTERCEPTORS,
      useClass: AuthInterceptor,
      multi: true
    },
    {
      provide: HTTP_INTERCEPTORS,
      useClass: ErrorInterceptor,
      multi: true
    }
  ]
})
export class CoreModule {
  constructor(@Optional() @SkipSelf() parentModule: CoreModule) {
    if (parentModule) {
      throw new Error('CoreModuleå·²ç»åŠ è½½ï¼Œåªèƒ½åœ¨AppModuleä¸­å¯¼å…¥ä¸€æ¬¡');
    }
  }
}

// features/user/user.module.ts
@NgModule({
  declarations: [
    UserListComponent,
    UserDetailComponent,
    UserFormComponent
  ],
  imports: [
    CommonModule,
    SharedModule,
    UserRoutingModule
  ]
})
export class UserModule {}

// 2. çŠ¶æ€ç®¡ç†æ¶æ„
// store/user/user.state.ts
export interface UserState {
  users: User[];
  selectedUser: User | null;
  loading: boolean;
  error: string | null;
}

export const initialUserState: UserState = {
  users: [],
  selectedUser: null,
  loading: false,
  error: null
};

// store/user/user.actions.ts
export const UserActions = createActionGroup({
  source: 'User',
  events: {
    'Load Users': emptyProps(),
    'Load Users Success': props<{ users: User[] }>(),
    'Load Users Failure': props<{ error: string }>(),
    'Select User': props<{ userId: string }>(),
    'Create User': props<{ user: Partial<User> }>(),
    'Update User': props<{ user: User }>(),
    'Delete User': props<{ userId: string }>()
  }
});

// store/user/user.reducer.ts
export const userReducer = createReducer(
  initialUserState,
  on(UserActions.loadUsers, (state) => ({
    ...state,
    loading: true,
    error: null
  })),
  on(UserActions.loadUsersSuccess, (state, { users }) => ({
    ...state,
    users,
    loading: false
  })),
  on(UserActions.loadUsersFailure, (state, { error }) => ({
    ...state,
    loading: false,
    error
  })),
  on(UserActions.selectUser, (state, { userId }) => ({
    ...state,
    selectedUser: state.users.find(user => user.id === userId) || null
  }))
);

// store/user/user.effects.ts
@Injectable()
export class UserEffects {
  loadUsers$ = createEffect(() =>
    this.actions$.pipe(
      ofType(UserActions.loadUsers),
      switchMap(() =>
        this.userService.getUsers().pipe(
          map(users => UserActions.loadUsersSuccess({ users })),
          catchError(error => of(UserActions.loadUsersFailure({
            error: error.message
          })))
        )
      )
    )
  );

  createUser$ = createEffect(() =>
    this.actions$.pipe(
      ofType(UserActions.createUser),
      switchMap(({ user }) =>
        this.userService.createUser(user).pipe(
          map(() => UserActions.loadUsers()),
          catchError(error => of(UserActions.loadUsersFailure({
            error: error.message
          })))
        )
      )
    )
  );

  constructor(
    private actions$: Actions,
    private userService: UserService
  ) {}
}

// 3. ä¼ä¸šçº§è¡¨å•ç®¡ç†
@Injectable({
  providedIn: 'root'
})
export class FormBuilderService {
  createUserForm(): FormGroup {
    return this.fb.group({
      personalInfo: this.fb.group({
        firstName: ['', [Validators.required, Validators.minLength(2)]],
        lastName: ['', [Validators.required, Validators.minLength(2)]],
        email: ['', [Validators.required, Validators.email]],
        phone: ['', [Validators.pattern(/^\d{10,11}$/)]]
      }),
      address: this.fb.group({
        street: ['', Validators.required],
        city: ['', Validators.required],
        state: ['', Validators.required],
        zipCode: ['', [Validators.required, Validators.pattern(/^\d{5}$/)]]
      }),
      preferences: this.fb.group({
        newsletter: [false],
        notifications: [true],
        theme: ['light']
      })
    });
  }

  constructor(private fb: FormBuilder) {}
}

// 4. æƒé™ç®¡ç†ç³»ç»Ÿ
@Injectable({
  providedIn: 'root'
})
export class PermissionService {
  private permissions$ = new BehaviorSubject<string[]>([]);

  hasPermission(permission: string): Observable<boolean> {
    return this.permissions$.pipe(
      map(permissions => permissions.includes(permission))
    );
  }

  hasAnyPermission(permissions: string[]): Observable<boolean> {
    return this.permissions$.pipe(
      map(userPermissions =>
        permissions.some(permission => userPermissions.includes(permission))
      )
    );
  }

  setPermissions(permissions: string[]): void {
    this.permissions$.next(permissions);
  }
}

@Directive({
  selector: '[appHasPermission]'
})
export class HasPermissionDirective implements OnInit, OnDestroy {
  @Input() appHasPermission!: string;

  private destroy$ = new Subject<void>();

  constructor(
    private templateRef: TemplateRef<any>,
    private viewContainer: ViewContainerRef,
    private permissionService: PermissionService
  ) {}

  ngOnInit(): void {
    this.permissionService.hasPermission(this.appHasPermission).pipe(
      takeUntil(this.destroy$)
    ).subscribe(hasPermission => {
      if (hasPermission) {
        this.viewContainer.createEmbeddedView(this.templateRef);
      } else {
        this.viewContainer.clear();
      }
    });
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
}
```

## æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ

<Callout type="warning">
Angularåº”ç”¨çš„æ€§èƒ½ä¼˜åŒ–éœ€è¦ä»å¤šä¸ªç»´åº¦è€ƒè™‘ï¼ŒåŒ…æ‹¬å˜æ›´æ£€æµ‹ã€æ‡’åŠ è½½ã€é¢„åŠ è½½ç­–ç•¥ç­‰ã€‚
</Callout>

### å˜æ›´æ£€æµ‹ä¼˜åŒ–

```typescript
// 1. OnPushå˜æ›´æ£€æµ‹ç­–ç•¥
@Component({
  selector: 'app-user-card',
  template: `
    <div class="user-card">
      <h3>{{ user.name }}</h3>
      <p>{{ user.email }}</p>
      <button (click)="onEdit()">ç¼–è¾‘</button>
    </div>
  `,
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class UserCardComponent {
  @Input() user!: User;
  @Output() edit = new EventEmitter<User>();

  constructor(private cdr: ChangeDetectorRef) {}

  onEdit(): void {
    this.edit.emit(this.user);
  }

  // æ‰‹åŠ¨è§¦å‘å˜æ›´æ£€æµ‹
  updateUser(user: User): void {
    this.user = user;
    this.cdr.markForCheck();
  }
}

// 2. TrackByå‡½æ•°ä¼˜åŒ–
@Component({
  selector: 'app-user-list',
  template: `
    <div class="user-list">
      <app-user-card
        *ngFor="let user of users; trackBy: trackByUserId"
        [user]="user"
        (edit)="onEditUser($event)">
      </app-user-card>
    </div>
  `
})
export class UserListComponent {
  @Input() users: User[] = [];

  trackByUserId(index: number, user: User): string {
    return user.id;
  }

  onEditUser(user: User): void {
    // ç¼–è¾‘ç”¨æˆ·é€»è¾‘
  }
}

// 3. å¼‚æ­¥ç®¡é“ä¼˜åŒ–
@Component({
  selector: 'app-dashboard',
  template: `
    <div class="dashboard">
      <div *ngIf="users$ | async as users">
        <app-user-list [users]="users"></app-user-list>
      </div>

      <div *ngIf="loading$ | async" class="loading">
        åŠ è½½ä¸­...
      </div>
    </div>
  `
})
export class DashboardComponent {
  users$ = this.store.select(selectUsers);
  loading$ = this.store.select(selectUsersLoading);

  constructor(private store: Store) {}
}

// 4. è™šæ‹Ÿæ»šåŠ¨
@Component({
  selector: 'app-virtual-list',
  template: `
    <cdk-virtual-scroll-viewport itemSize="50" class="viewport">
      <div *cdkVirtualFor="let item of items; trackBy: trackByFn">
        {{ item.name }}
      </div>
    </cdk-virtual-scroll-viewport>
  `,
  styles: [`
    .viewport {
      height: 400px;
      width: 100%;
    }
  `]
})
export class VirtualListComponent {
  @Input() items: any[] = [];

  trackByFn(index: number, item: any): any {
    return item.id;
  }
}
```

### æ‡’åŠ è½½å’Œé¢„åŠ è½½ç­–ç•¥

```typescript
// 1. è·¯ç”±æ‡’åŠ è½½
const routes: Routes = [
  {
    path: 'users',
    loadChildren: () => import('./features/users/users.module').then(m => m.UsersModule)
  },
  {
    path: 'products',
    loadChildren: () => import('./features/products/products.module').then(m => m.ProductsModule)
  },
  {
    path: 'orders',
    loadChildren: () => import('./features/orders/orders.module').then(m => m.OrdersModule)
  }
];

// 2. è‡ªå®šä¹‰é¢„åŠ è½½ç­–ç•¥
@Injectable()
export class CustomPreloadingStrategy implements PreloadingStrategy {
  preload(route: Route, load: () => Observable<any>): Observable<any> {
    // åªé¢„åŠ è½½æ ‡è®°ä¸ºpreloadçš„è·¯ç”±
    if (route.data && route.data['preload']) {
      console.log('é¢„åŠ è½½è·¯ç”±:', route.path);
      return load();
    }
    return of(null);
  }
}

// è·¯ç”±é…ç½®
const routes: Routes = [
  {
    path: 'users',
    loadChildren: () => import('./features/users/users.module').then(m => m.UsersModule),
    data: { preload: true }
  },
  {
    path: 'admin',
    loadChildren: () => import('./features/admin/admin.module').then(m => m.AdminModule),
    data: { preload: false }
  }
];

@NgModule({
  imports: [RouterModule.forRoot(routes, {
    preloadingStrategy: CustomPreloadingStrategy
  })],
  providers: [CustomPreloadingStrategy]
})
export class AppRoutingModule {}

// 3. ç»„ä»¶æ‡’åŠ è½½
@Component({
  selector: 'app-lazy-component',
  template: `
    <div>
      <button (click)="loadComponent()" *ngIf="!componentLoaded">
        åŠ è½½ç»„ä»¶
      </button>
      <ng-container #dynamicComponent></ng-container>
    </div>
  `
})
export class LazyComponentComponent {
  @ViewChild('dynamicComponent', { read: ViewContainerRef })
  dynamicComponent!: ViewContainerRef;

  componentLoaded = false;

  constructor(private componentFactoryResolver: ComponentFactoryResolver) {}

  async loadComponent(): Promise<void> {
    const { HeavyComponent } = await import('./heavy/heavy.component');
    const componentFactory = this.componentFactoryResolver.resolveComponentFactory(HeavyComponent);
    this.dynamicComponent.createComponent(componentFactory);
    this.componentLoaded = true;
  }
}
```

### å†…å­˜ç®¡ç†å’Œæ€§èƒ½ç›‘æ§

```typescript
// 1. å†…å­˜æ³„æ¼é˜²æŠ¤
@Component({
  selector: 'app-memory-safe',
  template: `<div>{{ data$ | async }}</div>`
})
export class MemorySafeComponent implements OnInit, OnDestroy {
  data$!: Observable<any>;
  private destroy$ = new Subject<void>();

  ngOnInit(): void {
    // ä½¿ç”¨takeUntilé˜²æ­¢å†…å­˜æ³„æ¼
    this.data$ = this.dataService.getData().pipe(
      takeUntil(this.destroy$)
    );

    // å®šæ—¶å™¨ä¹Ÿéœ€è¦æ¸…ç†
    interval(1000).pipe(
      takeUntil(this.destroy$)
    ).subscribe(value => {
      console.log('å®šæ—¶å™¨å€¼:', value);
    });
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }
}

// 2. æ€§èƒ½ç›‘æ§æœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class PerformanceMonitorService {
  private performanceObserver?: PerformanceObserver;

  startMonitoring(): void {
    if ('PerformanceObserver' in window) {
      this.performanceObserver = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          if (entry.entryType === 'navigation') {
            this.logNavigationTiming(entry as PerformanceNavigationTiming);
          } else if (entry.entryType === 'paint') {
            this.logPaintTiming(entry);
          }
        });
      });

      this.performanceObserver.observe({
        entryTypes: ['navigation', 'paint', 'largest-contentful-paint']
      });
    }
  }

  private logNavigationTiming(entry: PerformanceNavigationTiming): void {
    console.log('å¯¼èˆªæ€§èƒ½æŒ‡æ ‡:', {
      domContentLoaded: entry.domContentLoadedEventEnd - entry.domContentLoadedEventStart,
      loadComplete: entry.loadEventEnd - entry.loadEventStart,
      firstByte: entry.responseStart - entry.requestStart
    });
  }

  private logPaintTiming(entry: PerformanceEntry): void {
    console.log(`${entry.name}: ${entry.startTime}ms`);
  }

  stopMonitoring(): void {
    if (this.performanceObserver) {
      this.performanceObserver.disconnect();
    }
  }
}

// 3. Bundleåˆ†æå’Œä¼˜åŒ–
// angular.jsoné…ç½®
{
  "build": {
    "builder": "@angular-devkit/build-angular:browser",
    "options": {
      "budgets": [
        {
          "type": "initial",
          "maximumWarning": "2mb",
          "maximumError": "5mb"
        },
        {
          "type": "anyComponentStyle",
          "maximumWarning": "6kb",
          "maximumError": "10kb"
        }
      ]
    }
  }
}
```

---

<Callout type="success">
Angularæä¾›äº†å®Œæ•´çš„ä¼ä¸šçº§å¼€å‘è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡TypeScriptã€ä¾èµ–æ³¨å…¥å’ŒRxJSçš„å¼ºå¤§ç»„åˆï¼Œèƒ½å¤Ÿæ„å»ºå¤§å‹ã€å¯ç»´æŠ¤çš„å‰ç«¯åº”ç”¨ã€‚
</Callout>

---

## ğŸ“š å‚è€ƒå­¦ä¹ èµ„æ–™

### ğŸ“– å®˜æ–¹æ–‡æ¡£
- [Angular å®˜æ–¹æ–‡æ¡£](https://angular.io/) - Angularæƒå¨å­¦ä¹ èµ„æº
- [Angular API å‚è€ƒ](https://angular.io/api) - å®Œæ•´APIæ–‡æ¡£
- [TypeScript å®˜æ–¹æ–‡æ¡£](https://www.typescriptlang.org/) - TypeScriptè¯­è¨€æ–‡æ¡£
- [RxJS å®˜æ–¹æ–‡æ¡£](https://rxjs.dev/) - å“åº”å¼ç¼–ç¨‹åº“æ–‡æ¡£

### ğŸ“ ä¼˜è´¨æ•™ç¨‹
- [Angular å®˜æ–¹æ•™ç¨‹](https://angular.io/tutorial) - å®˜æ–¹è‹±é›„ä¹‹æ—…æ•™ç¨‹
- [Angular University](https://angular-university.io/) - Angularä¸“ä¸šè¯¾ç¨‹å¹³å°
- [Angular in Depth](https://indepth.dev/angular) - Angularæ·±åº¦æŠ€æœ¯æ–‡ç« 

### ğŸ› ï¸ å®è·µé¡¹ç›®
- [Angular CLI](https://angular.io/cli) - å®˜æ–¹è„šæ‰‹æ¶å·¥å…·
- [Angular Material](https://material.angular.io/) - å®˜æ–¹UIç»„ä»¶åº“
- [NgRx](https://ngrx.io/) - AngularçŠ¶æ€ç®¡ç†åº“

### ğŸ”§ å¼€å‘å·¥å…·
- [Angular DevTools](https://angular.io/guide/devtools) - å®˜æ–¹è°ƒè¯•å·¥å…·
- [Angular Language Service](https://angular.io/guide/language-service) - VS Codeæ‰©å±•
- [Nx](https://nx.dev/) - ä¼ä¸šçº§å¼€å‘å·¥å…·
- [Compodoc](https://compodoc.app/) - æ–‡æ¡£ç”Ÿæˆå·¥å…·

### ğŸ“ æ·±å…¥é˜…è¯»
- [Angular Architecture](https://angular.io/guide/architecture) - æ¶æ„æŒ‡å—
- [Angular Performance](https://angular.io/guide/performance-checklist) - æ€§èƒ½ä¼˜åŒ–æ¸…å•
- [Angular Security](https://angular.io/guide/security) - å®‰å…¨æœ€ä½³å®è·µ

<Callout type="tip">
ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šå»ºè®®ä»Angular CLIå¼€å§‹åˆ›å»ºé¡¹ç›®ï¼Œå­¦ä¹ ç»„ä»¶å’ŒæœåŠ¡çš„åŸºæœ¬æ¦‚å¿µï¼Œç„¶åæ·±å…¥TypeScriptå’ŒRxJSï¼Œæœ€åæŒæ¡ä¼ä¸šçº§å¼€å‘æ¨¡å¼ã€‚
</Callout>
